<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Root</title>
  <link rel="icon" type="image/png" href="images/summer.png" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
  <script>
    (function(){
      try {
        if (sessionStorage.getItem('root_intro_seen')) {
          document.documentElement.classList.add('intro-seen');
        }
      } catch (_) {}
    })();
  </script>

  <style>
    :root{
      /* =========================
         INTRO (keep the same)
         ========================= */
      --bg:#1E2320;
      --text:#EDEBE6;

      /* =========================
         APP THEME (reference style)
         ========================= */
      --app-bg: #231815;
      --app-ink:#efe4d3;
      --app-muted: rgba(232,210,184,0.75);
      --app-muted-2: rgba(232,210,184,0.55);

      --gold-3:#e1c28a;
      --bronze-1:#a77a4d;
      --bronze-2:#7b5637;

      --shadow: 0 14px 36px rgba(0,0,0,0.55);
      --radius: 18px;
      --radius-sm: 14px;
      --max: 1040px;
    }

    *{ box-sizing:border-box; }
    html,body{ min-height:100%; }
    html{
      background-color: #1a130f;
      background:
        radial-gradient(900px 700px at 30% 10%, rgba(146,106,70,0.20), transparent 60%),
        radial-gradient(900px 700px at 90% 40%, rgba(98,69,46,0.18), transparent 60%),
        radial-gradient(1100px 900px at 50% 120%, rgba(0,0,0,0.55), transparent 55%),
        linear-gradient(180deg, #1a130f, var(--app-bg));
      background-attachment: fixed;
    }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--app-ink);
      line-height: 1.35;
      overflow-y: auto;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge legacy */
      background-color: #1a130f;
      background: transparent;
    }
    body::-webkit-scrollbar{ width:0; height:0; }

    .legalBanner{
      position: relative;
      padding-right: 34px;
    }
    .legalDismiss{
      position: absolute;
      top: 6px;
      right: 8px;
      width: 18px;
      height: 18px;
      border: 1px solid rgba(167,122,77,0.45);
      border-radius: 999px;
      background: rgba(24,16,12,0.88);
      color: rgba(232,210,184,0.9);
      font-size: 12px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }
    .legalDismiss:hover,
    .legalDismiss:focus-visible{
      border-color: rgba(225,194,138,0.78);
      color: rgba(245,227,198,0.98);
      background: rgba(40,26,18,0.92);
    }
    .legalBanner.isDismissed{
      display: none;
    }

    a{ color:inherit; text-decoration:none; }
    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 0 18px 56px;
    }
    .headerStack{
      position: sticky;
      top: 16px;
      z-index: 20;
    }
    .legalBanner{
      margin-top: 0;
      margin-bottom: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.72);
      color: rgba(232,210,184,0.86);
      font-size: 12px;
      line-height: 1.4;
      text-align: center;
    }
    .legalBanner a{
      color: var(--gold-3);
      font-weight: 700;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .deployBanner{
      margin-bottom: 8px;
      padding: 8px 12px 10px;
      border-radius: 10px;
      border: 1px solid rgba(90,155,110,0.45);
      background: linear-gradient(180deg, rgba(18,40,24,0.78), rgba(11,28,17,0.86));
      box-shadow: inset 0 1px 0 rgba(184,236,198,0.09);
    }
    .deployHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 12px;
      line-height: 1.2;
    }
    .deployTitle{
      color: rgba(198,238,208,0.95);
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    .deployState{
      color: rgba(160,229,180,0.9);
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .deployTrack{
      position: relative;
      height: 8px;
      border-radius: 999px;
      border: 1px solid rgba(140,208,158,0.5);
      background: rgba(8,18,12,0.72);
      overflow: visible;
    }
    .deployFill{
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width: 10%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(111,224,146,0.88), rgba(56,174,105,0.92));
      box-shadow: 0 0 10px rgba(94,210,130,0.45);
    }
    .deployMark{
      position:absolute;
      left: 70%;
      top: -3px;
      bottom: -3px;
      width: 2px;
      background: rgba(195,247,210,0.96);
      box-shadow: 0 0 8px rgba(126,232,162,0.6);
    }
    .deployMarkLabel{
      position: absolute;
      left: 70%;
      bottom: calc(100% + 2px);
      transform: translateX(-50%);
      font-size: 10px;
      font-weight: 700;
      color: rgba(190,244,206,0.95);
      letter-spacing: 0.2px;
      white-space: nowrap;
      line-height: 1;
    }

    /* =========================
       INTRO (unchanged)
       ========================= */
    .intro{
      position: fixed;
      inset: 0;
      background: var(--bg);
      color: var(--text);
      display: grid;
      place-items: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 1800ms ease, visibility 0ms linear 1800ms;
      visibility: visible;
    }
    .intro.hide{ opacity:0; visibility:hidden; }
    .intro-seen .intro{ display:none !important; }

    .introStage{
      width: min(920px, 92vw);
      display: grid;
      place-items: center;
      row-gap: 14px;
      text-align: center;
    }
    .jp{
      font-family: "Hiragino Mincho ProN","Yu Mincho","Noto Serif JP","MS Mincho",serif;
      letter-spacing: 0.02em;
    }
    .introTree{
      width: clamp(120px, 18vw, 190px);
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 1800ms ease, transform 1800ms ease;
      filter: drop-shadow(0 14px 26px rgba(0,0,0,0.45));
      user-select: none;
      -webkit-user-drag: none;
    }
    .introLine1{
      font-size: clamp(28px, 4vw, 56px);
      font-weight: 600;
      margin: 0;
      opacity: 0;
      transition: opacity 1800ms ease;
      text-shadow: 0 10px 28px rgba(0,0,0,0.45);
    }
    .introLine2{
      font-size: clamp(16px, 2.1vw, 22px);
      font-weight: 500;
      margin: 0;
      opacity: 0;
      transition: opacity 1800ms ease;
      color: rgba(237,235,230,0.85);
      text-shadow: 0 10px 28px rgba(0,0,0,0.45);
    }
    .show{ opacity:1 !important; }
    .showTree{ opacity:1 !important; transform: translateY(0) !important; }

    @media (prefers-reduced-motion: reduce){
      .intro, .introTree, .introLine1, .introLine2{ transition:none !important; }
    }

    /* =========================
       Top Bar
       ========================= */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-top: 0;
      margin-bottom: 36px;
      padding: 0 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(167,122,77,0.35);
      background:
        linear-gradient(180deg, rgba(109,78,49,0.25), rgba(14,9,7,0.65)),
        radial-gradient(900px 240px at 40% 0%, rgba(167,122,77,0.22), transparent 60%),
        rgba(18,12,9,0.55);
      box-shadow: var(--shadow);
      position: relative;
      top: 0;
      z-index: 1;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .left{
      display:flex;
      align-items:center;
      gap:16px;
      min-width: 220px;
    }

    .userBadge{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 2px 8px 2px 2px;
      border-radius: 999px;
    }

    .avatar{
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display:grid;
      place-items:center;
      background:
        radial-gradient(60% 60% at 40% 35%, rgba(231,210,170,0.18), transparent 70%),
        linear-gradient(160deg, rgba(36,29,26,0.9), rgba(10,7,6,0.9));
      border: 1px solid rgba(239,230,214,0.2);
    }

    .avatar svg{
      width: 22px;
      height: 22px;
      opacity: 0.85;
      fill: var(--app-ink);
    }

    .userMeta{
      display:flex;
      flex-direction:column;
      line-height: 1.1;
    }

    .userName{
      font-size: 14px;
      font-weight: 700;
      color: var(--gold-3);
      letter-spacing: 0.2px;
    }

    .userAddr{
      font-size: 12px;
      color: var(--app-muted);
      font-variant-numeric: tabular-nums;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:14px;
    }

    /* Bigger icon, NO square around it */
    .logo{
      width: 108px;
      height: 108px;
      object-fit: contain;
      border: none;
      border-radius: 0;
      background: transparent;
      box-shadow: none;
      filter: drop-shadow(0 12px 20px rgba(0,0,0,0.45));
      -webkit-user-drag: none;
      user-select:none;
    }

    .brandTitle h1{
      margin:0;
      font-family: "Georgia", "Times New Roman", serif;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 30px;
      color: var(--gold-3);
      text-shadow: 0 10px 26px rgba(0,0,0,0.55);
      line-height: 1;
      white-space: normal;
    }

    .right{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .profileMenu{
      position: relative;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .profileNotify{
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 1px solid rgba(225,194,138,0.75);
      background: rgba(148,39,39,0.95);
      color: #fbe9c6;
      display:grid;
      place-items:center;
      box-shadow: 0 8px 16px rgba(0,0,0,0.45);
      z-index: 24;
      pointer-events: auto;
      cursor: help;
    }
    .profileNotify svg{
      width: 11px;
      height: 11px;
      fill: currentColor;
    }
    .profileNotifyTip{
      position: absolute;
      right: 0;
      bottom: calc(100% + 8px);
      display: none;
      min-width: 190px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(18,12,9,0.96);
      color: rgba(232,210,184,0.92);
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 10px 20px rgba(0,0,0,0.45);
      z-index: 26;
      pointer-events: none;
    }
    .profileNotify:hover + .profileNotifyTip,
    .profileNotify:focus-visible + .profileNotifyTip{
      display:block;
    }

    .profileBtn{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 4px;
      border-radius: 999px;
      border: 1px solid rgba(239,230,214,0.14);
      background: rgba(10,7,6,0.45);
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      cursor: pointer;
      transition: 160ms ease;
    }

    .profileBtn:hover,
    .profileBtn:focus-visible{
      border-color: rgba(231,210,170,0.45);
      background: rgba(18,12,10,0.7);
      box-shadow: 0 12px 28px rgba(0,0,0,0.45);
      transform: translateY(-1px);
    }

    .profilePanel{
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      min-width: 220px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(239,230,214,0.14);
      background: rgba(10,7,6,0.75);
      box-shadow: 0 14px 28px rgba(0,0,0,0.45);
      display:none;
      z-index: 20;
    }

    .profileBtn:hover ~ .profilePanel,
    .profileBtn:focus-visible ~ .profilePanel,
    .profilePanel:hover,
    .profileMenu:focus-within .profilePanel{
      display:block;
    }

    .profilePanel .pill{
      background: transparent;
      border: none;
      padding: 6px 0;
      border-radius: 0;
      box-shadow: none;
    }

    .tabs{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.55);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.04),
        inset 0 -1px 0 rgba(0,0,0,0.6);
    }
    .tab{
      position: relative;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: rgba(232,210,184,0.8);
      font-family: "Georgia","Times New Roman",serif;
      font-weight: 650;
      letter-spacing: 0.2px;
      cursor: pointer;
      user-select: none;
      transition: 140ms ease;
    }
    .tab:hover{
      color: var(--gold-3);
      background: rgba(86,60,38,0.45);
      border-color: rgba(193,143,95,0.45);
    }
    .tab.active{
      color: var(--gold-3);
      background: rgba(104,73,45,0.65);
      border-color: rgba(209,164,110,0.6);
    }
    .tab.active::after{
      content:"";
      position:absolute;
      left: 14px;
      right: 14px;
      bottom: -8px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(225,194,138,0.95), transparent);
      box-shadow: 0 0 16px rgba(225,194,138,0.55);
      border-radius: 999px;
    }

    .profile{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(203,180,138,0.22);
      background: rgba(0,0,0,0.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
      white-space: nowrap;
    }
    .profile .pill{
      white-space: nowrap;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(203,180,138,0.18);
      background: rgba(203,180,138,0.08);
      font-size: 12px;
      color: rgba(239,230,214,0.78);
      font-family: ui-sans-serif, system-ui;
    }
    .profile .value{
      font-size: 13px;
      font-weight: 800;
      color: var(--gold-3);
      margin-left: 6px;
      letter-spacing: 0.2px;
    }

    /* =========================
       Sub-tabs header inside pages
       ========================= */
    .page{ margin-top: 18px; display:none; }
    .page.active{ display:block; }

    .subTabs{
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(239,230,214,0.12);
      background:
        linear-gradient(180deg, rgba(231,210,170,0.08), rgba(0,0,0,0.20)),
        rgba(0,0,0,0.16);
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .subTabRow{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .subTab{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: rgba(239,230,214,0.72);
      font-family: "Georgia","Times New Roman",serif;
      font-weight: 650;
      letter-spacing: 0.2px;
      cursor: pointer;
      position: relative;
      transition: 140ms ease;
      user-select:none;
    }
    .subTab:hover{
      background: rgba(203,180,138,0.08);
      border-color: rgba(203,180,138,0.18);
      color: var(--gold-3);
    }
    .subTab.active{
      color: var(--gold-3);
      background: rgba(203,180,138,0.10);
      border-color: rgba(203,180,138,0.24);
    }
    .subTab.active::after{
      content:"";
      position:absolute;
      left: 14px;
      right: 14px;
      bottom: -8px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(231,210,170,0.95), transparent);
      box-shadow: 0 0 16px rgba(231,210,170,0.55);
      border-radius: 999px;
    }

    .filterBtn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(203,180,138,0.22);
      background: rgba(0,0,0,0.20);
      color: rgba(239,230,214,0.85);
      font-family: ui-sans-serif, system-ui;
      font-weight: 650;
      cursor: pointer;
      transition: 140ms ease;
      white-space: nowrap;
    }
    .filterBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(231,210,170,0.28);
      background: rgba(203,180,138,0.08);
    }

    /* Controls (search) */
    .controls{
      margin-top: 14px;
      display:flex;
      gap: 12px;
      align-items:center;
      flex-wrap: wrap;
    }
    .search{
      flex: 1 1 520px;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(203,180,138,0.22);
      background: rgba(0,0,0,0.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .search svg{ flex: 0 0 auto; opacity: 0.9; color: rgba(239,230,214,0.75); }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background: transparent;
      color: var(--app-ink);
      font-size: 15px;
    }
    .tinyPill{
      flex: 0 0 auto;
      padding: 10px 12px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.55);
      border-radius: 999px;
      color: rgba(232,210,184,0.78);
      font-size: 13px;
      white-space: nowrap;
    }
    .sortControl{
      flex: 0 0 auto;
      min-width: 220px;
      padding: 10px 34px 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.55);
      color: rgba(232,210,184,0.9);
      font-size: 13px;
      font-family: ui-sans-serif, system-ui;
      font-weight: 650;
      outline: none;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23e1c28a' stroke-width='1.8' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 20px center;
    }

    /* Cards (reference layout) */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    .card{
      display:grid;
      grid-template-columns: 260px 1fr 160px;
      gap: 16px;
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(167,122,77,0.35);
      background:
        linear-gradient(180deg, rgba(120,86,56,0.22), rgba(10,7,5,0.55)),
        rgba(20,13,10,0.55);
      box-shadow: 0 18px 40px rgba(0,0,0,0.50);
      position: relative;
      overflow: visible;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(700px 220px at 15% 0%, rgba(171,125,79,0.22), transparent 55%);
      pointer-events:none;
    }

    .thumbWrap{
      border-radius: var(--radius-sm);
      border: 1px solid rgba(203,180,138,0.22);
      overflow:hidden;
      background: rgba(0,0,0,0.25);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .thumb{
      width:100%;
      height: 150px;
      object-fit: cover;
      display:block;
      filter: saturate(0.95) contrast(1.05);
    }

    .cardMain{
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 8px;
      position: relative;
      z-index: 1;
    }
    .title{
      margin:0;
      font-family: "Georgia","Times New Roman",serif;
      font-size: 30px;
      font-weight: 700;
      color: var(--gold-3);
      letter-spacing: 0.2px;
      text-shadow: 0 14px 30px rgba(0,0,0,0.55);
      line-height: 1.05;
    }
    .rev{
      font-family: ui-sans-serif, system-ui;
      font-weight: 800;
      font-size: 18px;
      color: rgba(239,230,214,0.92);
    }
    .rev .unit{
      font-weight: 700;
      color: rgba(239,230,214,0.65);
      font-size: 14px;
      margin-left: 6px;
    }

    .rowStats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 14px;
      margin-top: 6px;
      padding-top: 10px;
      border-top: 1px solid rgba(203,180,138,0.18);
      color: rgba(239,230,214,0.78);
      font-size: 13px;
    }
    .rowStats .k{ color: rgba(239,230,214,0.62); margin-right: 10px; }
    .rowStats .v{ color: rgba(239,230,214,0.92); font-weight: 750; letter-spacing: 0.2px; }

    .cardAction{
      display:flex;
      align-items:center;
      justify-content:center;
      position: relative;
      z-index: 1;
    }
    .viewBtn{
      width: 140px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(203,180,138,0.35);
      background: linear-gradient(180deg, rgba(239,230,214,0.78), rgba(203,180,138,0.70));
      color: #2a1d16;
      font-family: "Georgia","Times New Roman",serif;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 14px 28px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.5);
      transition: 140ms ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
    }
    .viewBtn:hover{ transform: translateY(-1px); }
    .cloneBtnUnavailable{
      position: relative;
      background: transparent;
      color: rgba(232,210,184,0.9);
      border: 1px solid rgba(203,180,138,0.45);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
      cursor: not-allowed;
    }
    .cloneBtnUnavailable:hover{
      transform: none;
      background: rgba(20,13,10,0.45);
      border-color: rgba(231,210,170,0.6);
    }
    .cloneBtnUnavailable:hover::after{
      content: attr(data-tip);
      position: absolute;
      left: 50%;
      bottom: calc(100% + 8px);
      transform: translateX(-50%);
      min-width: 260px;
      max-width: min(320px, calc(100vw - 40px));
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(18,12,9,0.95);
      color: rgba(232,210,184,0.92);
      font-size: 12px;
      font-weight: 600;
      font-family: ui-sans-serif, system-ui;
      line-height: 1.35;
      text-align: center;
      white-space: normal;
      box-shadow: 0 10px 20px rgba(0,0,0,0.45);
      z-index: 25;
      pointer-events: none;
    }

    /* Map panel */
    .mapPanel{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(167,122,77,0.35);
      overflow: hidden;
      background: rgba(20,13,10,0.6);
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
    }
    .mapHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      background: linear-gradient(180deg, rgba(120,86,56,0.24), rgba(10,7,5,0.55));
      border-bottom: 1px solid rgba(167,122,77,0.28);
      color: rgba(232,210,184,0.8);
      font-size: 13px;
    }
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(24,16,12,0.6);
      color: var(--gold-3);
      font-weight: 800;
      font-size: 12px;
      font-family: ui-sans-serif, system-ui;
      letter-spacing: 0.2px;
    }
    .mapFrame,
    #map{
      width: 100%;
      height: min(520px, 65vh);
      border: 0;
      display: block;
      filter: saturate(0.95) contrast(1.05);
    }
    .leaflet-container{
      background: #14100d;
    }

    /* Manage: single business page */
    .businessPage{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(167,122,77,0.35);
      background: linear-gradient(180deg, rgba(120,86,56,0.22), rgba(10,7,5,0.55)), rgba(20,13,10,0.55);
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
      overflow:hidden;
    }
    .businessHero{
      display:grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 14px;
      padding: 14px;
      border-bottom: 1px solid rgba(167,122,77,0.28);
    }
    .heroImg{
      border-radius: var(--radius-sm);
      border: 1px solid rgba(167,122,77,0.35);
      overflow:hidden;
      background: rgba(18,12,9,0.6);
      aspect-ratio: 4 / 3;
    }
    .heroImg img{
      width:100%;
      height: 100%;
      object-fit: cover;
      object-position: center 20%;
      display:block;
      filter: none;
    }
    .heroInfo{
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 10px;
      padding: 4px 2px;
    }
    .heroInfo h2{
      margin:0;
      font-family: "Georgia","Times New Roman",serif;
      font-size: 42px;
      color: var(--gold-3);
      text-shadow: 0 16px 34px rgba(0,0,0,0.55);
      line-height: 1.05;
    }
    .heroMeta{
      color: rgba(232,210,184,0.8);
      font-size: 14px;
    }
    .heroBadges{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 2px;
    }
    .teamList{
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px 10px;
    }
    .teamTitle{
      margin-top: 12px;
      font-size: 12px;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      color: rgba(232,210,184,0.65);
      font-weight: 700;
    }
    .branches{
      margin-top: 14px;
      margin-left: 14px;
      margin-right: 14px;
      padding: 14px 24px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(203,180,138,0.18);
      background: rgba(0,0,0,0.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .branchesTitle{
      margin: 0 0 10px;
      font-size: 12px;
      color: rgba(232,210,184,0.7);
      text-transform: uppercase;
      letter-spacing: 0.4px;
      font-weight: 700;
    }
    .branchList{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      padding: 0;
    }
    .branchItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.22);
      background: rgba(18,12,9,0.55);
      color: rgba(232,210,184,0.85);
      font-size: 12px;
      font-variant-numeric: tabular-nums;
      position: relative;
      overflow: hidden;
    }
    .branchLeft{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
      overflow: hidden;
    }
    .storeIcon{
      width: 18px;
      height: 18px;
      border-radius: 6px;
      display:grid;
      place-items:center;
      background: rgba(18,12,9,0.7);
      border: 1px solid rgba(231,210,170,0.35);
      flex: 0 0 auto;
    }
    .storeIcon svg{
      width: 12px;
      height: 12px;
      fill: var(--gold-3);
      opacity: 0.85;
    }
    .branchAddr{
      white-space: nowrap;
    }
    .branchRoyalty{
      color: var(--gold-3);
      font-weight: 700;
      min-width: 44px;
      text-align: right;
    }
    .branchActions{
      display:flex;
      align-items:center;
      position: relative;
      z-index: 2;
      flex: 0 0 auto;
    }
    .forceForkBtn{
      position: absolute;
      inset: 0;
      border-radius: 10px;
      border: 1px solid rgba(219,98,98,0.85);
      background: linear-gradient(180deg, rgba(188,51,51,0.62), rgba(115,28,28,0.68));
      color: #ffe8e1;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: 0.2px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transform: translateY(6px);
      transition: 140ms ease;
      white-space: nowrap;
      z-index: 4;
      box-shadow: 0 10px 18px rgba(0,0,0,0.45);
    }
    .forceForkBtn:hover,
    .forceForkBtn:focus-visible{
      border-color: rgba(255,210,210,0.98);
      background: linear-gradient(180deg, rgba(214,69,69,0.78), rgba(138,34,34,0.84));
      color: #fff8f4;
    }
    .branchItem:hover .forceForkBtn,
    .branchItem:focus-within .forceForkBtn{
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    .forceForkBtn.forced{
      border-color: rgba(255,188,188,0.92);
      background: linear-gradient(180deg, rgba(206,74,74,0.72), rgba(122,31,31,0.78));
      color: #fff3ef;
    }
    .branchItem.forkPending .forceForkBtn{
      display: none;
      opacity: 0;
      pointer-events: none;
    }
    .forkTimerBtn{
      position: absolute;
      top: 4px;
      right: 6px;
      z-index: 5;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(231,210,170,0.38);
      background: rgba(10,7,6,0.82);
      color: rgba(245,228,198,0.95);
      font-size: 10px;
      font-weight: 700;
      line-height: 1;
      cursor: pointer;
      white-space: nowrap;
      backdrop-filter: blur(2px);
    }
    .forkTimerBtn:hover,
    .forkTimerBtn:focus-visible{
      border-color: rgba(255,215,198,0.92);
      background: rgba(34,12,10,0.92);
      color: rgba(255,235,210,0.98);
    }
    .forkTimerBtn:hover .forkTimerText,
    .forkTimerBtn:focus-visible .forkTimerText{
      display: none;
    }
    .forkTimerBtn:hover::after,
    .forkTimerBtn:focus-visible::after{
      content: "Revert";
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .forkTimerIcon{
      width: 10px;
      height: 10px;
      display: inline-block;
      opacity: 0.9;
      flex: 0 0 auto;
    }
    .forkTimerIcon svg{
      width: 10px;
      height: 10px;
      fill: currentColor;
      display: block;
    }
    .branchRequests{
      margin-top: 12px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.28);
      background: rgba(18,12,9,0.55);
      position: relative;
      z-index: 3;
    }
    .branchReqHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      color: rgba(232,210,184,0.9);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .branchReqCount{
      min-width: 44px;
      height: 24px;
      padding: 0 9px;
      border-radius: 999px;
      border: 1px solid rgba(245,206,143,0.75);
      background: radial-gradient(circle at 30% 30%, rgba(250,126,126,0.95), rgba(146,30,30,0.95));
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 5px;
      color: #fff1d5;
      font-size: 12px;
      font-weight: 900;
      box-shadow: 0 0 0 2px rgba(18,12,9,0.5), 0 8px 16px rgba(0,0,0,0.45);
    }
    .branchReqCount.isZero{
      border-color: rgba(167,122,77,0.45);
      background: rgba(34,23,17,0.85);
      color: rgba(232,210,184,0.82);
      box-shadow: 0 0 0 1px rgba(18,12,9,0.35);
    }
    .branchReqCount svg{
      width: 10px;
      height: 10px;
      fill: currentColor;
      opacity: 0.95;
    }
    .branchReqRule{
      margin: 8px 0 0;
      color: rgba(232,210,184,0.75);
      font-size: 12px;
    }
    .branchReqList{
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 0;
      display:none;
      gap: 6px;
      flex-direction: column;
      z-index: 35;
      pointer-events: auto;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.34);
      background: rgba(14,9,7,0.96);
      box-shadow: 0 12px 24px rgba(0,0,0,0.5);
    }
    .branchRequests:hover .branchReqList,
    .branchReqList:hover{
      display:flex;
    }
    .branchReqItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid rgba(167,122,77,0.24);
      background: rgba(20,13,10,0.92);
      color: rgba(232,210,184,0.85);
      font-size: 12px;
      font-variant-numeric: tabular-nums;
    }
    .branchReqPct{
      color: var(--gold-3);
      font-weight: 700;
    }
    .branchReqMeta{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .branchAcceptBtn{
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(167,122,77,0.32);
      background: rgba(20,13,10,0.45);
      color: rgba(232,210,184,0.68);
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      opacity: 0.92;
      transition: 140ms ease;
    }
    .branchAcceptBtn:hover,
    .branchAcceptBtn:focus-visible{
      border-color: rgba(225,194,138,0.72);
      background: rgba(48,31,22,0.82);
      color: rgba(244,229,201,0.98);
    }
    .branchAcceptBtn:disabled{
      cursor: not-allowed;
      opacity: 0.6;
      pointer-events: none;
    }
    .branchReqEmpty{
      justify-content: center;
      color: rgba(232,210,184,0.7);
      font-style: italic;
    }
    .teamMember{
      display:grid;
      align-items:center;
      grid-template-columns: auto 1fr auto;
      column-gap: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.28);
      background: rgba(20,13,10,0.55);
      color: rgba(232,210,184,0.85);
      font-size: 12px;
      font-variant-numeric: tabular-nums;
    }
    .teamMember.highlight{
      border-color: rgba(225,194,138,0.75);
      box-shadow: 0 0 0 1px rgba(225,194,138,0.25);
    }
    .teamInfo{
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 0;
      overflow: hidden;
    }
    .teamInfo span:last-child{
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .teamPct{
      color: var(--gold-3);
      font-weight: 700;
      letter-spacing: 0.2px;
      min-width: 44px;
      text-align: right;
      justify-self: end;
    }
    .anonIcon{
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display:grid;
      place-items:center;
      background: rgba(18,12,9,0.7);
      border: 1px solid rgba(231,210,170,0.35);
      flex: 0 0 auto;
      position: relative;
      overflow: visible;
    }
    .anonIcon svg{
      width: 12px;
      height: 12px;
      fill: var(--gold-3);
      opacity: 0.85;
    }
    .teamMember.highlight{
      position: relative;
    }
    .teamMember.highlight::after{
      content:"";
      position:absolute;
      top: -8px;
      right: -8px;
      width: 16px;
      height: 16px;
      background: rgba(225,194,138,0.98);
      border: 1px solid rgba(42,27,18,0.85);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.55);
      z-index: 3;
      pointer-events: none;
    }
    .teamMember.highlight::before{
      content:"";
      position:absolute;
      top: -4px;
      right: -4px;
      width: 10px;
      height: 10px;
      z-index: 4;
      background: #2a1b12;
      -webkit-mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M3 18h18l-2-10-5 5-2-7-2 7-5-5-2 10Zm4 2h10v2H7v-2Z'/></svg>") no-repeat center / contain;
      mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M3 18h18l-2-10-5 5-2-7-2 7-5-5-2 10Zm4 2h10v2H7v-2Z'/></svg>") no-repeat center / contain;
      pointer-events: none;
    }

    .heroStats{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
      padding: 14px;
    }
    .stat{
      padding: 12px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(203,180,138,0.18);
      background: rgba(0,0,0,0.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .stat .label{
      color: rgba(239,230,214,0.62);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .stat .value{
      font-size: 18px;
      font-weight: 850;
      letter-spacing: 0.2px;
      color: rgba(239,230,214,0.92);
    }

    .businessBody{
      padding: 0 14px 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .panel{
      padding: 14px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(203,180,138,0.18);
      background: rgba(0,0,0,0.16);
    }
    .panel h3{
      margin:0 0 10px;
      font-family: "Georgia","Times New Roman",serif;
      color: var(--gold-3);
      letter-spacing: 0.2px;
      font-size: 20px;
    }
    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .panelHeader h3{
      margin:0;
    }
    .ruleDate{
      margin-left: 8px;
      font-size: 12px;
      font-family: ui-sans-serif, system-ui;
      font-weight: 600;
      color: rgba(232,210,184,0.7);
      letter-spacing: 0;
      white-space: nowrap;
    }
    .createTaskBtn{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.55);
      color: var(--gold-3);
      font-family: "Georgia","Times New Roman",serif;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: 140ms ease;
    }
    .createTaskBtn:hover{
      background: rgba(92,64,40,0.5);
      border-color: rgba(225,194,138,0.55);
      transform: translateY(-1px);
    }

    .proposalModal{
      position: fixed;
      inset: 0;
      background: rgba(7,5,4,0.72);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 16px;
    }
    .proposalModal.open{
      display: flex;
    }
    .proposalCard{
      width: min(620px, 96vw);
      border-radius: 14px;
      border: 1px solid rgba(167,122,77,0.38);
      background: rgba(18,12,9,0.98);
      box-shadow: 0 24px 48px rgba(0,0,0,0.6);
      padding: 16px;
    }
    .proposalCard h3{
      margin: 0 0 10px;
      color: var(--gold-3);
      font-family: "Georgia","Times New Roman",serif;
      font-size: 20px;
    }
    .proposalCard p{
      margin: 0;
      color: rgba(232,210,184,0.84);
      font-size: 13px;
      line-height: 1.45;
    }
    .proposalInput{
      width: 100%;
      min-height: 128px;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.8);
      color: rgba(239,230,214,0.94);
      font-size: 14px;
      resize: vertical;
      outline: none;
      font-family: ui-sans-serif, system-ui;
    }
    .proposalInput:focus{
      border-color: rgba(225,194,138,0.6);
      box-shadow: 0 0 0 2px rgba(225,194,138,0.18);
    }
    .proposalActions{
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .proposalActionsLeft{
      justify-content: flex-start;
    }
    .proposalBtn{
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.55);
      color: rgba(239,230,214,0.92);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    .proposalBtn.primary{
      color: var(--gold-3);
      border-color: rgba(225,194,138,0.6);
      background: linear-gradient(180deg, rgba(120,86,56,0.42), rgba(35,23,17,0.85));
    }
    .proposalBtn:hover{
      transform: translateY(-1px);
    }
    .proposalStage[hidden]{
      display: none;
    }
    .proposalLoading{
      display: grid;
      justify-items: center;
      gap: 10px;
      padding: 18px 10px;
    }
    .proposalSpinner{
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 3px solid rgba(225,194,138,0.2);
      border-top-color: rgba(225,194,138,0.95);
      animation: proposalSpin 0.9s linear infinite;
    }
    @keyframes proposalSpin{
      to { transform: rotate(360deg); }
    }
    .proposalRiskList{
      margin: 12px 0 0;
      padding-left: 18px;
      color: rgba(239,230,214,0.86);
      line-height: 1.6;
      font-size: 14px;
    }
    .proposalLoss{
      margin-top: 12px;
      color: var(--gold-3);
      font-size: 14px;
      font-weight: 800;
    }
    .list{
      margin:0;
      padding-left: 18px;
      color: rgba(239,230,214,0.78);
      line-height: 1.6;
      font-size: 14px;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(203,180,138,0.14);
      color: rgba(239,230,214,0.78);
      font-size: 14px;
    }
    .kv:last-child{ border-bottom:0; }
    .kv b{ color: rgba(239,230,214,0.92); font-weight: 800; }

    @media (max-width: 920px){
      .card{ grid-template-columns: 220px 1fr; }
      .cardAction{ grid-column: 1 / -1; justify-content:flex-end; }
      .businessHero{ grid-template-columns: 1fr; }
      .heroImg img{ height: auto; }
      .heroStats{ grid-template-columns: 1fr; }
      .businessBody{ grid-template-columns: 1fr; }
    }
    @media (max-width: 620px){
      .topbar{
        flex-direction: column;
        align-items: stretch;
        padding: 0 14px 4px;
      }
      .left{
        width: 100%;
        min-width: 0;
        justify-content: center;
        padding-left: 0;
        margin-top: 0;
        position: relative;
      }
      .right{
        width: 100%;
        flex-direction: column;
        align-items: stretch;
      }
      .tabs{
        width:100%;
        justify-content:space-between;
        gap: 6px;
      }
      .tab{
        flex: 1 1 0;
        text-align: center;
        padding: 8px 6px;
        font-size: 12px;
        white-space: nowrap;
      }
      .profileMenu{
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 12;
      }
      .profile{ width:100%; justify-content:space-between; }
      .userAddr{ font-size: 0; }
      .userAddr::before{ content: "0x...9c"; font-size: 12px; margin-left: 10px; display: inline-block; }
      .userMeta{ max-width: 56px; }
      .userName{ font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .brand{
        min-width: unset;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      }
      .brandTitle{
        position: static;
        margin: 0;
        text-align: center;
      }
      .card{ grid-template-columns: 1fr; }
      .thumb{ height: 190px; }
      .cardAction{ justify-content:flex-start; }
      .logo{ width: 64px; height: 64px; }
      .brandTitle h1{ font-size: 14px; }
    }
  </style>
</head>

<body>
  <!-- INTRO (kept the same) -->
  <div class="intro" id="intro" aria-hidden="true">
    <div class="introStage">
      <img id="introTree" class="introTree" src="images/spring.png" alt="" />
      <p id="introLine1" class="introLine1 jp">森へようこそでございます</p>
      <p id="introLine2" class="introLine2 jp">夏です。</p>
    </div>
  </div>

  <div class="wrap">
    <div class="headerStack">
      <div class="legalBanner">
        This application is a mock example. By using this app, you agree to the legal disclaimer
        <a href="https://github.com/0xAgro/Branchism/blob/main/README.md" target="_blank" rel="noopener noreferrer">here</a>.
        You can also <a href="https://github.com/0xAgro/Branchism?tab=readme-ov-file#support" target="_blank" rel="noopener noreferrer">support active research</a> (Ethereum accepted).
        <button class="legalDismiss" type="button" aria-label="Dismiss legal notice">&times;</button>
      </div>

      <div class="deployBanner" aria-label="Emergency Facet Deployment status">
        <div class="deployHead">
          <span class="deployTitle">Emergency Facet Deployment</span>
          <span class="deployState">Not Enacted</span>
        </div>
        <div class="deployTrack" aria-hidden="true">
          <span class="deployFill"></span>
          <span class="deployMark"></span>
          <span class="deployMarkLabel">70%</span>
        </div>
      </div>

      <header class="topbar">
        <div class="left">
          <div class="brand">
            <img class="logo" id="headerLogo" src="images/spring.png" alt="The Root logo" />
            <div class="brandTitle"><h1>The Root</h1></div>
          </div>
        </div>

        <div class="right">
          <nav class="tabs" aria-label="Primary">
            <a class="tab active" href="explore.html" aria-current="page">Explore</a>
            <a class="tab" href="contract.html">Contract Work</a>
            <a class="tab" href="clone.html">Clone</a>
            <a class="tab" href="manage.html">Manage</a>
          </nav>

        <div class="profileMenu">
          <button class="profileBtn" type="button" aria-label="Profile menu">
            <div class="userBadge">
                <div class="avatar" aria-hidden="true">
                  <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                    <path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/>
                  </svg>
                </div>
                <div class="userMeta">
                  <div class="userName">中本 哲史</div>
                  <div class="userAddr">0x4f2a...9c1b</div>
              </div>
            </div>
          </button>
          <span class="profileNotify" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M12 22a2.8 2.8 0 0 0 2.7-2h-5.4A2.8 2.8 0 0 0 12 22Zm7-5H5c1-1 2-2.2 2-5v-1a5 5 0 1 1 10 0v1c0 2.8 1 4 2 5Z"/></svg>
          </span>
          <div class="profileNotifyTip">You have 4 branch requests</div>
          <div class="profilePanel" role="menu" aria-label="Wallet">
              <div class="profile">
                <div class="pill">Wallet <span class="value">Ξ2.1621</span></div>
                <div class="pill">Debt Allowance <span class="value">Ξ1</span></div>
              </div>
            </div>
          </div>
        </div>
      </header>
    </div>

    <!-- ===================== PAGE: YOUR AREA ===================== -->
    <main class="page active" id="page-area" aria-label="Explore">
      <div class="panel" style="margin-bottom:12px;">
        <div class="kv" style="border-bottom:0; padding:6px 0; display:flex; align-items:center; gap:8px;">
          <span style="display:inline-flex; width:18px; height:18px; border-radius:999px; align-items:center; justify-content:center; background:rgba(170,28,28,0.95); border:1px solid rgba(255,195,195,0.5); color:#fff3dc; flex:0 0 auto;">
            <svg viewBox="0 0 24 24" width="11" height="11" aria-hidden="true"><path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm0 15.4a1.2 1.2 0 1 1 1.2-1.2 1.2 1.2 0 0 1-1.2 1.2Zm1.1-4.3h-2.2V6.8h2.2Z"/></svg>
          </span>
          <span>This section is under development.</span>
          <b>Notice</b>
        </div>
      </div>
      <div class="mapPanel">
        <div class="mapHeader">
          <div style="display:flex; gap:10px; align-items:center;">
            <span class="badge">Tokyo</span>
            <span>Map view (OpenStreetMap embed)</span>
          </div>
          <span class="badge">Static</span>
        </div>

        <div id="map" role="img" aria-label="Tokyo Map"></div>
      </div>
    </main>

    <!-- ===================== PAGE: CLONE ===================== -->
    <main class="page" id="page-clone" aria-label="Clone">
      <div class="controls">
        <div class="search" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" opacity="0.85"/>
            <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity="0.85"/>
          </svg>
          <input id="search" type="search" placeholder="Search businesses…" autocomplete="off" />
        </div>
        <select id="sortClone" class="sortControl" aria-label="Sort clone businesses">
          <option value="distance_desc" selected>Sort: Farthest to closest branch</option>
          <option value="min_start_asc">Sort: Minimal starting cost</option>
          <option value="min_workers_asc">Sort: Minimal workers</option>
          <option value="avg_income_desc">Sort: Average yearly income</option>
        </select>
      </div>

      <section class="grid" id="cards">
        <article class="card" data-name="coffee shop cafe" data-distance-km="27" data-min-start="13.33" data-min-workers="3" data-avg-income="73.33">
          <div class="thumbWrap"><img class="thumb" src="images/cafe.png" alt="Coffee Shop" /></div>
          <div class="cardMain">
            <h3 class="title">Cafe Nakamoto</h3>
            <div class="rev">Ξ73.33 <span class="unit">/ year avg (all branches)</span></div>
            <div class="rowStats">
              <div><span class="k">Minimal starting capital</span><span class="v">Ξ13.33</span></div>
              <div><span class="k">Avg. operation</span><span class="v">Ξ20.00 / year</span></div>
              <div><span class="k">Worker range</span><span class="v">3-6</span></div>
              <div><span class="k">Closest Branch</span><span class="v">27 km</span></div>
            </div>
          </div>
          <div class="cardAction"><button class="viewBtn cloneBtnUnavailable" type="button" data-tip="Terminate your business before cloning">Clone Request</button></div>
        </article>

        <article class="card" data-name="pet grooming salon" data-distance-km="143" data-min-start="5.67" data-min-workers="2" data-avg-income="61.67">
          <div class="thumbWrap"><img class="thumb" src="images/Pet_store.png" alt="Pet Grooming" /></div>
          <div class="cardMain">
            <h3 class="title">Pet Grooming</h3>
            <div class="rev">Ξ61.67 <span class="unit">/ year avg (all branches)</span></div>
            <div class="rowStats">
              <div><span class="k">Minimal starting capital</span><span class="v">Ξ5.67</span></div>
              <div><span class="k">Avg. operation</span><span class="v">Ξ18.33 / year</span></div>
              <div><span class="k">Worker range</span><span class="v">2-5</span></div>
              <div><span class="k">Closest Branch</span><span class="v">143 km</span></div>
            </div>
          </div>
          <div class="cardAction"><button class="viewBtn cloneBtnUnavailable" type="button" data-tip="Terminate your business before cloning">Clone Request</button></div>
        </article>

        <article class="card" data-name="plant nursery garden" data-distance-km="312" data-min-start="8.33" data-min-workers="1" data-avg-income="68.33">
          <div class="thumbWrap"><img class="thumb" src="images/plant_nursery.png" alt="Plant Nursery" /></div>
          <div class="cardMain">
            <h3 class="title">Plant Nursery</h3>
            <div class="rev">Ξ68.33 <span class="unit">/ year avg (all branches)</span></div>
            <div class="rowStats">
              <div><span class="k">Minimal starting capital</span><span class="v">Ξ8.33</span></div>
              <div><span class="k">Avg. operation</span><span class="v">Ξ21.00 / year</span></div>
              <div><span class="k">Worker range</span><span class="v">1-4</span></div>
              <div><span class="k">Closest Branch</span><span class="v">312 km</span></div>
            </div>
          </div>
          <div class="cardAction"><button class="viewBtn cloneBtnUnavailable" type="button" data-tip="Terminate your business before cloning">Clone Request</button></div>
        </article>

        <article class="card" data-name="ice cream shop dessert" data-distance-km="8" data-min-start="8.33" data-min-workers="2" data-avg-income="73.33">
          <div class="thumbWrap"><img class="thumb" src="images/ice_cream.png" alt="Ice Cream Shop" /></div>
          <div class="cardMain">
            <h3 class="title">Ice Cream Shop</h3>
            <div class="rev">Ξ73.33 <span class="unit">/ year avg (all branches)</span></div>
            <div class="rowStats">
              <div><span class="k">Minimal starting capital</span><span class="v">Ξ8.33</span></div>
              <div><span class="k">Avg. operation</span><span class="v">Ξ21.00 / year</span></div>
              <div><span class="k">Worker range</span><span class="v">2-4</span></div>
              <div><span class="k">Closest Branch</span><span class="v">8 km</span></div>
            </div>
          </div>
          <div class="cardAction"><button class="viewBtn cloneBtnUnavailable" type="button" data-tip="Terminate your business before cloning">Clone Request</button></div>
        </article>
      </section>
    </main>

    <!-- ===================== PAGE: MANAGE ===================== -->
    <main class="page" id="page-manage" aria-label="Manage">
      <section class="businessPage">
        <div class="businessHero">
          <div class="heroImg">
            <img src="images/cafe-minimal.png" alt="Cafe Nakamoto" />
          </div>
          <div class="heroInfo">
            <h2>Cafe Nakamoto</h2>
            <div class="heroMeta">Status: Operating · Location: Shinjuku, Tokyo · Category: Café</div>
            <div class="heroBadges">
              <span class="badge">Shinjuku</span>
              <span class="badge">Open</span>
              <span class="badge">Team: 6</span>
            </div>
            <div class="teamTitle">Team Members</div>
            <div class="teamList" aria-label="Team members">
              <div class="teamMember highlight">
                <span class="teamInfo">
                  <span class="anonIcon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/></svg>
                  </span>
                  0x4f2a...9c1b
                </span>
                <span class="teamPct">34%</span>
              </div>
              <div class="teamMember">
                <span class="teamInfo">
                  <span class="anonIcon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/></svg>
                  </span>
                  0x8c31...a92f
                </span>
                <span class="teamPct">16%</span>
              </div>
              <div class="teamMember">
                <span class="teamInfo">
                  <span class="anonIcon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/></svg>
                  </span>
                  0x1f7b...c4e2
                </span>
                <span class="teamPct">15%</span>
              </div>
              <div class="teamMember">
                <span class="teamInfo">
                  <span class="anonIcon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/></svg>
                  </span>
                  0x5a9d...11b6
                </span>
                <span class="teamPct">13%</span>
              </div>
              <div class="teamMember">
                <span class="teamInfo">
                  <span class="anonIcon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/></svg>
                  </span>
                  0x92de...7c40
                </span>
                <span class="teamPct">12%</span>
              </div>
              <div class="teamMember">
                <span class="teamInfo">
                  <span class="anonIcon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/></svg>
                  </span>
                  0x0b4f...e18a
                </span>
                <span class="teamPct">10%</span>
              </div>
            </div>

          </div>
        </div>

        <div class="branches">
          <h3 class="branchesTitle">Active Branches · Royalties</h3>
          <div class="branchList" aria-label="Active branches">
            <div class="branchItem">
              <span class="branchLeft">
                <span class="storeIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg>
                </span>
                <span class="branchAddr">0xa3f1...c77b</span>
              </span>
              <span class="branchActions"><span class="branchRoyalty">1.9% royalty</span><button class="forceForkBtn" type="button">Force Fork</button></span>
            </div>
            <div class="branchItem">
              <span class="branchLeft">
                <span class="storeIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg>
                </span>
                <span class="branchAddr">0x5d9c...10fa</span>
              </span>
              <span class="branchActions"><span class="branchRoyalty">1.6% royalty</span><button class="forceForkBtn" type="button">Force Fork</button></span>
            </div>
            <div class="branchItem">
              <span class="branchLeft">
                <span class="storeIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg>
                </span>
                <span class="branchAddr">0x9b42...7e0d</span>
              </span>
              <span class="branchActions"><span class="branchRoyalty">1.3% royalty</span><button class="forceForkBtn" type="button">Force Fork</button></span>
            </div>
            <div class="branchItem">
              <span class="branchLeft">
                <span class="storeIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg>
                </span>
                <span class="branchAddr">0x1c8e...a2b9</span>
              </span>
              <span class="branchActions"><span class="branchRoyalty">1.1% royalty</span><button class="forceForkBtn" type="button">Force Fork</button></span>
            </div>
            <div class="branchItem">
              <span class="branchLeft">
                <span class="storeIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg>
                </span>
                <span class="branchAddr">0x7aa1...f8c2</span>
              </span>
              <span class="branchActions"><span class="branchRoyalty">0.8% royalty</span><button class="forceForkBtn" type="button">Force Fork</button></span>
            </div>
          </div>

          <div class="branchRequests" aria-label="Branch requests">
            <div class="branchReqHead">
              <span>Branch Requests</span>
              <span class="branchReqCount"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 22a2.8 2.8 0 0 0 2.7-2h-5.4A2.8 2.8 0 0 0 12 22Zm7-5H5c1-1 2-2.2 2-5v-1a5 5 0 1 1 10 0v1c0 2.8 1 4 2 5Z"/></svg>4</span>
            </div>
            <p class="branchReqRule">Auto-accept threshold: 0.5% royalty</p>
            <div class="branchReqList">
              <div class="branchReqItem"><span>0x7d13...a8f4</span><span class="branchReqMeta"><span class="branchReqPct">0.1%</span><button class="branchAcceptBtn" type="button">Accept</button></span></div>
              <div class="branchReqItem"><span>0x2bc9...e11a</span><span class="branchReqMeta"><span class="branchReqPct">0.2%</span><button class="branchAcceptBtn" type="button">Accept</button></span></div>
              <div class="branchReqItem"><span>0x94ff...3c0d</span><span class="branchReqMeta"><span class="branchReqPct">0.3%</span><button class="branchAcceptBtn" type="button">Accept</button></span></div>
              <div class="branchReqItem"><span>0x5a10...b772</span><span class="branchReqMeta"><span class="branchReqPct">0.4%</span><button class="branchAcceptBtn" type="button">Accept</button></span></div>
            </div>
          </div>
        </div>

        <div class="heroStats">
          <div class="stat">
            <div class="label">Monthly revenue</div>
            <div class="value">Ξ5.20</div>
          </div>
          <div class="stat">
            <div class="label">Monthly operating cost</div>
            <div class="value">Ξ3.10</div>
          </div>
          <div class="stat">
            <div class="label">Next payroll</div>
            <div class="value">Ξ0.42</div>
          </div>
        </div>

        <div class="businessBody">
          <div class="panel">
            <h3>Operations</h3>
            <div class="kv"><span>Open hours</span><b>08:00–20:00</b></div>
            <div class="kv"><span>Average hourly income</span><b>Ξ0.028</b></div>
            <div class="kv"><span>Expenditure Reserve</span><b>Ξ1.25</b></div>
          </div>

          <div class="panel">
            <div class="panelHeader">
              <h3>Recent Rule Changes <span class="ruleDate" id="ruleDateLabel"></span></h3>
              <button class="createTaskBtn" type="button">Propose change</button>
            </div>
            <ul class="list">
              <li>Switch bean supplier to Yumenosora Roasters (0x7b3e...c9a1) — effective Mar 1</li>
              <li>Adjust house blend recipe: +5% Colombia, -5% Ethiopia</li>
              <li>Update milk options: add oat blend, discontinue soy</li>
              <li>Revise closing procedure checklist for grinder cleaning</li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="proposalModal" id="branchAcceptModal" aria-hidden="true">
    <div class="proposalCard" role="dialog" aria-modal="true" aria-labelledby="branchAcceptTitle">
      <section class="proposalStage" id="branchAcceptStage">
        <h3 id="branchAcceptTitle">Accept Branch Request</h3>
        <p id="branchAcceptSummary"></p>
        <div class="proposalActions proposalActionsLeft">
          <button type="button" class="proposalBtn" id="branchAcceptCancel">Cancel</button>
          <button type="button" class="proposalBtn primary" id="branchAcceptConfirm">Accept</button>
        </div>
      </section>
    </div>
  </div>

  <div class="proposalModal" id="proposalModal" aria-hidden="true">
    <div class="proposalCard" role="dialog" aria-modal="true" aria-labelledby="proposalTitle">
      <section class="proposalStage" id="proposalStageForm">
        <h3 id="proposalTitle">Propose Ruleset Change</h3>
        <p>Describe the operational change you want branches to adopt.</p>
        <textarea id="proposalInput" class="proposalInput" placeholder="Example: shift supplier allocation to 60% local roasters and update milk handling policy."></textarea>
        <div class="proposalActions">
          <button type="button" class="proposalBtn" id="proposalCancel">Cancel</button>
          <button type="button" class="proposalBtn primary" id="proposalSubmit">Propose</button>
        </div>
      </section>
      <section class="proposalStage proposalLoading" id="proposalStageLoading" hidden>
        <div class="proposalSpinner" aria-hidden="true"></div>
        <p>gettting response from branches...</p>
      </section>
      <section class="proposalStage" id="proposalStageResult" hidden>
        <h3>Branch Pushback Detected</h3>
        <p>The following branches signaled fork risk for this change:</p>
        <ul class="proposalRiskList" id="proposalRiskList"></ul>
        <p class="proposalLoss" id="proposalLoss"></p>
        <div class="proposalActions proposalActionsLeft">
          <button type="button" class="proposalBtn" id="proposalRevert">Revert Changes</button>
          <button type="button" class="proposalBtn primary" id="proposalProceed">Proceed Despite Risk</button>
        </div>
      </section>
    </div>
  </div>

  <div class="proposalModal" id="forkModal" aria-hidden="true">
    <div class="proposalCard" role="dialog" aria-modal="true" aria-labelledby="forkTitle">
      <section class="proposalStage" id="forkStage">
        <h3 id="forkTitle">Force Fork Confirmation</h3>
        <p id="forkSummary"></p>
        <p id="forkWarnings" style="margin-top:10px; color: rgba(232,210,184,0.82); line-height:1.5;"></p>
        <div class="proposalActions proposalActionsLeft">
          <button type="button" class="proposalBtn" id="forkCancel">Cancel</button>
          <button type="button" class="proposalBtn primary" id="forkConfirm">Confirm</button>
        </div>
      </section>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    (function(){
      /* ===== Seasonal logic (system time) ===== */
      function getSeason(month){
        if (month >= 2 && month <= 4) return "spring";
        if (month >= 5 && month <= 7) return "summer";
        if (month >= 8 && month <= 10) return "fall";
        return "winter";
      }

      const seasonText = {
        spring: "春です。",
        summer: "夏です。",
        fall:   "秋です。",
        winter: "冬です。"
      };

      const seasonImage = {
        spring: "images/spring.png",
        summer: "images/summer.png",
        fall:   "images/fall.png",
        winter: "images/winter.png"
      };

      const season = getSeason(new Date().getMonth());

      document.getElementById('introLine2').textContent = seasonText[season] || "夏です。";
      document.getElementById('introTree').src = seasonImage[season] || "images/spring.png";
      document.getElementById("headerLogo").src = seasonImage[season] || "images/spring.png";

      const legalBanner = document.querySelector(".legalBanner");
      const legalDismissBtn = document.querySelector(".legalDismiss");
      const legalDismissKey = "root_legal_dismissed";
      try {
        if (localStorage.getItem(legalDismissKey) === "1" && legalBanner) {
          legalBanner.classList.add("isDismissed");
        }
      } catch (_) {}
      if (legalDismissBtn && legalBanner) {
        legalDismissBtn.addEventListener("click", () => {
          legalBanner.classList.add("isDismissed");
          try {
            localStorage.setItem(legalDismissKey, "1");
          } catch (_) {}
        });
      }

      /* ===== Intro sequence (0.75x, tree lingers longer) ===== */
      const intro = document.getElementById('intro');
      const line1 = document.getElementById('introLine1');
      const tree  = document.getElementById('introTree');
      const line2 = document.getElementById('introLine2');

      if (sessionStorage.getItem('root_intro_seen')) {
        intro.classList.add('hide');
      } else {
        sessionStorage.setItem('root_intro_seen','1');

        const t = { show1: 90, showTree: 675, show2: 1875, done: 2700 };

        setTimeout(() => line1.classList.add('show'), t.show1);
        setTimeout(() => tree.classList.add('showTree'), t.showTree);
        setTimeout(() => line2.classList.add('show'), t.show2);
        setTimeout(() => intro.classList.add('hide'), t.done);
      }

      /* ===== Tabs operational ===== */
      const tabs = Array.from(document.querySelectorAll('.tab[data-page]'));
      const pages = {
        area: document.getElementById('page-area'),
        clone: document.getElementById('page-clone'),
        manage: document.getElementById('page-manage')
      };

      function setActive(pageKey){
        tabs.forEach(t => t.classList.toggle('active', t.dataset.page === pageKey));
        Object.keys(pages).forEach(k => pages[k].classList.toggle('active', k === pageKey));
      }
      tabs.forEach(t => t.addEventListener('click', () => setActive(t.dataset.page)));

      /* ===== Search filter (Clone tab) ===== */
      const search = document.getElementById('search');
      const sortClone = document.getElementById('sortClone');
      const cardsContainer = document.getElementById('cards');
      const cards = Array.from(document.querySelectorAll('#cards .card'));

      function sortValue(card, key){
        if (key === 'distance_desc') return Number(card.getAttribute('data-distance-km') || 0);
        if (key === 'min_start_asc') return Number(card.getAttribute('data-min-start') || 0);
        if (key === 'min_workers_asc') return Number(card.getAttribute('data-min-workers') || 0);
        if (key === 'avg_income_desc') return Number(card.getAttribute('data-avg-income') || 0);
        return 0;
      }

      function renderCloneCards(){
        const query = (search && search.value ? search.value : '').trim().toLowerCase();
        const sortKey = sortClone ? sortClone.value : 'distance_desc';

        const visibleCards = cards.filter(card => {
          const name = (card.getAttribute('data-name') || '').toLowerCase();
          return !query || name.includes(query);
        });

        const sorted = visibleCards.slice().sort((a, b) => {
          const av = sortValue(a, sortKey);
          const bv = sortValue(b, sortKey);
          if (sortKey === 'min_start_asc' || sortKey === 'min_workers_asc') return av - bv;
          return bv - av;
        });

        cards.forEach(card => { card.style.display = 'none'; });
        sorted.forEach(card => {
          card.style.display = '';
          cardsContainer.appendChild(card);
        });
      }
      if (search) search.addEventListener('input', renderCloneCards);
      if (sortClone) sortClone.addEventListener('change', renderCloneCards);
      renderCloneCards();

      /* ===== Branch request acceptance (session only) ===== */
      const branchRequestsEl = document.querySelector('.branchRequests');
      if (branchRequestsEl) {
        const branchListEl = document.querySelector('.branchList');
        const requestListEl = branchRequestsEl.querySelector('.branchReqList');
        const requestCountEl = branchRequestsEl.querySelector('.branchReqCount');
        const notifyTipEl = document.querySelector('.profileNotifyTip');
        const notifyIconEl = document.querySelector('.profileNotify');

        const monthlyRevenueText = (document.querySelector('.heroStats .stat .value') || {}).textContent || '0';
        const monthlyRevenue = Number(monthlyRevenueText.replace(/[^0-9.]/g, '')) || 0;

        const ownerPctText = (document.querySelector('.teamMember.highlight .teamPct') || {}).textContent || '0';
        const ownerPct = Number(ownerPctText.replace(/[^0-9.]/g, '')) || 0;

        function formatEth(value){
          return '\u039e' + value.toFixed(4);
        }

        function renderRequestCount(count){
          requestCountEl.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 22a2.8 2.8 0 0 0 2.7-2h-5.4A2.8 2.8 0 0 0 12 22Zm7-5H5c1-1 2-2.2 2-5v-1a5 5 0 1 1 10 0v1c0 2.8 1 4 2 5Z"/></svg>' + count;
          requestCountEl.classList.toggle('isZero', count === 0);
          if (notifyIconEl) {
            notifyIconEl.style.display = count === 0 ? 'none' : '';
          }
          if (notifyTipEl) {
            notifyTipEl.style.display = count === 0 ? 'none' : '';
            notifyTipEl.textContent = 'You have ' + count + ' branch request' + (count === 1 ? '' : 's');
          }
        }

        function updateEmptyState(){
          const count = requestListEl.querySelectorAll('.branchReqItem').length;
          let emptyNode = requestListEl.querySelector('.branchReqEmpty');
          if (count === 0) {
            if (!emptyNode) {
              emptyNode = document.createElement('div');
              emptyNode.className = 'branchReqItem branchReqEmpty';
              emptyNode.textContent = 'No pending requests';
              requestListEl.appendChild(emptyNode);
            }
          } else if (emptyNode) {
            emptyNode.remove();
          }
          renderRequestCount(count);
        }

        function addBranch(addr, pctText){
          const newItem = document.createElement('div');
          newItem.className = 'branchItem';
          newItem.innerHTML =
            '<span class="branchLeft">' +
              '<span class="storeIcon" aria-hidden="true">' +
                '<svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg>' +
              '</span>' +
              '<span class="branchAddr">' + addr + '</span>' +
            '</span>' +
            '<span class="branchActions"><span class="branchRoyalty">' + pctText + ' royalty</span><button class="forceForkBtn" type="button">Force Fork</button></span>';
          branchListEl.appendChild(newItem);
        }

        let pendingBranchAccept = null;
        const branchAcceptModal = document.getElementById("branchAcceptModal");
        const branchAcceptSummary = document.getElementById("branchAcceptSummary");
        const branchAcceptCancel = document.getElementById("branchAcceptCancel");
        const branchAcceptConfirm = document.getElementById("branchAcceptConfirm");

        function openBranchAcceptModal(){
          if (!branchAcceptModal) return;
          branchAcceptModal.classList.add("open");
          branchAcceptModal.setAttribute("aria-hidden", "false");
        }

        function closeBranchAcceptModal(){
          if (!branchAcceptModal) return;
          branchAcceptModal.classList.remove("open");
          branchAcceptModal.setAttribute("aria-hidden", "true");
          pendingBranchAccept = null;
        }

        if (branchAcceptModal) {
          branchAcceptCancel.addEventListener("click", closeBranchAcceptModal);
          branchAcceptConfirm.addEventListener("click", () => {
            if (!pendingBranchAccept) {
              closeBranchAcceptModal();
              return;
            }
            addBranch(pendingBranchAccept.addr, pendingBranchAccept.pctText);
            pendingBranchAccept.item.remove();
            updateEmptyState();
            closeBranchAcceptModal();
          });
          branchAcceptModal.addEventListener("click", (event) => {
            if (event.target === branchAcceptModal) closeBranchAcceptModal();
          });
        }

        requestListEl.querySelectorAll('.branchAcceptBtn').forEach((btn) => {
          btn.disabled = false;
          btn.addEventListener('click', () => {
            const item = btn.closest('.branchReqItem');
            if (!item) return;

            const addrNode = item.children[0];
            const pctNode = item.querySelector('.branchReqPct');
            if (!addrNode || !pctNode) return;

            const addr = addrNode.textContent.trim();
            const pctText = pctNode.textContent.trim();
            const pct = Number(pctText.replace(/[^0-9.]/g, '')) || 0;

            const activeCount = Math.max(1, branchListEl.querySelectorAll('.branchItem').length);
            const avgBranchRevenue = monthlyRevenue / activeCount;
            const personalIncrease = avgBranchRevenue * (pct / 100) * (ownerPct / 100);

            pendingBranchAccept = { addr: addr, pctText: pctText, item: item };
            branchAcceptSummary.textContent =
              "Accept branch request from " + addr + " at " + pctText + " royalty? Estimated personal income increase: " +
              formatEth(personalIncrease) + " / month.";
            openBranchAcceptModal();
          });
        });

        updateEmptyState();
      }

      /* ===== Ruleset proposal flow ===== */
      const proposeBtn = document.querySelector(".createTaskBtn");
      const ruleDateLabel = document.getElementById("ruleDateLabel");
      if (ruleDateLabel) {
        const now = new Date();
        ruleDateLabel.textContent = now.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
      }
      const proposalModal = document.getElementById("proposalModal");
      const proposalInput = document.getElementById("proposalInput");
      const proposalCancel = document.getElementById("proposalCancel");
      const proposalSubmit = document.getElementById("proposalSubmit");
      const proposalRevert = document.getElementById("proposalRevert");
      const proposalProceed = document.getElementById("proposalProceed");
      const proposalStageForm = document.getElementById("proposalStageForm");
      const proposalStageLoading = document.getElementById("proposalStageLoading");
      const proposalStageResult = document.getElementById("proposalStageResult");
      const proposalRiskList = document.getElementById("proposalRiskList");
      const proposalLoss = document.getElementById("proposalLoss");
      let latestAtRisk = [];

      if (proposeBtn && proposalModal) {
        const monthlyRevenueText = (document.querySelector(".heroStats .stat .value") || {}).textContent || "0";
        const monthlyRevenue = Number(monthlyRevenueText.replace(/[^0-9.]/g, "")) || 0;

        function openProposal(){
          proposalModal.classList.add("open");
          proposalModal.setAttribute("aria-hidden", "false");
          proposalStageForm.hidden = false;
          proposalStageLoading.hidden = true;
          proposalStageResult.hidden = true;
          proposalInput.value = "";
          proposalInput.focus();
        }

        function closeProposal(){
          proposalModal.classList.remove("open");
          proposalModal.setAttribute("aria-hidden", "true");
        }

        function showLoading(){
          proposalStageForm.hidden = true;
          proposalStageLoading.hidden = false;
          proposalStageResult.hidden = true;
        }

        function showResult(){
          const atRisk = [
            { addr: "0x5d9c...10fa", royalty: 1.6 },
            { addr: "0x9b42...7e0d", royalty: 1.3 },
            { addr: "0x1c8e...a2b9", royalty: 1.1 }
          ];

          const totalRoyalty = atRisk.reduce((sum, x) => sum + x.royalty, 0);
          const estMonthlyLoss = monthlyRevenue * (totalRoyalty / 100);

          latestAtRisk = atRisk.slice();

          proposalRiskList.innerHTML = atRisk
            .map((r) => "<li>" + r.addr + " \u2022 " + r.royalty.toFixed(1) + "% royalty</li>")
            .join("");

          proposalLoss.textContent =
            "If they fork, estimated loss is " +
            "\u039e" + estMonthlyLoss.toFixed(4) +
            " / month (" +
            "\u039e" + (estMonthlyLoss * 12).toFixed(4) +
            " / year).";

          proposalStageForm.hidden = true;
          proposalStageLoading.hidden = true;
          proposalStageResult.hidden = false;
        }

        proposeBtn.addEventListener("click", openProposal);
        proposalCancel.addEventListener("click", closeProposal);
        proposalRevert.addEventListener("click", closeProposal);

        function proceedDespiteRisk(){
          if (!latestAtRisk.length) {
            closeProposal();
            return;
          }

          const rows = Array.from(document.querySelectorAll(".branchList .branchItem"));
          rows.forEach((row) => {
            const addrEl = row.querySelector(".branchAddr");
            if (!addrEl) return;
            const addr = addrEl.textContent.trim();
            if (latestAtRisk.some((entry) => entry.addr === addr)) {
              row.remove();
            }
          });

          closeProposal();
        }

        proposalProceed.addEventListener("click", proceedDespiteRisk);

        proposalModal.addEventListener("click", (event) => {
          if (event.target === proposalModal) closeProposal();
        });

        proposalSubmit.addEventListener("click", () => {
          if (!proposalInput.value.trim()) {
            proposalInput.focus();
            return;
          }

          showLoading();
          setTimeout(showResult, 2200);
        });
      }

      /* ===== Force fork flow ===== */
      const forkModal = document.getElementById("forkModal");
      const forkTitle = document.getElementById("forkTitle");
      const forkSummary = document.getElementById("forkSummary");
      const forkWarnings = document.getElementById("forkWarnings");
      const forkCancel = document.getElementById("forkCancel");
      const forkConfirm = document.getElementById("forkConfirm");
      let activeForkContext = null;
      const FORK_WINDOW_MS = 90 * 24 * 60 * 60 * 1000;
      let forkTimerTicking = false;

      function parsePct(text){
        return Number((text || "").replace(/[^0-9.]/g, "")) || 0;
      }

      function renderMonthsLeft(startMs){
        const elapsed = Math.max(0, Date.now() - startMs);
        const remaining = Math.max(0, FORK_WINDOW_MS - elapsed);
        const months = remaining / (30 * 24 * 60 * 60 * 1000);
        return months.toFixed(1) + " months";
      }

      function ensureForkBadge(item, startMs){
        if (!item) return;
        item.dataset.forkStartMs = String(startMs);
        item.classList.add("forkPending");
        let badge = item.querySelector(".forkTimerBtn");
        if (!badge) {
          badge = document.createElement("button");
          badge.type = "button";
          badge.className = "forkTimerBtn";
          badge.innerHTML =
            '<span class="forkTimerIcon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 1a1 1 0 0 1 1 1v1.06A9 9 0 1 1 5.64 6.9a1 1 0 1 1 1.54 1.28A7 7 0 1 0 13 5.06V6a1 1 0 1 1-2 0V2a1 1 0 0 1 1-1zm0 5a1 1 0 0 1 1 1v4.2l2.7 1.56a1 1 0 1 1-1 1.72l-3.2-1.85A1 1 0 0 1 11 12V7a1 1 0 0 1 1-1z"/></svg></span>' +
            '' +
            '<span class="forkTimerText"></span>';
          item.appendChild(badge);
        }
        const textEl = badge.querySelector(".forkTimerText");
        if (textEl) textEl.textContent = renderMonthsLeft(startMs);
      }

      function clearForkBadge(item){
        if (!item) return;
        item.classList.remove("forkPending");
        delete item.dataset.forkStartMs;
        const badge = item.querySelector(".forkTimerBtn");
        if (badge) badge.remove();
      }

      function tickForkBadges(){
        document.querySelectorAll(".branchList .branchItem[data-fork-start-ms]").forEach((item) => {
          const startMs = Number(item.dataset.forkStartMs);
          if (!startMs) return;
          ensureForkBadge(item, startMs);
        });
      }

      function startForkTicker(){
        if (forkTimerTicking) return;
        forkTimerTicking = true;
        setInterval(tickForkBadges, 1000);
      }

      function openForkModal(button, forceRetract){
        if (!forkModal || !button) return;

        const item = button.closest(".branchItem");
        const addr = item && item.querySelector(".branchAddr") ? item.querySelector(".branchAddr").textContent.trim() : "unknown";
        const royaltyText = item && item.querySelector(".branchRoyalty") ? item.querySelector(".branchRoyalty").textContent.trim() : "0% royalty";
        const royaltyPct = parsePct(royaltyText);

        const monthlyRevenueNode = document.querySelector(".heroStats .stat .value");
        const monthlyRevenue = parsePct(monthlyRevenueNode ? monthlyRevenueNode.textContent : "0");
        const estMonthlyLoss = monthlyRevenue * (royaltyPct / 100);
        const estYearlyLoss = estMonthlyLoss * 12;

        const forced = forceRetract ? true : button.classList.contains("forced");
        activeForkContext = { button: button, forced: forced };

        forkTitle.textContent = forced ? "Undo Force Fork" : "Force Fork Confirmation";
        forkSummary.textContent =
          (forced ? "Undo forced fork for " : "Force fork for ") +
          addr +
          " (" + royaltyText + ")." +
          (forced
            ? " This will cancel the pending fork notice and continue allowing this branch."
            : " Probable loss: \u039e" + estMonthlyLoss.toFixed(4) + " / month (\u039e" + estYearlyLoss.toFixed(4) + " / year).");

        forkWarnings.textContent =
          forced
            ? "Confirming this action keeps the branch active under the current royalty split."
            : "Branch will receive a 3 month notification. You can retract this action at any time. They can fork at any time regardless.";

        forkConfirm.textContent = forced ? "Undo Force Fork" : "Confirm";

        forkModal.classList.add("open");
        forkModal.setAttribute("aria-hidden", "false");
      }

      function closeForkModal(){
        if (!forkModal) return;
        forkModal.classList.remove("open");
        forkModal.setAttribute("aria-hidden", "true");
        activeForkContext = null;
      }

      if (forkModal) {
        document.addEventListener("click", (event) => {
          const forceBtn = event.target.closest(".forceForkBtn");
          if (forceBtn) {
            event.preventDefault();
            openForkModal(forceBtn, false);
            return;
          }

          const revertBtn = event.target.closest(".forkTimerBtn");
          if (!revertBtn) return;
          event.preventDefault();
          const row = revertBtn.closest(".branchItem");
          const btn = row ? row.querySelector(".forceForkBtn") : null;
          if (btn) openForkModal(btn, true);
        });

        forkCancel.addEventListener("click", closeForkModal);

        forkConfirm.addEventListener("click", () => {
          if (!activeForkContext || !activeForkContext.button) {
            closeForkModal();
            return;
          }

          const row = activeForkContext.button.closest(".branchItem");

          if (activeForkContext.forced) {
            activeForkContext.button.classList.remove("forced");
            activeForkContext.button.textContent = "Force Fork";
            clearForkBadge(row);
          } else {
            activeForkContext.button.classList.add("forced");
            activeForkContext.button.textContent = "Force Fork";
            const startMs = Date.now();
            ensureForkBadge(row, startMs);
            startForkTicker();
          }

          closeForkModal();
        });

        forkModal.addEventListener("click", (event) => {
          if (event.target === forkModal) closeForkModal();
        });

        tickForkBadges();
      }

      /* ===== Map (vector land/water first, Leaflet fallback) ===== */
      function hideUrbanLayers(style){
        if (!style || !Array.isArray(style.layers)) return;
        const hideById = /(building|house|poi|place|label|transit|aeroway)/i;
        style.layers.forEach((layer) => {
          const id = String(layer.id || "");
          const src = String(layer["source-layer"] || "");
          const isSymbol = layer.type === "symbol";
          const isUrban = hideById.test(id) || hideById.test(src);
          if (isSymbol || isUrban) {
            layer.layout = layer.layout || {};
            layer.layout.visibility = "none";
          }
        });
      }

      const ISLAND_BOUNDS = {
        south: 35.628,
        west: 139.890,
        north: 35.651,
        east: 139.945
      };
      const ISLAND_CENTER = [139.9162, 35.640126];

      // Numbered plots you can direct me to move by ID in follow-up edits.
      const MANUAL_PLOTS = [
        { id: 1, lng: 139.9148, lat: 35.6442, widthM: 120, heightM: 90 },
        { id: 2, lng: 139.9196, lat: 35.6450, widthM: 110, heightM: 85 },
        { id: 3, lng: 139.9251, lat: 35.6444, widthM: 130, heightM: 95 },
        { id: 4, lng: 139.9304, lat: 35.6430, widthM: 105, heightM: 80 },
        { id: 5, lng: 139.9342, lat: 35.6396, widthM: 125, heightM: 88 },
        { id: 6, lng: 139.9298, lat: 35.6362, widthM: 112, heightM: 86 },
        { id: 7, lng: 139.9231, lat: 35.6348, widthM: 118, heightM: 90 },
        { id: 8, lng: 139.9167, lat: 35.6363, widthM: 108, heightM: 84 }
      ];

      function getRoadLayerIds(style){
        if (!style || !Array.isArray(style.layers)) return [];
        return style.layers
          .filter((layer) => {
            if (!layer || layer.type !== "line") return false;
            const id = String(layer.id || "");
            const src = String(layer["source-layer"] || "");
            return /(road|street|highway|transport|rail|motorway|trunk|primary|secondary|tertiary)/i.test(id) ||
              /(road|street|highway|transport|rail|motorway|trunk|primary|secondary|tertiary)/i.test(src);
          })
          .map((layer) => layer.id);
      }

      const METERS_PER_DEG_LAT = 110540;

      function metersPerDegLng(lat){
        return 111320 * Math.cos((lat * Math.PI) / 180);
      }

      function lngLatToMeters(lng, lat, latRef){
        return {
          x: lng * metersPerDegLng(latRef),
          y: lat * METERS_PER_DEG_LAT
        };
      }

      function metersToLngLat(x, y, latRef){
        return [x / metersPerDegLng(latRef), y / METERS_PER_DEG_LAT];
      }

      function toPolyFeature(lngLatCorners, id){
        const coords = lngLatCorners.map((pt) => [pt[0], pt[1]]);
        coords.push([lngLatCorners[0][0], lngLatCorners[0][1]]);
        return {
          type: "Feature",
          properties: { id: id },
          geometry: { type: "Polygon", coordinates: [coords] }
        };
      }

      function makePlotPair(a, b, idBase){
        const latRef = (a[1] + b[1]) / 2;
        const p0 = lngLatToMeters(a[0], a[1], latRef);
        const p1 = lngLatToMeters(b[0], b[1], latRef);
        const dx = p1.x - p0.x;
        const dy = p1.y - p0.y;
        const len = Math.hypot(dx, dy);
        if (len < 30) return [];

        const ux = dx / len;
        const uy = dy / len;
        const px = -uy;
        const py = ux;

        const halfLen = 11;
        const depth = 13;
        const roadOffset = 14;

        function rect(side, suffix){
          const cx = (p0.x + p1.x) / 2 + px * side * (roadOffset + depth * 0.5);
          const cy = (p0.y + p1.y) / 2 + py * side * (roadOffset + depth * 0.5);
          const pA = [cx - ux * halfLen - px * side * depth * 0.5, cy - uy * halfLen - py * side * depth * 0.5];
          const pB = [cx + ux * halfLen - px * side * depth * 0.5, cy + uy * halfLen - py * side * depth * 0.5];
          const pC = [cx + ux * halfLen + px * side * depth * 0.5, cy + uy * halfLen + py * side * depth * 0.5];
          const pD = [cx - ux * halfLen + px * side * depth * 0.5, cy - uy * halfLen + py * side * depth * 0.5];
          return toPolyFeature(
            [
              metersToLngLat(pA[0], pA[1], latRef),
              metersToLngLat(pB[0], pB[1], latRef),
              metersToLngLat(pC[0], pC[1], latRef),
              metersToLngLat(pD[0], pD[1], latRef)
            ],
            idBase + suffix
          );
        }

        return [rect(1, "-a"), rect(-1, "-b")];
      }

      function buildRoadPlots(map, roadLayerIds){
        if (!roadLayerIds.length) return [];
        let features = [];
        try {
          features = map.queryRenderedFeatures(undefined, { layers: roadLayerIds });
        } catch (_) {
          return [];
        }

        const out = [];
        const seen = new Set();
        const maxPlots = 320;

        features.forEach((feature, fIndex) => {
          if (!feature || !feature.geometry) return;
          const geom = feature.geometry;
          const lines = [];
          if (geom.type === "LineString" && Array.isArray(geom.coordinates)) lines.push(geom.coordinates);
          if (geom.type === "MultiLineString" && Array.isArray(geom.coordinates)) {
            geom.coordinates.forEach((line) => lines.push(line));
          }

          lines.forEach((line, lIndex) => {
            if (!Array.isArray(line) || line.length < 2) return;
            for (let i = 0; i < line.length - 1; i += 1) {
              if (out.length >= maxPlots) return;
              const a = line[i];
              const b = line[i + 1];
              if (!a || !b) continue;
              const latRef = (a[1] + b[1]) / 2;
              const p0 = lngLatToMeters(a[0], a[1], latRef);
              const p1 = lngLatToMeters(b[0], b[1], latRef);
              const segLen = Math.hypot(p1.x - p0.x, p1.y - p0.y);
              if (segLen < 70) continue;

              const steps = Math.min(2, Math.max(1, Math.floor(segLen / 140)));
              for (let s = 0; s < steps; s += 1) {
                if (out.length >= maxPlots) return;
                const t0 = (s + 0.15) / steps;
                const t1 = (s + 0.85) / steps;
                const q0 = [a[0] + (b[0] - a[0]) * t0, a[1] + (b[1] - a[1]) * t0];
                const q1 = [a[0] + (b[0] - a[0]) * t1, a[1] + (b[1] - a[1]) * t1];
                const q0m = lngLatToMeters(q0[0], q0[1], latRef);
                const q1m = lngLatToMeters(q1[0], q1[1], latRef);
                const key = [
                  Math.round(q0m.x / 8), Math.round(q0m.y / 8),
                  Math.round(q1m.x / 8), Math.round(q1m.y / 8)
                ].join(":");
                if (seen.has(key)) continue;
                seen.add(key);
                out.push(...makePlotPair(q0, q1, "plot-" + fIndex + "-" + lIndex + "-" + i + "-" + s));
              }
            }
          });
        });

        return out.slice(0, maxPlots);
      }

      function setupRoadPlots(map){
        const style = map.getStyle();
        const roadLayerIds = getRoadLayerIds(style);
        if (!roadLayerIds.length) return;

        const sourceId = "road-plots-source";
        const fillId = "road-plots-fill";
        const lineId = "road-plots-line";

        if (!map.getSource(sourceId)) {
          map.addSource(sourceId, {
            type: "geojson",
            data: { type: "FeatureCollection", features: [] }
          });
        }
        if (!map.getLayer(fillId)) {
          map.addLayer({
            id: fillId,
            type: "fill",
            source: sourceId,
            paint: {
              "fill-color": "rgba(180, 140, 85, 0.26)",
              "fill-outline-color": "rgba(197, 163, 110, 0.36)"
            }
          });
        }
        if (!map.getLayer(lineId)) {
          map.addLayer({
            id: lineId,
            type: "line",
            source: sourceId,
            paint: {
              "line-color": "rgba(225, 194, 138, 0.45)",
              "line-width": 1
            }
          });
        }

        let timer = null;
        let lastRefreshZoom = map.getZoom();
        const refresh = () => {
          const source = map.getSource(sourceId);
          if (!source) return;
          const plots = buildRoadPlots(map, roadLayerIds);
          source.setData({ type: "FeatureCollection", features: plots });
        };
        const refreshDebounced = () => {
          clearTimeout(timer);
          timer = setTimeout(refresh, 180);
        };

        refresh();
        map.on("moveend", () => {
          const z = map.getZoom();
          if (Math.abs(z - lastRefreshZoom) > 0.0001) {
            lastRefreshZoom = z;
            return;
          }
          refreshDebounced();
        });
      }

      function plotRectFromMeters(plot){
        const halfW = (plot.widthM || 100) * 0.5;
        const halfH = (plot.heightM || 80) * 0.5;
        const latRef = plot.lat;
        const centerM = lngLatToMeters(plot.lng, plot.lat, latRef);
        const pA = metersToLngLat(centerM.x - halfW, centerM.y - halfH, latRef);
        const pB = metersToLngLat(centerM.x + halfW, centerM.y - halfH, latRef);
        const pC = metersToLngLat(centerM.x + halfW, centerM.y + halfH, latRef);
        const pD = metersToLngLat(centerM.x - halfW, centerM.y + halfH, latRef);
        const feature = toPolyFeature([pA, pB, pC, pD], "manual-plot-" + plot.id);
        feature.properties = {
          id: String(plot.id),
          label: String(plot.id),
          center: [plot.lng, plot.lat]
        };
        return feature;
      }

      function setupManualPlots(map){
        const sourceId = "manual-plots-source";
        const fillId = "manual-plots-fill";
        const lineId = "manual-plots-line";
        const labelId = "manual-plots-label";
        const features = MANUAL_PLOTS.map(plotRectFromMeters);

        if (!map.getSource(sourceId)) {
          map.addSource(sourceId, {
            type: "geojson",
            data: { type: "FeatureCollection", features: features }
          });
        } else {
          map.getSource(sourceId).setData({ type: "FeatureCollection", features: features });
        }

        if (!map.getLayer(fillId)) {
          map.addLayer({
            id: fillId,
            type: "fill",
            source: sourceId,
            paint: {
              "fill-color": "rgba(185, 146, 92, 0.30)",
              "fill-outline-color": "rgba(221, 193, 142, 0.42)"
            }
          });
        }
        if (!map.getLayer(lineId)) {
          map.addLayer({
            id: lineId,
            type: "line",
            source: sourceId,
            paint: {
              "line-color": "rgba(235, 213, 174, 0.78)",
              "line-width": 1.3
            }
          });
        }
        if (!map.getLayer(labelId)) {
          map.addLayer({
            id: labelId,
            type: "symbol",
            source: sourceId,
            layout: {
              "text-field": ["get", "label"],
              "text-size": 12,
              "text-font": ["Noto Sans Regular", "Arial Unicode MS Regular"]
            },
            paint: {
              "text-color": "rgba(250, 235, 210, 0.96)",
              "text-halo-color": "rgba(18, 12, 9, 0.92)",
              "text-halo-width": 1.2
            }
          });
        }
      }

      function initLeafletFallback(){
        const bounds = L.latLngBounds(
          L.latLng(ISLAND_BOUNDS.south, ISLAND_BOUNDS.west),
          L.latLng(ISLAND_BOUNDS.north, ISLAND_BOUNDS.east)
        );
        const map = L.map("map", {
          zoomControl: true,
          attributionControl: true,
          maxBounds: bounds,
          maxBoundsViscosity: 1.0
        }).setView([ISLAND_CENTER[1], ISLAND_CENTER[0]], 16);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 20,
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);
        map.setMaxBounds(bounds);
        L.marker([ISLAND_CENTER[1], ISLAND_CENTER[0]]).addTo(map);
      }

      async function initVectorMap(){
        if (!window.maplibregl) return false;

        try {
          const styleUrl = "https://tiles.openfreemap.org/styles/liberty";
          const response = await fetch(styleUrl, { mode: "cors" });
          if (!response.ok) return false;
          const style = await response.json();
          hideUrbanLayers(style);

          const map = new maplibregl.Map({
            container: "map",
            style: style,
            center: ISLAND_CENTER,
            zoom: 16,
            maxBounds: [
              [ISLAND_BOUNDS.west, ISLAND_BOUNDS.south],
              [ISLAND_BOUNDS.east, ISLAND_BOUNDS.north]
            ],
            minZoom: 14,
            attributionControl: true
          });

          map.addControl(new maplibregl.NavigationControl(), "top-left");
          map.on("load", () => {
            setupManualPlots(map);
            new maplibregl.Marker({ color: "#e1c28a" }).setLngLat(ISLAND_CENTER).addTo(map);
          });
          return true;
        } catch (_) {
          return false;
        }
      }

      initVectorMap().then((ok) => {
        if (!ok) initLeafletFallback();
      });

    })();
  </script>
</body>
</html>
