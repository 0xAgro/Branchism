<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Root</title>
  <link rel="icon" type="image/png" href="images/summer.png" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" />
  <script>
    (function(){
      try {
        document.documentElement.classList.add('intro-seen');
        try { sessionStorage.setItem('root_intro_seen', '1'); } catch (_) {}
      } catch (_) {}
    })();
  </script>

  <style>
    :root{
      /* =========================
         INTRO (keep the same)
         ========================= */
      --bg:#1E2320;
      --text:#EDEBE6;

      /* =========================
         APP THEME (reference style)
         ========================= */
      --app-bg: #231815;
      --app-ink:#efe4d3;
      --app-muted: rgba(232,210,184,0.75);
      --app-muted-2: rgba(232,210,184,0.55);

      --gold-3:#e1c28a;
      --bronze-1:#a77a4d;
      --bronze-2:#7b5637;

      --shadow: 0 14px 36px rgba(0,0,0,0.55);
      --radius: 18px;
      --radius-sm: 14px;
      --max: 1040px;
    }

    *{ box-sizing:border-box; }
    html,body{ min-height:100%; }
    html{
      background-color: #1a130f;
      background:
        radial-gradient(900px 700px at 30% 10%, rgba(146,106,70,0.20), transparent 60%),
        radial-gradient(900px 700px at 90% 40%, rgba(98,69,46,0.18), transparent 60%),
        radial-gradient(1100px 900px at 50% 120%, rgba(0,0,0,0.55), transparent 55%),
        linear-gradient(180deg, #1a130f, var(--app-bg));
      background-attachment: fixed;
    }

    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--app-ink);
      line-height: 1.35;
      overflow-y: auto;
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge legacy */
      background-color: #1a130f;
      background: transparent;
    }
    body::-webkit-scrollbar{ width:0; height:0; }

    .legalBanner{
      position: relative;
      padding-right: 34px;
    }
    .legalDismiss{
      position: absolute;
      top: 6px;
      right: 8px;
      width: 18px;
      height: 18px;
      border: 1px solid rgba(167,122,77,0.45);
      border-radius: 999px;
      background: rgba(24,16,12,0.88);
      color: rgba(232,210,184,0.9);
      font-size: 12px;
      line-height: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }
    .legalDismiss:hover,
    .legalDismiss:focus-visible{
      border-color: rgba(225,194,138,0.78);
      color: rgba(245,227,198,0.98);
      background: rgba(40,26,18,0.92);
    }
    .legalBanner.isDismissed{
      display: none;
    }

    a{ color:inherit; text-decoration:none; }
    .wrap{
      max-width: var(--max);
      margin: 0 auto;
      padding: 0 18px 56px;
    }
    .headerStack{
      position: sticky;
      top: 16px;
      z-index: 20;
    }
    .legalBanner{
      margin-top: 0;
      margin-bottom: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.72);
      color: rgba(232,210,184,0.86);
      font-size: 12px;
      line-height: 1.4;
      text-align: center;
    }
    .legalBanner a{
      color: var(--gold-3);
      font-weight: 700;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .deployBanner{
      margin-bottom: 8px;
      padding: 8px 12px 10px;
      border-radius: 10px;
      border: 1px solid rgba(90,155,110,0.45);
      background: linear-gradient(180deg, rgba(18,40,24,0.78), rgba(11,28,17,0.86));
      box-shadow: inset 0 1px 0 rgba(184,236,198,0.09);
    }
    .deployHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 12px;
      line-height: 1.2;
    }
    .deployTitle{
      color: rgba(198,238,208,0.95);
      font-weight: 700;
      letter-spacing: 0.2px;
    }
    .deployState{
      color: rgba(160,229,180,0.9);
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .deployTrack{
      position: relative;
      height: 8px;
      border-radius: 999px;
      border: 1px solid rgba(140,208,158,0.5);
      background: rgba(8,18,12,0.72);
      overflow: visible;
    }
    .deployFill{
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width: 10%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(111,224,146,0.88), rgba(56,174,105,0.92));
      box-shadow: 0 0 10px rgba(94,210,130,0.45);
    }
    .deployMark{
      position:absolute;
      left: 70%;
      top: -3px;
      bottom: -3px;
      width: 2px;
      background: rgba(195,247,210,0.96);
      box-shadow: 0 0 8px rgba(126,232,162,0.6);
    }
    .deployMarkLabel{
      position: absolute;
      left: 70%;
      bottom: calc(100% + 2px);
      transform: translateX(-50%);
      font-size: 10px;
      font-weight: 700;
      color: rgba(190,244,206,0.95);
      letter-spacing: 0.2px;
      white-space: nowrap;
      line-height: 1;
    }

    /* =========================
       INTRO (unchanged)
       ========================= */
    .intro{
      position: fixed;
      inset: 0;
      background: var(--bg);
      color: var(--text);
      display: grid;
      place-items: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 1800ms ease, visibility 0ms linear 1800ms;
      visibility: visible;
    }
    .intro.hide{ opacity:0; visibility:hidden; }
    .intro-seen .intro{ display:none !important; }

    .introStage{
      width: min(920px, 92vw);
      display: grid;
      place-items: center;
      row-gap: 14px;
      text-align: center;
    }
    .jp{
      font-family: "Hiragino Mincho ProN","Yu Mincho","Noto Serif JP","MS Mincho",serif;
      letter-spacing: 0.02em;
    }
    .introTree{
      width: clamp(120px, 18vw, 190px);
      opacity: 0;
      transform: translateY(6px);
      transition: opacity 1800ms ease, transform 1800ms ease;
      filter: drop-shadow(0 14px 26px rgba(0,0,0,0.45));
      user-select: none;
      -webkit-user-drag: none;
    }
    .introLine1{
      font-size: clamp(28px, 4vw, 56px);
      font-weight: 600;
      margin: 0;
      opacity: 0;
      transition: opacity 1800ms ease;
      text-shadow: 0 10px 28px rgba(0,0,0,0.45);
    }
    .introLine2{
      font-size: clamp(16px, 2.1vw, 22px);
      font-weight: 500;
      margin: 0;
      opacity: 0;
      transition: opacity 1800ms ease;
      color: rgba(237,235,230,0.85);
      text-shadow: 0 10px 28px rgba(0,0,0,0.45);
    }
    .show{ opacity:1 !important; }
    .showTree{ opacity:1 !important; transform: translateY(0) !important; }

    @media (prefers-reduced-motion: reduce){
      .intro, .introTree, .introLine1, .introLine2{ transition:none !important; }
    }

    /* =========================
       Top Bar
       ========================= */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-top: 0;
      margin-bottom: 36px;
      padding: 0 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(167,122,77,0.35);
      background:
        linear-gradient(180deg, rgba(109,78,49,0.25), rgba(14,9,7,0.65)),
        radial-gradient(900px 240px at 40% 0%, rgba(167,122,77,0.22), transparent 60%),
        rgba(18,12,9,0.55);
      box-shadow: var(--shadow);
      position: relative;
      top: 0;
      z-index: 1;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .left{
      display:flex;
      align-items:center;
      gap:16px;
      min-width: 220px;
    }

    .userBadge{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 2px 8px 2px 2px;
      border-radius: 999px;
    }

    .avatar{
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display:grid;
      place-items:center;
      background:
        radial-gradient(60% 60% at 40% 35%, rgba(231,210,170,0.18), transparent 70%),
        linear-gradient(160deg, rgba(36,29,26,0.9), rgba(10,7,6,0.9));
      border: 1px solid rgba(239,230,214,0.2);
    }

    .avatar svg{
      width: 22px;
      height: 22px;
      opacity: 0.85;
      fill: var(--app-ink);
    }

    .userMeta{
      display:flex;
      flex-direction:column;
      line-height: 1.1;
    }

    .userName{
      font-size: 14px;
      font-weight: 700;
      color: var(--gold-3);
      letter-spacing: 0.2px;
    }

    .userAddr{
      font-size: 12px;
      color: var(--app-muted);
      font-variant-numeric: tabular-nums;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:14px;
    }

    /* Bigger icon, NO square around it */
    .logo{
      width: 108px;
      height: 108px;
      object-fit: contain;
      border: none;
      border-radius: 0;
      background: transparent;
      box-shadow: none;
      filter: drop-shadow(0 12px 20px rgba(0,0,0,0.45));
      -webkit-user-drag: none;
      user-select:none;
    }

    .brandTitle h1{
      margin:0;
      font-family: "Georgia", "Times New Roman", serif;
      font-weight: 800;
      letter-spacing: 0.2px;
      font-size: 30px;
      color: var(--gold-3);
      text-shadow: 0 10px 26px rgba(0,0,0,0.55);
      line-height: 1;
      white-space: normal;
    }

    .right{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }

    .profileMenu{
      position: relative;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .profileMenu::after{
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      height: 10px;
    }
    .profileNotify{
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 1px solid rgba(225,194,138,0.75);
      background: rgba(148,39,39,0.95);
      color: #fbe9c6;
      display:grid;
      place-items:center;
      box-shadow: 0 8px 16px rgba(0,0,0,0.45);
      z-index: 24;
      pointer-events: auto;
      cursor: help;
    }
    .profileNotify svg{
      width: 11px;
      height: 11px;
      fill: currentColor;
    }
    .profileNotifyTip{
      position: absolute;
      right: 0;
      bottom: calc(100% + 8px);
      display: none;
      min-width: 190px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(18,12,9,0.96);
      color: rgba(232,210,184,0.92);
      font-size: 12px;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 10px 20px rgba(0,0,0,0.45);
      z-index: 26;
      pointer-events: none;
    }
    .profileNotify:hover + .profileNotifyTip,
    .profileNotify:focus-visible + .profileNotifyTip{
      display:block;
    }

    .profileBtn{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 4px;
      border-radius: 999px;
      border: 1px solid rgba(239,230,214,0.14);
      background: rgba(10,7,6,0.45);
      box-shadow: 0 10px 24px rgba(0,0,0,0.35);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      cursor: pointer;
      transition: 160ms ease;
    }

    .profileBtn:hover,
    .profileBtn:focus-visible{
      border-color: rgba(231,210,170,0.45);
      background: rgba(18,12,10,0.7);
      box-shadow: 0 12px 28px rgba(0,0,0,0.45);
      transform: translateY(-1px);
    }

    .profilePanel{
      position: absolute;
      right: 0;
      top: calc(100% + 8px);
      min-width: 220px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(239,230,214,0.14);
      background: rgba(10,7,6,0.75);
      box-shadow: 0 14px 28px rgba(0,0,0,0.45);
      display:none;
      z-index: 20;
    }

    .profileBtn:hover ~ .profilePanel,
    .profileBtn:focus-visible ~ .profilePanel,
    .profileMenu:hover .profilePanel,
    .profilePanel:hover,
    .profileMenu:focus-within .profilePanel{
      display:block;
    }

    .profilePanel .pill{
      background: transparent;
      border: none;
      padding: 6px 0;
      border-radius: 0;
      box-shadow: none;
    }

    .tabs{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.55);
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,0.04),
        inset 0 -1px 0 rgba(0,0,0,0.6);
    }
    .tab{
      position: relative;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: rgba(232,210,184,0.8);
      font-family: "Georgia","Times New Roman",serif;
      font-weight: 650;
      letter-spacing: 0.2px;
      cursor: pointer;
      user-select: none;
      transition: 140ms ease;
    }
    .tab:hover{
      color: var(--gold-3);
      background: rgba(86,60,38,0.45);
      border-color: rgba(193,143,95,0.45);
    }
    .tab.active{
      color: var(--gold-3);
      background: rgba(104,73,45,0.65);
      border-color: rgba(209,164,110,0.6);
    }
    .tab.active::after{
      content:"";
      position:absolute;
      left: 14px;
      right: 14px;
      bottom: -8px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(225,194,138,0.95), transparent);
      box-shadow: 0 0 16px rgba(225,194,138,0.55);
      border-radius: 999px;
    }

    .profile{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(203,180,138,0.22);
      background: rgba(0,0,0,0.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
      white-space: nowrap;
    }
    .profile .pill{
      white-space: nowrap;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(203,180,138,0.18);
      background: rgba(203,180,138,0.08);
      font-size: 12px;
      color: rgba(239,230,214,0.78);
      font-family: ui-sans-serif, system-ui;
    }
    .profile .value{
      font-size: 13px;
      font-weight: 800;
      color: var(--gold-3);
      margin-left: 6px;
      letter-spacing: 0.2px;
    }
    .landTaxTrigger{
      appearance: none;
      border: 0;
      background: transparent;
      padding: 0;
      margin-left: 6px;
      font-size: 13px;
      font-weight: 800;
      color: var(--gold-3);
      letter-spacing: 0.2px;
      cursor: pointer;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    /* =========================
       Sub-tabs header inside pages
       ========================= */
    .page{ margin-top: 18px; display:none; }
    .page.active{ display:block; }

    .subTabs{
      margin-top: 14px;
      padding: 10px 12px;
      border-radius: var(--radius);
      border: 1px solid rgba(239,230,214,0.12);
      background:
        linear-gradient(180deg, rgba(231,210,170,0.08), rgba(0,0,0,0.20)),
        rgba(0,0,0,0.16);
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .subTabRow{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .subTab{
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: rgba(239,230,214,0.72);
      font-family: "Georgia","Times New Roman",serif;
      font-weight: 650;
      letter-spacing: 0.2px;
      cursor: pointer;
      position: relative;
      transition: 140ms ease;
      user-select:none;
    }
    .subTab:hover{
      background: rgba(203,180,138,0.08);
      border-color: rgba(203,180,138,0.18);
      color: var(--gold-3);
    }
    .subTab.active{
      color: var(--gold-3);
      background: rgba(203,180,138,0.10);
      border-color: rgba(203,180,138,0.24);
    }
    .subTab.active::after{
      content:"";
      position:absolute;
      left: 14px;
      right: 14px;
      bottom: -8px;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(231,210,170,0.95), transparent);
      box-shadow: 0 0 16px rgba(231,210,170,0.55);
      border-radius: 999px;
    }

    .filterBtn{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(203,180,138,0.22);
      background: rgba(0,0,0,0.20);
      color: rgba(239,230,214,0.85);
      font-family: ui-sans-serif, system-ui;
      font-weight: 650;
      cursor: pointer;
      transition: 140ms ease;
      white-space: nowrap;
    }
    .filterBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(231,210,170,0.28);
      background: rgba(203,180,138,0.08);
    }

    /* Controls (search) */
    .controls{
      margin-top: 14px;
      display:flex;
      gap: 12px;
      align-items:center;
      flex-wrap: wrap;
    }
    .search{
      flex: 1 1 520px;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-radius: 999px;
      border: 1px solid rgba(203,180,138,0.22);
      background: rgba(0,0,0,0.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .search svg{ flex: 0 0 auto; opacity: 0.9; color: rgba(239,230,214,0.75); }
    .search input{
      width:100%;
      border:0;
      outline:0;
      background: transparent;
      color: var(--app-ink);
      font-size: 15px;
    }
    .tinyPill{
      flex: 0 0 auto;
      padding: 10px 12px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.55);
      border-radius: 999px;
      color: rgba(232,210,184,0.78);
      font-size: 13px;
      white-space: nowrap;
    }
    .sortControl{
      flex: 0 0 auto;
      min-width: 220px;
      padding: 10px 34px 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.55);
      color: rgba(232,210,184,0.9);
      font-size: 13px;
      font-family: ui-sans-serif, system-ui;
      font-weight: 650;
      outline: none;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23e1c28a' stroke-width='1.8' fill='none' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 20px center;
    }

    /* Cards (reference layout) */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    .card{
      display:grid;
      grid-template-columns: 260px 1fr 160px;
      gap: 16px;
      padding: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(167,122,77,0.35);
      background:
        linear-gradient(180deg, rgba(120,86,56,0.22), rgba(10,7,5,0.55)),
        rgba(20,13,10,0.55);
      box-shadow: 0 18px 40px rgba(0,0,0,0.50);
      position: relative;
      overflow: visible;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(700px 220px at 15% 0%, rgba(171,125,79,0.22), transparent 55%);
      pointer-events:none;
    }

    .thumbWrap{
      border-radius: var(--radius-sm);
      border: 1px solid rgba(203,180,138,0.22);
      overflow:hidden;
      background: rgba(0,0,0,0.25);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.05);
    }
    .thumb{
      width:100%;
      height: 150px;
      object-fit: cover;
      display:block;
      filter: saturate(0.95) contrast(1.05);
    }

    .cardMain{
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 8px;
      position: relative;
      z-index: 1;
    }
    .title{
      margin:0;
      font-family: "Georgia","Times New Roman",serif;
      font-size: 30px;
      font-weight: 700;
      color: var(--gold-3);
      letter-spacing: 0.2px;
      text-shadow: 0 14px 30px rgba(0,0,0,0.55);
      line-height: 1.05;
    }
    .rev{
      font-family: ui-sans-serif, system-ui;
      font-weight: 800;
      font-size: 18px;
      color: rgba(239,230,214,0.92);
    }
    .rev .unit{
      font-weight: 700;
      color: rgba(239,230,214,0.65);
      font-size: 14px;
      margin-left: 6px;
    }

    .rowStats{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 14px;
      margin-top: 6px;
      padding-top: 10px;
      border-top: 1px solid rgba(203,180,138,0.18);
      color: rgba(239,230,214,0.78);
      font-size: 13px;
    }
    .rowStats .k{ color: rgba(239,230,214,0.62); margin-right: 10px; }
    .rowStats .v{ color: rgba(239,230,214,0.92); font-weight: 750; letter-spacing: 0.2px; }

    .cardAction{
      display:flex;
      align-items:center;
      justify-content:center;
      position: relative;
      z-index: 1;
    }
    .viewBtn{
      width: 140px;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(203,180,138,0.35);
      background: linear-gradient(180deg, rgba(239,230,214,0.78), rgba(203,180,138,0.70));
      color: #2a1d16;
      font-family: "Georgia","Times New Roman",serif;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 14px 28px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.5);
      transition: 140ms ease;
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 10px;
    }
    .viewBtn:hover{ transform: translateY(-1px); }
    .cloneBtnUnavailable{
      position: relative;
      background: transparent;
      color: rgba(232,210,184,0.9);
      border: 1px solid rgba(203,180,138,0.45);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
      cursor: not-allowed;
    }
    .cloneBtnUnavailable:hover{
      transform: none;
      background: rgba(20,13,10,0.45);
      border-color: rgba(231,210,170,0.6);
    }
    .cloneBtnUnavailable:hover::after{
      content: attr(data-tip);
      position: absolute;
      left: 50%;
      bottom: calc(100% + 8px);
      transform: translateX(-50%);
      min-width: 260px;
      max-width: min(320px, calc(100vw - 40px));
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(18,12,9,0.95);
      color: rgba(232,210,184,0.92);
      font-size: 12px;
      font-weight: 600;
      font-family: ui-sans-serif, system-ui;
      line-height: 1.35;
      text-align: center;
      white-space: normal;
      box-shadow: 0 10px 20px rgba(0,0,0,0.45);
      z-index: 25;
      pointer-events: none;
    }

    /* Map panel */
    .mapPanel{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(167,122,77,0.35);
      overflow: hidden;
      background: rgba(20,13,10,0.6);
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
    }
    .mapHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px;
      background: linear-gradient(180deg, rgba(120,86,56,0.24), rgba(10,7,5,0.55));
      border-bottom: 1px solid rgba(167,122,77,0.28);
      color: rgba(232,210,184,0.8);
      font-size: 13px;
    }
    .mapHeaderTools{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .mapEditBtn{
      height: 28px;
      border-radius: 8px;
      border: 1px solid rgba(167,122,77,0.45);
      background: rgba(24,16,12,0.74);
      color: rgba(232,210,184,0.92);
      padding: 0 10px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    .mapEditBtn.active{
      border-color: rgba(126, 215, 151, 0.75);
      color: rgba(206, 255, 219, 0.95);
      background: rgba(24, 68, 40, 0.55);
    }
    .mapEditBtn:disabled{
      opacity: 0.6;
      cursor: not-allowed;
    }
    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(24,16,12,0.6);
      color: var(--gold-3);
      font-weight: 800;
      font-size: 12px;
      font-family: ui-sans-serif, system-ui;
      letter-spacing: 0.2px;
    }
    .mapDataNotice{
      padding: 8px 12px;
      border-bottom: 1px solid rgba(167,122,77,0.24);
      background: rgba(95,34,34,0.45);
      color: rgba(255,229,221,0.9);
      font-size: 12px;
      line-height: 1.35;
      text-align: center;
    }
    .mapFrame,
    #map{
      width: 100%;
      height: min(520px, 65vh);
      border: 0;
      display: block;
      filter: saturate(0.95) contrast(1.05);
    }
    .mapSurface{
      position: relative;
      width: 100%;
      height: min(520px, 65vh);
    }
    .mapSurface #map{
      width: 100%;
      height: 100%;
    }
    .parcelEditOverlay{
      position: absolute;
      inset: 0;
      z-index: 1800;
      pointer-events: none;
      display: none;
    }
    .parcelGuideOverlay{
      position: absolute;
      inset: 0;
      z-index: 1700;
      pointer-events: none;
      display: block;
    }
    .parcelEditOverlay.active{
      display: block;
      pointer-events: auto;
      background: rgba(20,13,10,0.1);
    }
    .parcelHandle{
      position: absolute;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      transform: translate(-50%, -50%);
      border: 2px solid rgba(255,233,198,0.92);
      background: rgba(24,16,12,0.86);
      color: rgba(255,233,198,0.94);
      font-size: 11px;
      font-weight: 800;
      display: grid;
      place-items: center;
      cursor: grab;
      user-select: none;
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }
    .parcelHandle.owned{
      border-color: rgba(180, 255, 194, 0.95);
      background: rgba(28, 84, 42, 0.88);
      color: rgba(227, 255, 235, 0.95);
    }
    .parcelHandle.vacant{
      border-color: rgba(215, 227, 237, 0.95);
      background: rgba(43, 60, 74, 0.9);
      color: rgba(235, 243, 249, 0.95);
    }
    .parcelHandle:active{
      cursor: grabbing;
    }
    .parcelGuideLine{
      position: absolute;
      pointer-events: none;
      opacity: 0.72;
      z-index: 0;
    }
    .parcelGuideLine.h{
      height: 0;
      border-top: 3px solid rgba(225, 48, 48, 0.9);
    }
    .parcelGuideLine.v{
      width: 0;
      border-left: 3px solid rgba(225, 48, 48, 0.9);
    }
    .parcelGuideLabel{
      position: absolute;
      pointer-events: none;
      z-index: 1;
      transform: translate(-50%, -50%);
      padding: 2px 5px;
      border-radius: 6px;
      border: 1px solid rgba(167,122,77,0.4);
      background: rgba(24,16,12,0.78);
      color: rgba(246,232,214,0.95);
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.01em;
      white-space: nowrap;
    }
    .parcelCoordPanel{
      position: absolute;
      right: 12px;
      bottom: 12px;
      z-index: 1850;
      min-width: 200px;
      max-width: min(46vw, 320px);
      max-height: 42%;
      overflow: auto;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.42);
      background: rgba(19, 12, 9, 0.88);
      box-shadow: 0 8px 22px rgba(0,0,0,0.38);
      padding: 8px 10px;
      font-size: 11px;
      line-height: 1.45;
      color: rgba(241,224,200,0.92);
      backdrop-filter: blur(2px);
    }
    .parcelCoordPanel strong{
      display: block;
      font-size: 11px;
      letter-spacing: 0.02em;
      color: rgba(247,233,213,0.96);
      margin-bottom: 6px;
    }
    .parcelCoordRow{
      display: flex;
      justify-content: space-between;
      gap: 10px;
      font-variant-numeric: tabular-nums;
      white-space: nowrap;
      color: rgba(233,212,185,0.9);
    }
    .leaflet-container{
      background: #14100d;
    }
    .mapStoreMarker{
      position: relative;
      width: 20px;
      height: 20px;
      pointer-events: auto;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
      z-index: 1;
    }
    .mapStoreMarker.idleFloat{
      animation: mapParcelIdleFloat 2.4s ease-in-out infinite;
    }
    .mapModeDeveloper .mapSurface .mapStoreMarker.idleFloat{
      animation: none;
    }
    .mapModeProduction .mapStoreMarker.prodHoverable:hover{
      z-index: 3;
    }
    .mapModeProduction .mapStoreMarker.prodHoverable:hover .mapStoreDiamond{
      transform: rotate(45deg) scale(1.18);
      filter: brightness(1.08);
      box-shadow: 0 0 0 1px rgba(255,226,188,0.44), 0 10px 24px rgba(0,0,0,0.5);
    }
    .mapModeProduction .mapStoreMarker.prodHoverable:hover .mapStorePanel{
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .mapStoreMarker.idleFloat:hover{
      animation-play-state: paused;
    }
    @keyframes mapParcelIdleFloat{
      0%{ top: 0; }
      50%{ top: -2px; }
      100%{ top: 0; }
    }
    .mapStoreMarker:hover{
      z-index: 1200;
    }
    .mapStoreDiamond{
      position: absolute;
      inset: 0;
      background: rgba(168,126,76,0.34);
      border: 2px solid rgba(231,210,170,0.72);
      box-sizing: border-box;
      transform: rotate(45deg);
      transform-origin: center;
      opacity: 0.54;
      transition: transform 160ms ease, opacity 160ms ease, box-shadow 160ms ease, background 160ms ease;
      box-shadow: 0 12px 24px rgba(0,0,0,0.28);
      backdrop-filter: blur(1px);
    }
    .mapStoreMarker.owned .mapStoreDiamond{
      background: rgba(94, 162, 109, 0.44);
      border-color: rgba(193, 255, 206, 0.86);
      box-shadow: 0 12px 24px rgba(36,88,48,0.34);
    }
    .mapStoreMarker.vacant .mapStoreDiamond{
      background: rgba(126, 146, 162, 0.34);
      border-color: rgba(204, 219, 231, 0.9);
      border-style: dashed;
      box-shadow: 0 12px 24px rgba(34,48,60,0.34);
    }
    .mapStoreMarker.reserved .mapStoreDiamond{
      background: rgba(248, 244, 240, 0.66);
      border-color: rgba(255, 246, 238, 0.86);
      border-style: solid;
      box-shadow: 0 12px 24px rgba(96,40,40,0.34);
      opacity: 0.88;
    }
    .mapStoreVacantOutline{
      position: absolute;
      inset: -2px;
      border: 2px dotted rgba(228, 239, 247, 0.95);
      border-radius: 2px;
      pointer-events: none;
      opacity: 0.78;
      z-index: 0;
      transform: rotate(45deg);
      transform-origin: center;
      transition: opacity 140ms ease, transform 140ms ease;
    }
    .mapStoreMarker.vacant:hover .mapStoreVacantOutline{
      opacity: 0.98;
      transform: rotate(45deg) scale(1.02);
    }
    .mapStoreMarker.reserved .mapStoreVacantOutline{
      border-color: rgba(255, 186, 186, 0.92);
      opacity: 0.88;
    }
    .mapStoreMarker.reserved:hover .mapStoreVacantOutline{
      opacity: 0.88;
      transform: rotate(45deg);
    }
    .mapStoreLabel{
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f8ecd8;
      font-weight: 900;
      font-size: 10px;
      line-height: 1;
      text-shadow: 0 2px 8px rgba(0,0,0,0.55);
      pointer-events: none;
    }
    .mapStoreStatusIcon{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 14px;
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(255,233,198,0.8);
      background: rgba(20,13,10,0.86);
      display: grid;
      place-items: center;
      pointer-events: none;
      z-index: 2;
    }
    .mapStoreStatusIcon svg{
      width: 9px;
      height: 9px;
      fill: rgba(231,210,170,0.96);
    }
    .mapStoreStatusIcon.star{
      border-color: rgba(190,255,208,0.82);
      background: rgba(29,76,40,0.96);
      box-shadow: 0 6px 12px rgba(36,88,48,0.34);
    }
    .mapStoreStatusIcon.star svg{
      fill: rgba(221,255,231,0.95);
    }
    .mapStoreStatusIcon.nature{
      border-color: rgba(164, 225, 176, 0.88);
      background: rgba(24, 74, 39, 0.96);
      box-shadow: 0 6px 12px rgba(24, 74, 39, 0.36);
    }
    .mapStoreStatusIcon.nature svg{
      fill: rgba(213, 255, 224, 0.96);
    }
    .mapStoreOwnerBadge{
      position: absolute;
      top: -8px;
      right: -8px;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid rgba(190,255,208,0.82);
      background: rgba(29,76,40,0.96);
      box-shadow: 0 6px 12px rgba(0,0,0,0.35);
      color: rgba(221,255,231,0.95);
      display: grid;
      place-items: center;
      pointer-events: none;
      z-index: 3;
    }
    .mapStoreOwnerBadge svg{
      width: 9px;
      height: 9px;
      fill: currentColor;
    }
    .mapStoreForSaleIcon{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 1px solid rgba(255,232,189,0.85);
      background: rgba(154, 101, 41, 0.98);
      color: rgba(255,243,220,0.96);
      box-shadow: 0 6px 12px rgba(0,0,0,0.35);
      pointer-events: none;
      display: grid;
      place-items: center;
    }
    .mapStoreForSaleIcon svg{
      width: 10px;
      height: 10px;
      fill: currentColor;
    }
    .mapStorePanel{
      position: absolute;
      left: 50%;
      bottom: 36px;
      transform: translate(-50%, 6px);
      min-width: 206px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.42);
      background: rgba(20,13,10,0.94);
      color: rgba(232,210,184,0.92);
      font-size: 11px;
      line-height: 1.35;
      box-shadow: 0 14px 24px rgba(0,0,0,0.45);
      opacity: 0;
      pointer-events: none;
      transition: opacity 140ms ease, transform 140ms ease;
      white-space: nowrap;
      z-index: 2000;
    }
    .mapStorePanelTitle{
      color: var(--gold-3);
      font-weight: 800;
      margin-bottom: 3px;
    }
    .mapStoreMarker:hover .mapStoreDiamond{
      opacity: 0.92;
      background: rgba(191,146,92,0.62);
      transform: rotate(45deg) scale(1.18);
      box-shadow: 0 20px 32px rgba(0,0,0,0.42);
    }
    .mapStoreMarker.owned:hover .mapStoreDiamond{
      background: rgba(106,182,123,0.74);
    }
    .mapStoreMarker.vacant:hover .mapStoreDiamond{
      background: rgba(145,168,186,0.62);
    }
    .mapStoreMarker.reserved:hover .mapStoreDiamond{
      background: rgba(198, 84, 84, 0.68);
      opacity: 0.96;
    }
    .mapStoreMarker:hover .mapStorePanel{
      opacity: 1;
      transform: translate(-50%, -4px);
    }
    .mapStoreMarker[data-parcel-number="18"] .mapStorePanel{
      top: calc(100% + 4px);
      bottom: auto;
      transform: translate(-50%, 0);
    }
    .mapStoreMarker[data-parcel-number="18"]:hover .mapStorePanel{
      transform: translate(-50%, 0);
    }
    .mapStoreMarker[data-parcel-number="19"] .mapStorePanel{
      top: auto;
      bottom: calc(100% + 4px);
      transform: translate(-50%, 0);
    }
    .mapStoreMarker[data-parcel-number="19"]:hover .mapStorePanel{
      transform: translate(-50%, 0);
    }
    .mapUnitScale{
      position: absolute;
      left: 12px;
      bottom: 12px;
      z-index: 60;
      pointer-events: none;
      background: rgba(20,13,10,0.82);
      border: 1px solid rgba(167,122,77,0.45);
      border-radius: 8px;
      padding: 6px 8px;
      color: rgba(232,210,184,0.92);
      font-size: 11px;
      line-height: 1.2;
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
    }
    .mapUnitScaleBar{
      position: relative;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(231,210,170,0.95), rgba(167,122,77,0.95));
      margin-top: 5px;
      min-width: 24px;
    }
    .mapUnitTick{
      position: absolute;
      top: -4px;
      width: 2px;
      height: 14px;
      background: rgba(255, 248, 233, 0.95);
      box-shadow: 0 0 6px rgba(255, 240, 205, 0.45);
      transform: translateX(-1px);
    }
    .mapUnitTickLabel{
      position: absolute;
      top: -16px;
      transform: translateX(-50%);
      font-size: 10px;
      color: rgba(248,232,203,0.92);
      white-space: nowrap;
      line-height: 1;
    }
    .mapUnitScaleSub{
      margin-top: 4px;
      font-size: 10px;
      color: rgba(232,210,184,0.74);
    }

    /* Manage: single business page */
    .businessPage{
      margin-top: 14px;
      border-radius: var(--radius);
      border: 1px solid rgba(167,122,77,0.35);
      background: linear-gradient(180deg, rgba(120,86,56,0.22), rgba(10,7,5,0.55)), rgba(20,13,10,0.55);
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
      overflow:hidden;
    }
    .businessHero{
      display:grid;
      grid-template-columns: 1.3fr 1fr;
      gap: 14px;
      padding: 14px;
      border-bottom: 1px solid rgba(167,122,77,0.28);
    }
    .heroImg{
      border-radius: var(--radius-sm);
      border: 1px solid rgba(167,122,77,0.35);
      overflow:hidden;
      background: rgba(18,12,9,0.6);
      aspect-ratio: 4 / 3;
    }
    .heroImg img{
      width:100%;
      height: 100%;
      object-fit: cover;
      object-position: center 20%;
      display:block;
      filter: none;
    }
    .heroInfo{
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 10px;
      padding: 4px 2px;
    }
    .heroInfo h2{
      margin:0;
      font-family: "Georgia","Times New Roman",serif;
      font-size: 42px;
      color: var(--gold-3);
      text-shadow: 0 16px 34px rgba(0,0,0,0.55);
      line-height: 1.05;
    }
    .heroMeta{
      color: rgba(232,210,184,0.8);
      font-size: 14px;
    }
    .heroBadges{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 2px;
    }
    .teamList{
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 8px 10px;
    }
    .teamTitle{
      margin-top: 12px;
      font-size: 12px;
      letter-spacing: 0.3px;
      text-transform: uppercase;
      color: rgba(232,210,184,0.65);
      font-weight: 700;
    }
    .branches{
      margin-top: 14px;
      margin-left: 14px;
      margin-right: 14px;
      padding: 14px 24px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(203,180,138,0.18);
      background: rgba(0,0,0,0.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .branchesTitle{
      margin: 0 0 10px;
      font-size: 12px;
      color: rgba(232,210,184,0.7);
      text-transform: uppercase;
      letter-spacing: 0.4px;
      font-weight: 700;
    }
    .branchList{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      padding: 0;
    }
    .branchItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.22);
      background: rgba(18,12,9,0.55);
      color: rgba(232,210,184,0.85);
      font-size: 12px;
      font-variant-numeric: tabular-nums;
      position: relative;
      overflow: hidden;
    }
    .branchLeft{
      display:flex;
      align-items:center;
      gap: 8px;
      min-width: 0;
      overflow: hidden;
    }
    .storeIcon{
      width: 18px;
      height: 18px;
      border-radius: 6px;
      display:grid;
      place-items:center;
      background: rgba(18,12,9,0.7);
      border: 1px solid rgba(231,210,170,0.35);
      flex: 0 0 auto;
    }
    .storeIcon svg{
      width: 12px;
      height: 12px;
      fill: var(--gold-3);
      opacity: 0.85;
    }
    .branchAddr{
      white-space: nowrap;
    }
    .branchRoyalty{
      color: var(--gold-3);
      font-weight: 700;
      min-width: 44px;
      text-align: right;
    }
    .branchActions{
      display:flex;
      align-items:center;
      position: relative;
      z-index: 2;
      flex: 0 0 auto;
    }
    .forceForkBtn{
      position: absolute;
      inset: 0;
      border-radius: 10px;
      border: 1px solid rgba(219,98,98,0.85);
      background: linear-gradient(180deg, rgba(188,51,51,0.62), rgba(115,28,28,0.68));
      color: #ffe8e1;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: 0.2px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transform: translateY(6px);
      transition: 140ms ease;
      white-space: nowrap;
      z-index: 4;
      box-shadow: 0 10px 18px rgba(0,0,0,0.45);
    }
    .forceForkBtn:hover,
    .forceForkBtn:focus-visible{
      border-color: rgba(255,210,210,0.98);
      background: linear-gradient(180deg, rgba(214,69,69,0.78), rgba(138,34,34,0.84));
      color: #fff8f4;
    }
    .branchItem:hover .forceForkBtn,
    .branchItem:focus-within .forceForkBtn{
      opacity: 1;
      pointer-events: auto;
      transform: translateY(0);
    }
    .forceForkBtn.forced{
      border-color: rgba(255,188,188,0.92);
      background: linear-gradient(180deg, rgba(206,74,74,0.72), rgba(122,31,31,0.78));
      color: #fff3ef;
    }
    .branchItem.forkPending .forceForkBtn{
      display: none;
      opacity: 0;
      pointer-events: none;
    }
    .forkTimerBtn{
      position: absolute;
      top: 4px;
      right: 6px;
      z-index: 5;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(231,210,170,0.38);
      background: rgba(10,7,6,0.82);
      color: rgba(245,228,198,0.95);
      font-size: 10px;
      font-weight: 700;
      line-height: 1;
      cursor: pointer;
      white-space: nowrap;
      backdrop-filter: blur(2px);
    }
    .forkTimerBtn:hover,
    .forkTimerBtn:focus-visible{
      border-color: rgba(255,215,198,0.92);
      background: rgba(34,12,10,0.92);
      color: rgba(255,235,210,0.98);
    }
    .forkTimerBtn:hover .forkTimerText,
    .forkTimerBtn:focus-visible .forkTimerText{
      display: none;
    }
    .forkTimerBtn:hover::after,
    .forkTimerBtn:focus-visible::after{
      content: "Revert";
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .forkTimerIcon{
      width: 10px;
      height: 10px;
      display: inline-block;
      opacity: 0.9;
      flex: 0 0 auto;
    }
    .forkTimerIcon svg{
      width: 10px;
      height: 10px;
      fill: currentColor;
      display: block;
    }
    .branchRequests{
      margin-top: 12px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.28);
      background: rgba(18,12,9,0.55);
      position: relative;
      z-index: 3;
    }
    .branchReqHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      color: rgba(232,210,184,0.9);
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .branchReqCount{
      min-width: 44px;
      height: 24px;
      padding: 0 9px;
      border-radius: 999px;
      border: 1px solid rgba(245,206,143,0.75);
      background: radial-gradient(circle at 30% 30%, rgba(250,126,126,0.95), rgba(146,30,30,0.95));
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 5px;
      color: #fff1d5;
      font-size: 12px;
      font-weight: 900;
      box-shadow: 0 0 0 2px rgba(18,12,9,0.5), 0 8px 16px rgba(0,0,0,0.45);
    }
    .branchReqCount.isZero{
      border-color: rgba(167,122,77,0.45);
      background: rgba(34,23,17,0.85);
      color: rgba(232,210,184,0.82);
      box-shadow: 0 0 0 1px rgba(18,12,9,0.35);
    }
    .branchReqCount svg{
      width: 10px;
      height: 10px;
      fill: currentColor;
      opacity: 0.95;
    }
    .branchReqRule{
      margin: 8px 0 0;
      color: rgba(232,210,184,0.75);
      font-size: 12px;
    }
    .branchReqList{
      position: absolute;
      left: 0;
      right: 0;
      top: 100%;
      margin-top: 0;
      display:none;
      gap: 6px;
      flex-direction: column;
      z-index: 35;
      pointer-events: auto;
      padding: 8px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.34);
      background: rgba(14,9,7,0.96);
      box-shadow: 0 12px 24px rgba(0,0,0,0.5);
    }
    .branchRequests:hover .branchReqList,
    .branchReqList:hover{
      display:flex;
    }
    .branchReqItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 7px 8px;
      border-radius: 8px;
      border: 1px solid rgba(167,122,77,0.24);
      background: rgba(20,13,10,0.92);
      color: rgba(232,210,184,0.85);
      font-size: 12px;
      font-variant-numeric: tabular-nums;
    }
    .branchReqPct{
      color: var(--gold-3);
      font-weight: 700;
    }
    .branchReqMeta{
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .branchAcceptBtn{
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(167,122,77,0.32);
      background: rgba(20,13,10,0.45);
      color: rgba(232,210,184,0.68);
      font-size: 11px;
      font-weight: 700;
      cursor: pointer;
      opacity: 0.92;
      transition: 140ms ease;
    }
    .branchAcceptBtn:hover,
    .branchAcceptBtn:focus-visible{
      border-color: rgba(225,194,138,0.72);
      background: rgba(48,31,22,0.82);
      color: rgba(244,229,201,0.98);
    }
    .branchAcceptBtn:disabled{
      cursor: not-allowed;
      opacity: 0.6;
      pointer-events: none;
    }
    .branchReqEmpty{
      justify-content: center;
      color: rgba(232,210,184,0.7);
      font-style: italic;
    }
    .teamMember{
      display:grid;
      align-items:center;
      grid-template-columns: auto 1fr auto;
      column-gap: 10px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.28);
      background: rgba(20,13,10,0.55);
      color: rgba(232,210,184,0.85);
      font-size: 12px;
      font-variant-numeric: tabular-nums;
    }
    .teamMember.highlight{
      border-color: rgba(225,194,138,0.75);
      box-shadow: 0 0 0 1px rgba(225,194,138,0.25);
    }
    .teamInfo{
      display:flex;
      align-items:center;
      gap:8px;
      min-width: 0;
      overflow: hidden;
    }
    .teamInfo span:last-child{
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .teamPct{
      color: var(--gold-3);
      font-weight: 700;
      letter-spacing: 0.2px;
      min-width: 44px;
      text-align: right;
      justify-self: end;
    }
    .anonIcon{
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display:grid;
      place-items:center;
      background: rgba(18,12,9,0.7);
      border: 1px solid rgba(231,210,170,0.35);
      flex: 0 0 auto;
      position: relative;
      overflow: visible;
    }
    .anonIcon svg{
      width: 12px;
      height: 12px;
      fill: var(--gold-3);
      opacity: 0.85;
    }
    .teamMember.highlight{
      position: relative;
    }
    .teamMember.highlight::after{
      content:"";
      position:absolute;
      top: -8px;
      right: -8px;
      width: 16px;
      height: 16px;
      background: rgba(225,194,138,0.98);
      border: 1px solid rgba(42,27,18,0.85);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.55);
      z-index: 3;
      pointer-events: none;
    }
    .teamMember.highlight::before{
      content:"";
      position:absolute;
      top: -4px;
      right: -4px;
      width: 10px;
      height: 10px;
      z-index: 4;
      background: #2a1b12;
      -webkit-mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M3 18h18l-2-10-5 5-2-7-2 7-5-5-2 10Zm4 2h10v2H7v-2Z'/></svg>") no-repeat center / contain;
      mask: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M3 18h18l-2-10-5 5-2-7-2 7-5-5-2 10Zm4 2h10v2H7v-2Z'/></svg>") no-repeat center / contain;
      pointer-events: none;
    }

    .heroStats{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap: 12px;
      padding: 14px;
    }
    .stat{
      padding: 12px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(203,180,138,0.18);
      background: rgba(0,0,0,0.18);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.04);
    }
    .stat .label{
      color: rgba(239,230,214,0.62);
      font-size: 12px;
      margin-bottom: 6px;
    }
    .stat .value{
      font-size: 18px;
      font-weight: 850;
      letter-spacing: 0.2px;
      color: rgba(239,230,214,0.92);
    }

    .businessBody{
      padding: 0 14px 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .panel{
      padding: 14px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(203,180,138,0.18);
      background: rgba(0,0,0,0.16);
    }
    .panel h3{
      margin:0 0 10px;
      font-family: "Georgia","Times New Roman",serif;
      color: var(--gold-3);
      letter-spacing: 0.2px;
      font-size: 20px;
    }
    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 10px;
    }
    .panelHeader h3{
      margin:0;
    }
    .ruleDate{
      margin-left: 8px;
      font-size: 12px;
      font-family: ui-sans-serif, system-ui;
      font-weight: 600;
      color: rgba(232,210,184,0.7);
      letter-spacing: 0;
      white-space: nowrap;
    }
    .createTaskBtn{
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.55);
      color: var(--gold-3);
      font-family: "Georgia","Times New Roman",serif;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: 140ms ease;
    }
    .createTaskBtn:hover{
      background: rgba(92,64,40,0.5);
      border-color: rgba(225,194,138,0.55);
      transform: translateY(-1px);
    }

    .proposalModal{
      position: fixed;
      inset: 0;
      background: rgba(7,5,4,0.72);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1200;
      padding: 16px;
    }
    .proposalModal.open{
      display: flex;
    }
    .proposalCard{
      width: min(620px, 96vw);
      border-radius: 14px;
      border: 1px solid rgba(167,122,77,0.38);
      background: rgba(18,12,9,0.98);
      box-shadow: 0 24px 48px rgba(0,0,0,0.6);
      padding: 16px;
    }
    .proposalCard h3{
      margin: 0 0 10px;
      color: var(--gold-3);
      font-family: "Georgia","Times New Roman",serif;
      font-size: 20px;
    }
    .proposalCard p{
      margin: 0;
      color: rgba(232,210,184,0.84);
      font-size: 13px;
      line-height: 1.45;
    }
    .proposalInput{
      width: 100%;
      min-height: 128px;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.8);
      color: rgba(239,230,214,0.94);
      font-size: 14px;
      resize: vertical;
      outline: none;
      font-family: ui-sans-serif, system-ui;
    }
    .proposalInput:focus{
      border-color: rgba(225,194,138,0.6);
      box-shadow: 0 0 0 2px rgba(225,194,138,0.18);
    }
    .proposalActions{
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .proposalActionsLeft{
      justify-content: flex-start;
    }
    .proposalBtn{
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid rgba(167,122,77,0.35);
      background: rgba(20,13,10,0.55);
      color: rgba(239,230,214,0.92);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
    }
    .proposalBtn.primary{
      color: var(--gold-3);
      border-color: rgba(225,194,138,0.6);
      background: linear-gradient(180deg, rgba(120,86,56,0.42), rgba(35,23,17,0.85));
    }
    .proposalBtn:hover{
      transform: translateY(-1px);
    }
    .proposalStage[hidden]{
      display: none;
    }
    .proposalLoading{
      display: grid;
      justify-items: center;
      gap: 10px;
      padding: 18px 10px;
    }
    .proposalSpinner{
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: 3px solid rgba(225,194,138,0.2);
      border-top-color: rgba(225,194,138,0.95);
      animation: proposalSpin 0.9s linear infinite;
    }
    @keyframes proposalSpin{
      to { transform: rotate(360deg); }
    }
    .proposalRiskList{
      margin: 12px 0 0;
      padding-left: 18px;
      color: rgba(239,230,214,0.86);
      line-height: 1.6;
      font-size: 14px;
    }
    .proposalLoss{
      margin-top: 12px;
      color: var(--gold-3);
      font-size: 14px;
      font-weight: 800;
    }
    .landSalesChart{
      margin-top: 10px;
      border: 1px solid rgba(167,122,77,0.28);
      border-radius: 10px;
      background: rgba(20,13,10,0.72);
      padding: 8px;
    }
    .landSalesChart svg{
      width: 100%;
      height: auto;
      display: block;
    }
    .landChartAxis{
      stroke: rgba(167,122,77,0.72);
      stroke-width: 1;
    }
    .landChartGrid{
      stroke: rgba(167,122,77,0.24);
      stroke-width: 1;
    }
    .landChartLine{
      fill: none;
      stroke: rgba(225,194,138,0.96);
      stroke-width: 2;
    }
    .landChartPoint{
      fill: rgba(225,194,138,0.98);
      stroke: rgba(20,13,10,0.92);
      stroke-width: 1;
    }
    .landChartLabel{
      fill: rgba(232,210,184,0.84);
      font-size: 10px;
    }
    .list{
      margin:0;
      padding-left: 18px;
      color: rgba(239,230,214,0.78);
      line-height: 1.6;
      font-size: 14px;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(203,180,138,0.14);
      color: rgba(239,230,214,0.78);
      font-size: 14px;
    }
    .kv:last-child{ border-bottom:0; }
    .kv b{ color: rgba(239,230,214,0.92); font-weight: 800; }

    @media (max-width: 920px){
      .card{ grid-template-columns: 220px 1fr; }
      .cardAction{ grid-column: 1 / -1; justify-content:flex-end; }
      .businessHero{ grid-template-columns: 1fr; }
      .heroImg img{ height: auto; }
      .heroStats{ grid-template-columns: 1fr; }
      .businessBody{ grid-template-columns: 1fr; }
    }
    @media (max-width: 620px){
      .topbar{
        flex-direction: column;
        align-items: stretch;
        padding: 0 14px 4px;
      }
      .left{
        width: 100%;
        min-width: 0;
        justify-content: center;
        padding-left: 0;
        margin-top: 0;
        position: relative;
      }
      .right{
        width: 100%;
        flex-direction: column;
        align-items: stretch;
      }
      .tabs{
        width:100%;
        justify-content:space-between;
        gap: 6px;
      }
      .tab{
        flex: 1 1 0;
        text-align: center;
        padding: 8px 6px;
        font-size: 12px;
        white-space: nowrap;
      }
      .profileMenu{
        position: absolute;
        top: 12px;
        right: 12px;
        z-index: 12;
      }
      .profile{ width:100%; justify-content:space-between; }
      .userAddr{ font-size: 0; }
      .userAddr::before{ content: "0x...9c"; font-size: 12px; margin-left: 10px; display: inline-block; }
      .userMeta{ max-width: 56px; }
      .userName{ font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .brand{
        min-width: unset;
        flex-direction: column;
        align-items: center;
        gap: 2px;
      }
      .brandTitle{
        position: static;
        margin: 0;
        text-align: center;
      }
      .card{ grid-template-columns: 1fr; }
      .thumb{ height: 190px; }
      .cardAction{ justify-content:flex-start; }
      .logo{ width: 64px; height: 64px; }
      .brandTitle h1{ font-size: 14px; }
    }
  </style>
</head>

<body>
  <!-- INTRO (kept the same) -->
  <div class="intro" id="intro" aria-hidden="true">
    <div class="introStage">
      <img id="introTree" class="introTree" src="images/spring.png" alt="" />
      <p id="introLine1" class="introLine1 jp"></p>
      <p id="introLine2" class="introLine2 jp"></p>
    </div>
  </div>

  <div class="wrap">
    <div class="headerStack">
      <div class="legalBanner">
        This application is a mock example. By using this app, you agree to the legal disclaimer
        <a href="https://github.com/0xAgro/Branchism/blob/main/README.md" target="_blank" rel="noopener noreferrer">here</a>.
        You can also <a href="https://github.com/0xAgro/Branchism?tab=readme-ov-file#support" target="_blank" rel="noopener noreferrer">support active research</a> (Ethereum accepted).
        <button class="legalDismiss" type="button" aria-label="Dismiss legal notice">&times;</button>
      </div>

      <div class="deployBanner" aria-label="Emergency Facet Deployment status">
        <div class="deployHead">
          <span class="deployTitle">Emergency Facet Deployment</span>
          <span class="deployState">Not Enacted</span>
        </div>
        <div class="deployTrack" aria-hidden="true">
          <span class="deployFill"></span>
          <span class="deployMark"></span>
          <span class="deployMarkLabel">70%</span>
        </div>
      </div>

      <header class="topbar">
        <div class="left">
          <div class="brand">
            <img class="logo" id="headerLogo" src="images/spring.png" alt="Root logo" />
            <div class="brandTitle"><h1>Root</h1></div>
          </div>
        </div>

        <div class="right">
          <nav class="tabs" aria-label="Primary">
            <a class="tab active" href="explore.html" aria-current="page">Explore</a>
            <a class="tab" href="contract.html">Contract Work</a>
            <a class="tab" href="clone.html">Clone</a>
            <a class="tab" href="manage.html">Manage</a>
          </nav>

        <div class="profileMenu">
          <button class="profileBtn" type="button" aria-label="Profile menu">
            <div class="userBadge">
                <div class="avatar" aria-hidden="true">
                  <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
                    <path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/>
                  </svg>
                </div>
                <div class="userMeta">
                  <div class="userName"> </div>
                  <div class="userAddr">0x4f2a...9c1b</div>
              </div>
            </div>
          </button>
          <span class="profileNotify" aria-hidden="true">
            <svg viewBox="0 0 24 24"><path d="M12 22a2.8 2.8 0 0 0 2.7-2h-5.4A2.8 2.8 0 0 0 12 22Zm7-5H5c1-1 2-2.2 2-5v-1a5 5 0 1 1 10 0v1c0 2.8 1 4 2 5Z"/></svg>
          </span>
          <div class="profileNotifyTip">You have 4 branch requests</div>
          <div class="profilePanel" role="menu" aria-label="Wallet">
              <div class="profile">
                <div class="pill">Wallet <span class="value" id="walletValue">2.1621</span></div>
                <div class="pill">Debt Allowance <span class="value">1</span></div>
                <div class="pill">Land Tax / yr <button type="button" class="landTaxTrigger" id="landTaxTrigger">0.2345</button></div>
              </div>
            </div>
          </div>
        </div>
      </header>
    </div>

    <!-- ===================== PAGE: YOUR AREA ===================== -->
    <main class="page active" id="page-area" aria-label="Explore">
      <div class="panel" style="margin-bottom:12px;">
        <div class="kv" style="border-bottom:0; padding:6px 0; display:flex; align-items:center; gap:8px;">
          <span style="display:inline-flex; width:18px; height:18px; border-radius:999px; align-items:center; justify-content:center; background:rgba(170,28,28,0.95); border:1px solid rgba(255,195,195,0.5); color:#fff3dc; flex:0 0 auto;">
            <svg viewBox="0 0 24 24" width="11" height="11" aria-hidden="true"><path fill="currentColor" d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm0 15.4a1.2 1.2 0 1 1 1.2-1.2 1.2 1.2 0 0 1-1.2 1.2Zm1.1-4.3h-2.2V6.8h2.2Z"/></svg>
          </span>
          <span>This section is under development.</span>
          <b>Notice</b>
        </div>
      </div>
      <div class="mapPanel">
        <div class="mapHeader">
          <div style="display:flex; gap:10px; align-items:center;">
            <button class="badge" type="button">Chancellor District</button>
            <span>Map view (OpenStreetMap embed)</span>
          </div>
          <div class="mapHeaderTools">
            <span class="badge">Static</span>
            <button class="mapEditBtn" id="toggleParcelEdit" type="button">Edit Parcels</button>
            <select class="mapEditBtn" id="parcelTypeSelect" aria-label="Parcel type">
              <option value="business">Business</option>
              <option value="empty">Empty Land</option>
              <option value="forsale">Empty Land (For Sale)</option>
              <option value="reserved" selected>Reserved Land</option>
            </select>
            <button class="mapEditBtn" id="addParcelBtn" type="button">Add Parcel</button>
            <button class="mapEditBtn" id="saveParcelLayout" type="button">Save Layout</button>
            <button class="mapEditBtn" id="resetParcelLayout" type="button">Reset</button>
            <button class="mapEditBtn" id="showOffsetBtn" type="button">Show</button>
            <button class="mapEditBtn" id="exportParcelLayout" type="button">Copy JSON</button>
          </div>
        </div>
        <div class="mapDataNotice">
          All map parcels, ownership, and business values shown here are mock data and do not represent real-world land or assets. Land parcels are only shown for a general understanding; land between plotted parcels is assumed to be privately owned in theory and available for bidding.
        </div>
        <div class="mapSurface">
          <div id="map" role="img" aria-label="Tokyo Map"></div>
          <div class="parcelGuideOverlay" id="parcelGuideOverlay" aria-hidden="true"></div>
          <div class="parcelEditOverlay" id="parcelEditOverlay" aria-hidden="true"></div>
          <div class="parcelCoordPanel" id="parcelCoordPanel" aria-live="polite"></div>
        </div>
      </div>
    </main>

    <!-- ===================== PAGE: CLONE ===================== -->
    <main class="page" id="page-clone" aria-label="Clone">
      <div class="controls">
        <div class="search" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="2" opacity="0.85"/>
            <path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="2" stroke-linecap="round" opacity="0.85"/>
          </svg>
          <input id="search" type="search" placeholder="Search businesses" autocomplete="off" />
        </div>
        <select id="sortClone" class="sortControl" aria-label="Sort clone businesses">
          <option value="distance_desc" selected>Sort: Farthest to closest branch</option>
          <option value="min_start_asc">Sort: Minimal starting cost</option>
          <option value="min_workers_asc">Sort: Minimal workers</option>
          <option value="avg_income_desc">Sort: Average yearly income</option>
        </select>
      </div>

      <section class="grid" id="cards">
        <article class="card" data-name="coffee shop cafe" data-distance-km="27" data-min-start="13.33" data-min-workers="3" data-avg-income="73.33">
          <div class="thumbWrap"><img class="thumb" src="images/cafe.png" alt="Coffee Shop" /></div>
          <div class="cardMain">
            <h3 class="title">Cafe Nakamoto</h3>
            <div class="rev">73.33 <span class="unit">/ year avg (all branches)</span></div>
            <div class="rowStats">
              <div><span class="k">Minimal starting capital</span><span class="v">13.33</span></div>
              <div><span class="k">Avg. operation</span><span class="v">20.00 / year</span></div>
              <div><span class="k">Worker range</span><span class="v">3-6</span></div>
              <div><span class="k">Closest Branch</span><span class="v">27 km</span></div>
            </div>
          </div>
          <div class="cardAction"><button class="viewBtn cloneBtnUnavailable" type="button" data-tip="Terminate your business before cloning">Clone Request</button></div>
        </article>

        <article class="card" data-name="pet grooming salon" data-distance-km="143" data-min-start="5.67" data-min-workers="2" data-avg-income="61.67">
          <div class="thumbWrap"><img class="thumb" src="images/Pet_store.png" alt="Pet Grooming" /></div>
          <div class="cardMain">
            <h3 class="title">Pet Grooming</h3>
            <div class="rev">61.67 <span class="unit">/ year avg (all branches)</span></div>
            <div class="rowStats">
              <div><span class="k">Minimal starting capital</span><span class="v">5.67</span></div>
              <div><span class="k">Avg. operation</span><span class="v">18.33 / year</span></div>
              <div><span class="k">Worker range</span><span class="v">2-5</span></div>
              <div><span class="k">Closest Branch</span><span class="v">143 km</span></div>
            </div>
          </div>
          <div class="cardAction"><button class="viewBtn cloneBtnUnavailable" type="button" data-tip="Terminate your business before cloning">Clone Request</button></div>
        </article>

        <article class="card" data-name="plant nursery garden" data-distance-km="312" data-min-start="8.33" data-min-workers="1" data-avg-income="68.33">
          <div class="thumbWrap"><img class="thumb" src="images/plant_nursery.png" alt="Plant Nursery" /></div>
          <div class="cardMain">
            <h3 class="title">Plant Nursery</h3>
            <div class="rev">68.33 <span class="unit">/ year avg (all branches)</span></div>
            <div class="rowStats">
              <div><span class="k">Minimal starting capital</span><span class="v">8.33</span></div>
              <div><span class="k">Avg. operation</span><span class="v">21.00 / year</span></div>
              <div><span class="k">Worker range</span><span class="v">1-4</span></div>
              <div><span class="k">Closest Branch</span><span class="v">312 km</span></div>
            </div>
          </div>
          <div class="cardAction"><button class="viewBtn cloneBtnUnavailable" type="button" data-tip="Terminate your business before cloning">Clone Request</button></div>
        </article>

        <article class="card" data-name="ice cream shop dessert" data-distance-km="8" data-min-start="8.33" data-min-workers="2" data-avg-income="73.33">
          <div class="thumbWrap"><img class="thumb" src="images/ice_cream.png" alt="Ice Cream Shop" /></div>
          <div class="cardMain">
            <h3 class="title">Ice Cream Shop</h3>
            <div class="rev">73.33 <span class="unit">/ year avg (all branches)</span></div>
            <div class="rowStats">
              <div><span class="k">Minimal starting capital</span><span class="v">8.33</span></div>
              <div><span class="k">Avg. operation</span><span class="v">21.00 / year</span></div>
              <div><span class="k">Worker range</span><span class="v">2-4</span></div>
              <div><span class="k">Closest Branch</span><span class="v">8 km</span></div>
            </div>
          </div>
          <div class="cardAction"><button class="viewBtn cloneBtnUnavailable" type="button" data-tip="Terminate your business before cloning">Clone Request</button></div>
        </article>
      </section>
    </main>

    <!-- ===================== PAGE: MANAGE ===================== -->
    <main class="page" id="page-manage" aria-label="Manage">
      <section class="businessPage">
        <div class="businessHero">
          <div class="heroImg">
            <img src="images/cafe-minimal.png" alt="Cafe Nakamoto" />
          </div>
          <div class="heroInfo">
            <h2>Cafe Nakamoto</h2>
            <div class="heroMeta">Status: Operating  Location: Shinjuku, Tokyo  Category: Caf</div>
            <div class="heroBadges">
              <span class="badge">Shinjuku</span>
              <span class="badge">Open</span>
              <span class="badge">Team: 6</span>
            </div>
            <div class="teamTitle">Team Members</div>
            <div class="teamList" aria-label="Team members">
              <div class="teamMember highlight">
                <span class="teamInfo">
                  <span class="anonIcon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/></svg>
                  </span>
                  0x4f2a...9c1b
                </span>
                <span class="teamPct">34%</span>
              </div>
              <div class="teamMember">
                <span class="teamInfo">
                  <span class="anonIcon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/></svg>
                  </span>
                  0x8c31...a92f
                </span>
                <span class="teamPct">16%</span>
              </div>
              <div class="teamMember">
                <span class="teamInfo">
                  <span class="anonIcon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/></svg>
                  </span>
                  0x1f7b...c4e2
                </span>
                <span class="teamPct">15%</span>
              </div>
              <div class="teamMember">
                <span class="teamInfo">
                  <span class="anonIcon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/></svg>
                  </span>
                  0x5a9d...11b6
                </span>
                <span class="teamPct">13%</span>
              </div>
              <div class="teamMember">
                <span class="teamInfo">
                  <span class="anonIcon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/></svg>
                  </span>
                  0x92de...7c40
                </span>
                <span class="teamPct">12%</span>
              </div>
              <div class="teamMember">
                <span class="teamInfo">
                  <span class="anonIcon" aria-hidden="true">
                    <svg viewBox="0 0 24 24"><path d="M12 12.2a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2.3c-3.2 0-6 1.6-6 3.8v1.2h12v-1.2c0-2.2-2.8-3.8-6-3.8Z"/></svg>
                  </span>
                  0x0b4f...e18a
                </span>
                <span class="teamPct">10%</span>
              </div>
            </div>

          </div>
        </div>

        <div class="branches">
          <h3 class="branchesTitle">Active Branches  Royalties</h3>
          <div class="branchList" aria-label="Active branches">
            <div class="branchItem">
              <span class="branchLeft">
                <span class="storeIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg>
                </span>
                <span class="branchAddr">0xa3f1...c77b</span>
              </span>
              <span class="branchActions"><span class="branchRoyalty">1.9% royalty</span><button class="forceForkBtn" type="button">Force Fork</button></span>
            </div>
            <div class="branchItem">
              <span class="branchLeft">
                <span class="storeIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg>
                </span>
                <span class="branchAddr">0x5d9c...10fa</span>
              </span>
              <span class="branchActions"><span class="branchRoyalty">1.6% royalty</span><button class="forceForkBtn" type="button">Force Fork</button></span>
            </div>
            <div class="branchItem">
              <span class="branchLeft">
                <span class="storeIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg>
                </span>
                <span class="branchAddr">0x9b42...7e0d</span>
              </span>
              <span class="branchActions"><span class="branchRoyalty">1.3% royalty</span><button class="forceForkBtn" type="button">Force Fork</button></span>
            </div>
            <div class="branchItem">
              <span class="branchLeft">
                <span class="storeIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg>
                </span>
                <span class="branchAddr">0x1c8e...a2b9</span>
              </span>
              <span class="branchActions"><span class="branchRoyalty">1.1% royalty</span><button class="forceForkBtn" type="button">Force Fork</button></span>
            </div>
            <div class="branchItem">
              <span class="branchLeft">
                <span class="storeIcon" aria-hidden="true">
                  <svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg>
                </span>
                <span class="branchAddr">0x7aa1...f8c2</span>
              </span>
              <span class="branchActions"><span class="branchRoyalty">0.8% royalty</span><button class="forceForkBtn" type="button">Force Fork</button></span>
            </div>
          </div>

          <div class="branchRequests" aria-label="Branch requests">
            <div class="branchReqHead">
              <span>Branch Requests</span>
              <span class="branchReqCount"><svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 22a2.8 2.8 0 0 0 2.7-2h-5.4A2.8 2.8 0 0 0 12 22Zm7-5H5c1-1 2-2.2 2-5v-1a5 5 0 1 1 10 0v1c0 2.8 1 4 2 5Z"/></svg>4</span>
            </div>
            <p class="branchReqRule">Auto-accept threshold: 0.5% royalty</p>
            <div class="branchReqList">
              <div class="branchReqItem"><span>0x7d13...a8f4</span><span class="branchReqMeta"><span class="branchReqPct">0.1%</span><button class="branchAcceptBtn" type="button">Accept</button></span></div>
              <div class="branchReqItem"><span>0x2bc9...e11a</span><span class="branchReqMeta"><span class="branchReqPct">0.2%</span><button class="branchAcceptBtn" type="button">Accept</button></span></div>
              <div class="branchReqItem"><span>0x94ff...3c0d</span><span class="branchReqMeta"><span class="branchReqPct">0.3%</span><button class="branchAcceptBtn" type="button">Accept</button></span></div>
              <div class="branchReqItem"><span>0x5a10...b772</span><span class="branchReqMeta"><span class="branchReqPct">0.4%</span><button class="branchAcceptBtn" type="button">Accept</button></span></div>
            </div>
          </div>
        </div>

        <div class="heroStats">
          <div class="stat">
            <div class="label">Monthly revenue</div>
            <div class="value">5.20</div>
          </div>
          <div class="stat">
            <div class="label">Monthly operating cost</div>
            <div class="value">3.10</div>
          </div>
          <div class="stat">
            <div class="label">Next payroll</div>
            <div class="value">0.42</div>
          </div>
        </div>

        <div class="businessBody">
          <div class="panel">
            <h3>Operations</h3>
            <div class="kv"><span>Open hours</span><b>08:0020:00</b></div>
            <div class="kv"><span>Average hourly income</span><b>0.028</b></div>
            <div class="kv"><span>Expenditure Reserve</span><b>1.25</b></div>
          </div>

          <div class="panel">
            <div class="panelHeader">
              <h3>Recent Rule Changes <span class="ruleDate" id="ruleDateLabel"></span></h3>
              <button class="createTaskBtn" type="button">Propose change</button>
            </div>
            <ul class="list">
              <li>Switch bean supplier to Yumenosora Roasters (0x7b3e...c9a1)  effective Mar 1</li>
              <li>Adjust house blend recipe: +5% Colombia, -5% Ethiopia</li>
              <li>Update milk options: add oat blend, discontinue soy</li>
              <li>Revise closing procedure checklist for grinder cleaning</li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="proposalModal" id="branchAcceptModal" aria-hidden="true">
    <div class="proposalCard" role="dialog" aria-modal="true" aria-labelledby="branchAcceptTitle">
      <section class="proposalStage" id="branchAcceptStage">
        <h3 id="branchAcceptTitle">Accept Branch Request</h3>
        <p id="branchAcceptSummary"></p>
        <div class="proposalActions proposalActionsLeft">
          <button type="button" class="proposalBtn" id="branchAcceptCancel">Cancel</button>
          <button type="button" class="proposalBtn primary" id="branchAcceptConfirm">Accept</button>
        </div>
      </section>
    </div>
  </div>

  <div class="proposalModal" id="proposalModal" aria-hidden="true">
    <div class="proposalCard" role="dialog" aria-modal="true" aria-labelledby="proposalTitle">
      <section class="proposalStage" id="proposalStageForm">
        <h3 id="proposalTitle">Propose Ruleset Change</h3>
        <p>Describe the operational change you want branches to adopt.</p>
        <textarea id="proposalInput" class="proposalInput" placeholder="Example: shift supplier allocation to 60% local roasters and update milk handling policy."></textarea>
        <div class="proposalActions">
          <button type="button" class="proposalBtn" id="proposalCancel">Cancel</button>
          <button type="button" class="proposalBtn primary" id="proposalSubmit">Propose</button>
        </div>
      </section>
      <section class="proposalStage proposalLoading" id="proposalStageLoading" hidden>
        <div class="proposalSpinner" aria-hidden="true"></div>
        <p>gettting response from branches...</p>
      </section>
      <section class="proposalStage" id="proposalStageResult" hidden>
        <h3>Branch Pushback Detected</h3>
        <p>The following branches signaled fork risk for this change:</p>
        <ul class="proposalRiskList" id="proposalRiskList"></ul>
        <p class="proposalLoss" id="proposalLoss"></p>
        <div class="proposalActions proposalActionsLeft">
          <button type="button" class="proposalBtn" id="proposalRevert">Revert Changes</button>
          <button type="button" class="proposalBtn primary" id="proposalProceed">Proceed Despite Risk</button>
        </div>
      </section>
    </div>
  </div>

  <div class="proposalModal" id="forkModal" aria-hidden="true">
    <div class="proposalCard" role="dialog" aria-modal="true" aria-labelledby="forkTitle">
      <section class="proposalStage" id="forkStage">
        <h3 id="forkTitle">Force Fork Confirmation</h3>
        <p id="forkSummary"></p>
        <p id="forkWarnings" style="margin-top:10px; color: rgba(232,210,184,0.82); line-height:1.5;"></p>
        <div class="proposalActions proposalActionsLeft">
          <button type="button" class="proposalBtn" id="forkCancel">Cancel</button>
          <button type="button" class="proposalBtn primary" id="forkConfirm">Confirm</button>
        </div>
      </section>
    </div>
  </div>

  <div class="proposalModal" id="landBidModal" aria-hidden="true">
    <div class="proposalCard" role="dialog" aria-modal="true" aria-labelledby="landBidTitle">
      <section class="proposalStage" id="landBidStage">
        <h3 id="landBidTitle">Empty Land Parcel (Mock)</h3>
        <p id="landBidSummary"></p>
        <div class="landSalesChart" id="landSalesChart" aria-label="Past sales price chart"></div>
        <ul class="proposalRiskList" id="landBidList"></ul>
        <p id="landBidWarnings" style="margin-top:10px; color: rgba(232,210,184,0.82); line-height:1.5;"></p>
        <input id="landBidOffer" class="proposalInput" type="number" step="0.0001" min="0" placeholder="Enter offer in ETH, e.g. 175" style="min-height:0; height:42px;" />
        <div class="proposalActions proposalActionsLeft">
          <button type="button" class="proposalBtn" id="landBidCancel">Cancel</button>
          <button type="button" class="proposalBtn" id="landBidSubmit">Submit Offer</button>
          <button type="button" class="proposalBtn primary" id="landBidBuyNow">Buy Full Price (200)</button>
        </div>
      </section>
    </div>
  </div>

  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    (function(){
      /* ===== Seasonal logic (system time) ===== */
      function getSeason(month){
        if (month >= 2 && month <= 4) return "spring";
        if (month >= 5 && month <= 7) return "summer";
        if (month >= 8 && month <= 10) return "fall";
        return "winter";
      }

      const seasonText = {
        spring: "",
        summer: "",
        fall:   "",
        winter: ""
      };

      const seasonImage = {
        spring: "images/spring.png",
        summer: "images/summer.png",
        fall:   "images/fall.png",
        winter: "images/winter.png"
      };

      const season = getSeason(new Date().getMonth());

      document.getElementById('introLine2').textContent = seasonText[season] || "";
      document.getElementById('introTree').src = seasonImage[season] || "images/spring.png";
      document.getElementById("headerLogo").src = seasonImage[season] || "images/spring.png";

      const legalBanner = document.querySelector(".legalBanner");
      const legalDismissBtn = document.querySelector(".legalDismiss");
      const legalDismissKey = "root_legal_dismissed";
      try {
        if (localStorage.getItem(legalDismissKey) === "1" && legalBanner) {
          legalBanner.classList.add("isDismissed");
        }
      } catch (_) {}
      if (legalDismissBtn && legalBanner) {
        legalDismissBtn.addEventListener("click", () => {
          legalBanner.classList.add("isDismissed");
          try {
            localStorage.setItem(legalDismissKey, "1");
          } catch (_) {}
        });
      }

      /* ===== Intro sequence (0.75x, tree lingers longer) ===== */
      const intro = document.getElementById('intro');
      const line1 = document.getElementById('introLine1');
      const tree  = document.getElementById('introTree');
      const line2 = document.getElementById('introLine2');

      if (sessionStorage.getItem('root_intro_seen')) {
        intro.classList.add('hide');
      } else {
        sessionStorage.setItem('root_intro_seen','1');

        const t = { show1: 90, showTree: 675, show2: 1875, done: 2700 };

        setTimeout(() => line1.classList.add('show'), t.show1);
        setTimeout(() => tree.classList.add('showTree'), t.showTree);
        setTimeout(() => line2.classList.add('show'), t.show2);
        setTimeout(() => intro.classList.add('hide'), t.done);
      }

      /* ===== Tabs operational ===== */
      const tabs = Array.from(document.querySelectorAll('.tab[data-page]'));
      const pages = {
        area: document.getElementById('page-area'),
        clone: document.getElementById('page-clone'),
        manage: document.getElementById('page-manage')
      };

      function setActive(pageKey){
        tabs.forEach(t => t.classList.toggle('active', t.dataset.page === pageKey));
        Object.keys(pages).forEach(k => pages[k].classList.toggle('active', k === pageKey));
      }
      tabs.forEach(t => t.addEventListener('click', () => setActive(t.dataset.page)));

      /* ===== Search filter (Clone tab) ===== */
      const search = document.getElementById('search');
      const sortClone = document.getElementById('sortClone');
      const cardsContainer = document.getElementById('cards');
      const cards = Array.from(document.querySelectorAll('#cards .card'));

      function sortValue(card, key){
        if (key === 'distance_desc') return Number(card.getAttribute('data-distance-km') || 0);
        if (key === 'min_start_asc') return Number(card.getAttribute('data-min-start') || 0);
        if (key === 'min_workers_asc') return Number(card.getAttribute('data-min-workers') || 0);
        if (key === 'avg_income_desc') return Number(card.getAttribute('data-avg-income') || 0);
        return 0;
      }

      function renderCloneCards(){
        const query = (search && search.value ? search.value : '').trim().toLowerCase();
        const sortKey = sortClone ? sortClone.value : 'distance_desc';

        const visibleCards = cards.filter(card => {
          const name = (card.getAttribute('data-name') || '').toLowerCase();
          return !query || name.includes(query);
        });

        const sorted = visibleCards.slice().sort((a, b) => {
          const av = sortValue(a, sortKey);
          const bv = sortValue(b, sortKey);
          if (sortKey === 'min_start_asc' || sortKey === 'min_workers_asc') return av - bv;
          return bv - av;
        });

        cards.forEach(card => { card.style.display = 'none'; });
        sorted.forEach(card => {
          card.style.display = '';
          cardsContainer.appendChild(card);
        });
      }
      if (search) search.addEventListener('input', renderCloneCards);
      if (sortClone) sortClone.addEventListener('change', renderCloneCards);
      renderCloneCards();

      /* ===== Branch request acceptance (session only) ===== */
      const branchRequestsEl = document.querySelector('.branchRequests');
      if (branchRequestsEl) {
        const branchListEl = document.querySelector('.branchList');
        const requestListEl = branchRequestsEl.querySelector('.branchReqList');
        const requestCountEl = branchRequestsEl.querySelector('.branchReqCount');
        const notifyTipEl = document.querySelector('.profileNotifyTip');
        const notifyIconEl = document.querySelector('.profileNotify');

        const monthlyRevenueText = (document.querySelector('.heroStats .stat .value') || {}).textContent || '0';
        const monthlyRevenue = Number(monthlyRevenueText.replace(/[^0-9.]/g, '')) || 0;

        const ownerPctText = (document.querySelector('.teamMember.highlight .teamPct') || {}).textContent || '0';
        const ownerPct = Number(ownerPctText.replace(/[^0-9.]/g, '')) || 0;

        function formatEth(value){
          return '\u039e' + value.toFixed(4);
        }

        function renderRequestCount(count){
          requestCountEl.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 22a2.8 2.8 0 0 0 2.7-2h-5.4A2.8 2.8 0 0 0 12 22Zm7-5H5c1-1 2-2.2 2-5v-1a5 5 0 1 1 10 0v1c0 2.8 1 4 2 5Z"/></svg>' + count;
          requestCountEl.classList.toggle('isZero', count === 0);
          if (notifyIconEl) {
            notifyIconEl.style.display = count === 0 ? 'none' : '';
          }
          if (notifyTipEl) {
            notifyTipEl.style.display = count === 0 ? 'none' : '';
            notifyTipEl.textContent = 'You have ' + count + ' branch request' + (count === 1 ? '' : 's');
          }
        }

        function updateEmptyState(){
          const count = requestListEl.querySelectorAll('.branchReqItem').length;
          let emptyNode = requestListEl.querySelector('.branchReqEmpty');
          if (count === 0) {
            if (!emptyNode) {
              emptyNode = document.createElement('div');
              emptyNode.className = 'branchReqItem branchReqEmpty';
              emptyNode.textContent = 'No pending requests';
              requestListEl.appendChild(emptyNode);
            }
          } else if (emptyNode) {
            emptyNode.remove();
          }
          renderRequestCount(count);
        }

        function addBranch(addr, pctText){
          const newItem = document.createElement('div');
          newItem.className = 'branchItem';
          newItem.innerHTML =
            '<span class="branchLeft">' +
              '<span class="storeIcon" aria-hidden="true">' +
                '<svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg>' +
              '</span>' +
              '<span class="branchAddr">' + addr + '</span>' +
            '</span>' +
            '<span class="branchActions"><span class="branchRoyalty">' + pctText + ' royalty</span><button class="forceForkBtn" type="button">Force Fork</button></span>';
          branchListEl.appendChild(newItem);
        }

        let pendingBranchAccept = null;
        const branchAcceptModal = document.getElementById("branchAcceptModal");
        const branchAcceptSummary = document.getElementById("branchAcceptSummary");
        const branchAcceptCancel = document.getElementById("branchAcceptCancel");
        const branchAcceptConfirm = document.getElementById("branchAcceptConfirm");

        function openBranchAcceptModal(){
          if (!branchAcceptModal) return;
          branchAcceptModal.classList.add("open");
          branchAcceptModal.setAttribute("aria-hidden", "false");
        }

        function closeBranchAcceptModal(){
          if (!branchAcceptModal) return;
          branchAcceptModal.classList.remove("open");
          branchAcceptModal.setAttribute("aria-hidden", "true");
          pendingBranchAccept = null;
        }

        if (branchAcceptModal) {
          branchAcceptCancel.addEventListener("click", closeBranchAcceptModal);
          branchAcceptConfirm.addEventListener("click", () => {
            if (!pendingBranchAccept) {
              closeBranchAcceptModal();
              return;
            }
            addBranch(pendingBranchAccept.addr, pendingBranchAccept.pctText);
            pendingBranchAccept.item.remove();
            updateEmptyState();
            closeBranchAcceptModal();
          });
          branchAcceptModal.addEventListener("click", (event) => {
            if (event.target === branchAcceptModal) closeBranchAcceptModal();
          });
        }

        requestListEl.querySelectorAll('.branchAcceptBtn').forEach((btn) => {
          btn.disabled = false;
          btn.addEventListener('click', () => {
            const item = btn.closest('.branchReqItem');
            if (!item) return;

            const addrNode = item.children[0];
            const pctNode = item.querySelector('.branchReqPct');
            if (!addrNode || !pctNode) return;

            const addr = addrNode.textContent.trim();
            const pctText = pctNode.textContent.trim();
            const pct = Number(pctText.replace(/[^0-9.]/g, '')) || 0;

            const activeCount = Math.max(1, branchListEl.querySelectorAll('.branchItem').length);
            const avgBranchRevenue = monthlyRevenue / activeCount;
            const personalIncrease = avgBranchRevenue * (pct / 100) * (ownerPct / 100);

            pendingBranchAccept = { addr: addr, pctText: pctText, item: item };
            branchAcceptSummary.textContent =
              "Accept branch request from " + addr + " at " + pctText + " royalty? Estimated personal income increase: " +
              formatEth(personalIncrease) + " / month.";
            openBranchAcceptModal();
          });
        });

        updateEmptyState();
      }

      /* ===== Ruleset proposal flow ===== */
      const proposeBtn = document.querySelector(".createTaskBtn");
      const ruleDateLabel = document.getElementById("ruleDateLabel");
      if (ruleDateLabel) {
        const now = new Date();
        ruleDateLabel.textContent = now.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
      }
      const proposalModal = document.getElementById("proposalModal");
      const proposalInput = document.getElementById("proposalInput");
      const proposalCancel = document.getElementById("proposalCancel");
      const proposalSubmit = document.getElementById("proposalSubmit");
      const proposalRevert = document.getElementById("proposalRevert");
      const proposalProceed = document.getElementById("proposalProceed");
      const proposalStageForm = document.getElementById("proposalStageForm");
      const proposalStageLoading = document.getElementById("proposalStageLoading");
      const proposalStageResult = document.getElementById("proposalStageResult");
      const proposalRiskList = document.getElementById("proposalRiskList");
      const proposalLoss = document.getElementById("proposalLoss");
      let latestAtRisk = [];

      if (proposeBtn && proposalModal) {
        const monthlyRevenueText = (document.querySelector(".heroStats .stat .value") || {}).textContent || "0";
        const monthlyRevenue = Number(monthlyRevenueText.replace(/[^0-9.]/g, "")) || 0;

        function openProposal(){
          proposalModal.classList.add("open");
          proposalModal.setAttribute("aria-hidden", "false");
          proposalStageForm.hidden = false;
          proposalStageLoading.hidden = true;
          proposalStageResult.hidden = true;
          proposalInput.value = "";
          proposalInput.focus();
        }

        function closeProposal(){
          proposalModal.classList.remove("open");
          proposalModal.setAttribute("aria-hidden", "true");
        }

        function showLoading(){
          proposalStageForm.hidden = true;
          proposalStageLoading.hidden = false;
          proposalStageResult.hidden = true;
        }

        function showResult(){
          const atRisk = [
            { addr: "0x5d9c...10fa", royalty: 1.6 },
            { addr: "0x9b42...7e0d", royalty: 1.3 },
            { addr: "0x1c8e...a2b9", royalty: 1.1 }
          ];

          const totalRoyalty = atRisk.reduce((sum, x) => sum + x.royalty, 0);
          const estMonthlyLoss = monthlyRevenue * (totalRoyalty / 100);

          latestAtRisk = atRisk.slice();

          proposalRiskList.innerHTML = atRisk
            .map((r) => "<li>" + r.addr + " \u2022 " + r.royalty.toFixed(1) + "% royalty</li>")
            .join("");

          proposalLoss.textContent =
            "If they fork, estimated loss is " +
            "\u039e" + estMonthlyLoss.toFixed(4) +
            " / month (" +
            "\u039e" + (estMonthlyLoss * 12).toFixed(4) +
            " / year).";

          proposalStageForm.hidden = true;
          proposalStageLoading.hidden = true;
          proposalStageResult.hidden = false;
        }

        proposeBtn.addEventListener("click", openProposal);
        proposalCancel.addEventListener("click", closeProposal);
        proposalRevert.addEventListener("click", closeProposal);

        function proceedDespiteRisk(){
          if (!latestAtRisk.length) {
            closeProposal();
            return;
          }

          const rows = Array.from(document.querySelectorAll(".branchList .branchItem"));
          rows.forEach((row) => {
            const addrEl = row.querySelector(".branchAddr");
            if (!addrEl) return;
            const addr = addrEl.textContent.trim();
            if (latestAtRisk.some((entry) => entry.addr === addr)) {
              row.remove();
            }
          });

          closeProposal();
        }

        proposalProceed.addEventListener("click", proceedDespiteRisk);

        proposalModal.addEventListener("click", (event) => {
          if (event.target === proposalModal) closeProposal();
        });

        proposalSubmit.addEventListener("click", () => {
          if (!proposalInput.value.trim()) {
            proposalInput.focus();
            return;
          }

          showLoading();
          setTimeout(showResult, 2200);
        });
      }

      /* ===== Force fork flow ===== */
      const forkModal = document.getElementById("forkModal");
      const forkTitle = document.getElementById("forkTitle");
      const forkSummary = document.getElementById("forkSummary");
      const forkWarnings = document.getElementById("forkWarnings");
      const forkCancel = document.getElementById("forkCancel");
      const forkConfirm = document.getElementById("forkConfirm");
      let activeForkContext = null;
      const FORK_WINDOW_MS = 90 * 24 * 60 * 60 * 1000;
      let forkTimerTicking = false;

      function parsePct(text){
        return Number((text || "").replace(/[^0-9.]/g, "")) || 0;
      }

      function renderMonthsLeft(startMs){
        const elapsed = Math.max(0, Date.now() - startMs);
        const remaining = Math.max(0, FORK_WINDOW_MS - elapsed);
        const months = remaining / (30 * 24 * 60 * 60 * 1000);
        return months.toFixed(1) + " months";
      }

      function ensureForkBadge(item, startMs){
        if (!item) return;
        item.dataset.forkStartMs = String(startMs);
        item.classList.add("forkPending");
        let badge = item.querySelector(".forkTimerBtn");
        if (!badge) {
          badge = document.createElement("button");
          badge.type = "button";
          badge.className = "forkTimerBtn";
          badge.innerHTML =
            '<span class="forkTimerIcon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 1a1 1 0 0 1 1 1v1.06A9 9 0 1 1 5.64 6.9a1 1 0 1 1 1.54 1.28A7 7 0 1 0 13 5.06V6a1 1 0 1 1-2 0V2a1 1 0 0 1 1-1zm0 5a1 1 0 0 1 1 1v4.2l2.7 1.56a1 1 0 1 1-1 1.72l-3.2-1.85A1 1 0 0 1 11 12V7a1 1 0 0 1 1-1z"/></svg></span>' +
            '' +
            '<span class="forkTimerText"></span>';
          item.appendChild(badge);
        }
        const textEl = badge.querySelector(".forkTimerText");
        if (textEl) textEl.textContent = renderMonthsLeft(startMs);
      }

      function clearForkBadge(item){
        if (!item) return;
        item.classList.remove("forkPending");
        delete item.dataset.forkStartMs;
        const badge = item.querySelector(".forkTimerBtn");
        if (badge) badge.remove();
      }

      function tickForkBadges(){
        document.querySelectorAll(".branchList .branchItem[data-fork-start-ms]").forEach((item) => {
          const startMs = Number(item.dataset.forkStartMs);
          if (!startMs) return;
          ensureForkBadge(item, startMs);
        });
      }

      function startForkTicker(){
        if (forkTimerTicking) return;
        forkTimerTicking = true;
        setInterval(tickForkBadges, 1000);
      }

      function openForkModal(button, forceRetract){
        if (!forkModal || !button) return;

        const item = button.closest(".branchItem");
        const addr = item && item.querySelector(".branchAddr") ? item.querySelector(".branchAddr").textContent.trim() : "unknown";
        const royaltyText = item && item.querySelector(".branchRoyalty") ? item.querySelector(".branchRoyalty").textContent.trim() : "0% royalty";
        const royaltyPct = parsePct(royaltyText);

        const monthlyRevenueNode = document.querySelector(".heroStats .stat .value");
        const monthlyRevenue = parsePct(monthlyRevenueNode ? monthlyRevenueNode.textContent : "0");
        const estMonthlyLoss = monthlyRevenue * (royaltyPct / 100);
        const estYearlyLoss = estMonthlyLoss * 12;

        const forced = forceRetract ? true : button.classList.contains("forced");
        activeForkContext = { button: button, forced: forced };

        forkTitle.textContent = forced ? "Undo Force Fork" : "Force Fork Confirmation";
        forkSummary.textContent =
          (forced ? "Undo forced fork for " : "Force fork for ") +
          addr +
          " (" + royaltyText + ")." +
          (forced
            ? " This will cancel the pending fork notice and continue allowing this branch."
            : " Probable loss: \u039e" + estMonthlyLoss.toFixed(4) + " / month (\u039e" + estYearlyLoss.toFixed(4) + " / year).");

        forkWarnings.textContent =
          forced
            ? "Confirming this action keeps the branch active under the current royalty split."
            : "Branch will receive a 3 month notification. You can retract this action at any time. They can fork at any time regardless.";

        forkConfirm.textContent = forced ? "Undo Force Fork" : "Confirm";

        forkModal.classList.add("open");
        forkModal.setAttribute("aria-hidden", "false");
      }

      function closeForkModal(){
        if (!forkModal) return;
        forkModal.classList.remove("open");
        forkModal.setAttribute("aria-hidden", "true");
        activeForkContext = null;
      }

      if (forkModal) {
        document.addEventListener("click", (event) => {
          const forceBtn = event.target.closest(".forceForkBtn");
          if (forceBtn) {
            event.preventDefault();
            openForkModal(forceBtn, false);
            return;
          }

          const revertBtn = event.target.closest(".forkTimerBtn");
          if (!revertBtn) return;
          event.preventDefault();
          const row = revertBtn.closest(".branchItem");
          const btn = row ? row.querySelector(".forceForkBtn") : null;
          if (btn) openForkModal(btn, true);
        });

        forkCancel.addEventListener("click", closeForkModal);

        forkConfirm.addEventListener("click", () => {
          if (!activeForkContext || !activeForkContext.button) {
            closeForkModal();
            return;
          }

          const row = activeForkContext.button.closest(".branchItem");

          if (activeForkContext.forced) {
            activeForkContext.button.classList.remove("forced");
            activeForkContext.button.textContent = "Force Fork";
            clearForkBadge(row);
          } else {
            activeForkContext.button.classList.add("forced");
            activeForkContext.button.textContent = "Force Fork";
            const startMs = Date.now();
            ensureForkBadge(row, startMs);
            startForkTicker();
          }

          closeForkModal();
        });

        forkModal.addEventListener("click", (event) => {
          if (event.target === forkModal) closeForkModal();
        });

        tickForkBadges();
      }

      /* ===== Map (vector land/water first, Leaflet fallback) ===== */
      function hideUrbanLayers(style){
        if (!style || !Array.isArray(style.layers)) return;
        const hideById = /(building|house|poi|place|label|transit|aeroway)/i;
        style.layers.forEach((layer) => {
          const id = String(layer.id || "");
          const src = String(layer["source-layer"] || "");
          const isSymbol = layer.type === "symbol";
          const isUrban = hideById.test(id) || hideById.test(src);
          if (isSymbol || isUrban) {
            layer.layout = layer.layout || {};
            layer.layout.visibility = "none";
          }
        });
      }

      const ISLAND_BOUNDS = {
        south: 35.628,
        west: 139.890,
        north: 35.651,
        east: 139.945
      };
      const ISLAND_CENTER = [139.9205, 35.64101];
      // Unified parcel registry: all parcels use absolute coords under one system.
      const PARCELS = Object.freeze([
        { number: "1", name: "Cafe Nakamoto Branch", wallet: "0x4f2a...9c1b", royalty: "1.1%", lng: 139.91997495, lat: 35.64126783, status: "Pre-deployment", owned: true, statusIcon: "star", width: 20, height: 20 },
        { number: "2", name: "Finney Mobility Works Branch", wallet: "0x7a9d...31f2", royalty: "0.9%", lng: 139.91965440, lat: 35.64589153, status: "Pending Review", statusIcon: "company", width: 120, height: 144 },
        { number: "3", name: "Empty Land Parcel", wallet: "0x9bc1...42aa", royalty: "-", lng: 139.92400732, lat: 35.64475709, status: "Owner asks to sell", vacant: true, forSale: true, askingPrice: "1.9500", width: 92.2, height: 92.2, parcelStateId: "parcel-3" },
        { number: "4", name: "Empty Land Parcel", wallet: "0x6de3...18bc", royalty: "-", lng: 139.92493140, lat: 35.64718065, status: "Unlisted parcel", vacant: true, statusIcon: "construction", width: 92.22, height: 82.72, parcelStateId: "parcel-4" },
        { number: "5", name: "Wuille Workshop Branch", wallet: "0x8df3...a11c", royalty: "1.0%", lng: 139.92016397, lat: 35.64125064, status: "Pending Review", statusIcon: "company", width: 20, height: 20 },
        { number: "6", name: "Back Hardware Co. Branch", wallet: "0x3c91...f7b4", royalty: "0.8%", lng: 139.92037399, lat: 35.64125064, status: "Pending Review", statusIcon: "company", width: 20, height: 20 },
        { number: "7", name: "Maxwell Mechanics Branch", wallet: "0x4e1a...6bf2", royalty: "0.9%", lng: 139.92014297, lat: 35.64195536, status: "Pending Review", statusIcon: "company", width: 20, height: 20 },
        { number: "8", name: "Andresen Systems Co. Branch", wallet: "0x2b7c...90de", royalty: "0.8%", lng: 139.92035301, lat: 35.64229915, status: "Pending Review", statusIcon: "company", width: 20, height: 20 },
        { number: "9", name: "Garzik Fabrication Branch", wallet: "0x9ad5...1c73", royalty: "0.7%", lng: 139.92056303, lat: 35.64264295, status: "Pending Review", statusIcon: "company", width: 20, height: 20 },
        { number: "11", name: "Wood Acre Farms Branch", wallet: "0x6ab3...4d12", royalty: "0.9%", lng: 139.91782723, lat: 35.64180071, status: "Pending Review", statusIcon: "company", width: 117.6, height: 101.76 },
        { number: "12", name: "Le Jardin Proudhon", wallet: "0x91de...8a54", royalty: "-", lng: 139.91921336, lat: 35.64212729, status: "Reserved land (cannot be bought or sold)", statusIcon: "nature", reserved: true, noIdleFloat: true, width: 87.7, height: 193 }
      ]);
      // Toggle manually in code: true = developer mode, false = production mode.
      const MAP_DEVELOPER_MODE = false;
      const ADDED_PARCEL_Y_SAVE_OFFSET = 430;
      const PARCEL_LAYOUT_KEY = "branchism_parcel_screen_layout_v2";
      const PARCEL_REF_KEY = "branchism_parcel_screen_ref_v1";
      const ADDED_PARCELS_KEY = "branchism_added_parcels_v1";
      const PARCEL_OFFSET_REPORT_KEY = "branchism_parcel_offset_report_v1";
      const PARCEL_LAYOUT_MIGRATED_KEY = "branchism_parcel_screen_layout_migrated_v3";
      const PRODUCTION_PARCEL_SNAPSHOT = {
        referenceSize: { w: 1002, h: 498 },
        parcels: [
          { number: "2", cx: 422.1843674952087, cy: -775.8800173507956, lng: 139.91965439999575, lat: 35.64589153000031 },
          { number: "3", cx: 827.9059178864302, cy: -645.7640126827092, lng: 139.92400731999675, lat: 35.64475709000047 },
          { number: "4", cx: 914.0364165657177, cy: -923.7394793228292, lng: 139.92493139999664, lat: 35.64718065000021 },
          { number: "12", cx: 376.07646002507755, cy: 123.8570591902318, lng: 139.91921335999677, lat: 35.64212729000049 },
          { number: "13", name: "Rosenfeld Tool & Supply Branch", cx: 508.75, cy: -63, lng: 139.92063679265618, lat: 35.64366929718584 },
          { number: "14", name: "Assia Asset Workshop Branch", cx: 526.75, cy: -64.5, lng: 139.92082991170554, lat: 35.64368237547819 },
          { number: "15", name: "Charlon Woodcraft Branch", cx: 545.75, cy: -64.5, lng: 139.92103375958993, lat: 35.64368237547819 },
          { number: "16", name: "Friedrich Fields", wallet: "0x4f2a...9c1b", royalty: "-", status: "Reserved land (cannot be bought or sold)", statusIcon: "nature", width: 45, height: 35, ySaveOffsetApplied: true, reserved: true, noIdleFloat: true, cx: 311.25, cy: -310.8999938964844, lng: 139.9184534745179, lat: 35.64535114792652 },
          { number: "17", name: "Stirner Grove", wallet: "0x4f2a...9c1b", royalty: "-", status: "Reserved land (cannot be bought or sold)", statusIcon: "nature", width: 45, height: 35, ySaveOffsetApplied: true, reserved: true, noIdleFloat: true, cx: 548.25, cy: -368.8999938964844, lng: 139.92098547982755, lat: 35.64556911459343 },
          { number: "18", name: "Nishida Garden", wallet: "0x4f2a...9c1b", royalty: "-", status: "Reserved land (cannot be bought or sold)", statusIcon: "nature", width: 140, height: 75, ySaveOffsetApplied: true, reserved: true, noIdleFloat: true, cx: 511.75, cy: -550.3999938964844, lng: 139.92086209821434, lat: 35.64674176505325 },
          { number: "19", name: "Giardino Emo", wallet: "0x4f2a...9c1b", royalty: "-", status: "Reserved land (cannot be bought or sold)", statusIcon: "nature", width: 240, height: 260, ySaveOffsetApplied: true, reserved: true, noIdleFloat: true, cx: 952.25, cy: -124.39999389648438, lng: 139.9252877430883, lat: 35.64282705061693 }
        ]
      };

      function readParcelLayout(){
        try {
          const raw = JSON.parse(localStorage.getItem(PARCEL_LAYOUT_KEY) || "{}");
          if (!raw || typeof raw !== "object" || Array.isArray(raw)) return {};
          const cleaned = {};
          Object.keys(raw).forEach((key) => {
            const entry = raw[key];
            if (!entry || typeof entry !== "object") return;
            const cx = Number(entry.cx);
            const cy = Number(entry.cy);
            const lng = Number(entry.lng);
            const lat = Number(entry.lat);
            const hasPx = Number.isFinite(cx) && Number.isFinite(cy);
            const hasGeo = Number.isFinite(lng) && Number.isFinite(lat);
            if (!hasPx && !hasGeo) return;
            cleaned[String(key)] = Object.assign(
              {},
              hasPx ? { cx: cx, cy: cy } : {},
              hasGeo ? { lng: lng, lat: lat } : {}
            );
          });
          return cleaned;
        } catch (_) {
          return {};
        }
      }

      function readParcelReferenceSize(){
        try {
          const raw = JSON.parse(localStorage.getItem(PARCEL_REF_KEY) || "null");
          if (!raw || typeof raw !== "object") return null;
          const w = Number(raw.w);
          const h = Number(raw.h);
          if (!Number.isFinite(w) || !Number.isFinite(h) || w <= 0 || h <= 0) return null;
          return { w: w, h: h };
        } catch (_) {
          return null;
        }
      }

      function writeParcelLayout(data){
        try {
          localStorage.setItem(PARCEL_LAYOUT_KEY, JSON.stringify(data || {}));
        } catch (_) {}
      }

      function writeParcelReferenceSize(size){
        try {
          if (!size || !Number.isFinite(Number(size.w)) || !Number.isFinite(Number(size.h))) return;
          localStorage.setItem(PARCEL_REF_KEY, JSON.stringify({ w: Number(size.w), h: Number(size.h) }));
        } catch (_) {}
      }

      let PARCEL_LAYOUT = readParcelLayout();
      let PARCEL_REF = readParcelReferenceSize();

      function readAddedParcels(){
        try {
          const raw = JSON.parse(localStorage.getItem(ADDED_PARCELS_KEY) || "[]");
          if (!Array.isArray(raw)) return [];
          return raw.filter((p) => p && typeof p === "object" && p.number != null).map((p) => Object.assign({
            name: "Parcel " + String(p.number),
            wallet: "0x4f2a...9c1b",
            royalty: "0.8%",
            lng: ISLAND_CENTER[0],
            lat: ISLAND_CENTER[1],
            status: "Pending Review",
            statusIcon: "company",
            width: 20,
            height: 20,
            ySaveOffsetApplied: true
          }, p));
        } catch (_) {
          return [];
        }
      }

      function writeAddedParcels(items){
        try {
          localStorage.setItem(ADDED_PARCELS_KEY, JSON.stringify(Array.isArray(items) ? items : []));
        } catch (_) {}
      }

      let ADDED_PARCELS = readAddedParcels();

      function applyProductionSnapshot(){
        if (MAP_DEVELOPER_MODE) return;
        const baseNumbers = new Set(PARCELS.map((p) => String(p.number)));
        const snapshotAll = (PRODUCTION_PARCEL_SNAPSHOT.parcels || [])
          .filter((p) => p && p.number != null);
        const newOnly = snapshotAll.filter((p) => !baseNumbers.has(String(p.number)));

        PARCEL_LAYOUT = {};
        snapshotAll.forEach((p) => {
          const n = String(p.number);
          PARCEL_LAYOUT[n] = { cx: Number(p.cx), cy: Number(p.cy), lng: Number(p.lng), lat: Number(p.lat) };
        });
        PARCEL_REF = {
          w: Number(PRODUCTION_PARCEL_SNAPSHOT.referenceSize.w),
          h: Number(PRODUCTION_PARCEL_SNAPSHOT.referenceSize.h)
        };

        ADDED_PARCELS = newOnly
          .map((p) => Object.assign({
            name: "Parcel " + String(p.number),
            wallet: "0x4f2a...9c1b",
            royalty: "0.8%",
            status: "Pending Review",
            statusIcon: "company",
            width: 20,
            height: 20,
            ySaveOffsetApplied: true
          }, p));
      }

      function applyDeveloperSeedFromProduction(){
        if (!MAP_DEVELOPER_MODE) return;
        const baseNumbers = new Set(PARCELS.map((p) => String(p.number)));
        const newOnly = (PRODUCTION_PARCEL_SNAPSHOT.parcels || [])
          .filter((p) => p && p.number != null && !baseNumbers.has(String(p.number)));
        const snapshotNumbers = new Set(newOnly.map((p) => String(p.number)));
        const preservedAdded = ADDED_PARCELS.filter((p) => p && p.number != null && !snapshotNumbers.has(String(p.number)));

        const nextLayout = Object.assign({}, PARCEL_LAYOUT);
        newOnly.forEach((p) => {
          const n = String(p.number);
          nextLayout[n] = { cx: Number(p.cx), cy: Number(p.cy), lng: Number(p.lng), lat: Number(p.lat) };
        });
        PARCEL_LAYOUT = nextLayout;
        if (!PARCEL_REF) {
          PARCEL_REF = {
            w: Number(PRODUCTION_PARCEL_SNAPSHOT.referenceSize.w),
            h: Number(PRODUCTION_PARCEL_SNAPSHOT.referenceSize.h)
          };
        }
        ADDED_PARCELS = newOnly.map((p) => Object.assign({
          name: "Parcel " + String(p.number),
          wallet: "0x4f2a...9c1b",
          royalty: "0.8%",
          status: "Pending Review",
          statusIcon: "company",
          width: 20,
          height: 20,
          ySaveOffsetApplied: true
        }, p)).concat(preservedAdded);
      }

      applyProductionSnapshot();
      applyDeveloperSeedFromProduction();

      function getAllParcels(){
        return PARCELS.concat(ADDED_PARCELS);
      }

      function getExtraParcels(){
        return getAllParcels().filter((p) => !["1", "2", "3", "4", "5", "6"].includes(String(p.number)));
      }

      function getParcelConfig(number){
        const id = String(number);
        const all = getAllParcels();
        for (let i = 0; i < all.length; i += 1) {
          if (String(all[i].number) === id) return all[i];
        }
        return null;
      }

      function getMapContainerSize(map){
        const c = map && map.getContainer ? map.getContainer() : null;
        const w = Math.max(1, Number(c && c.clientWidth) || 1);
        const h = Math.max(1, Number(c && c.clientHeight) || 1);
        return { w: w, h: h };
      }

      function ensureParcelReferenceSize(map){
        const size = getMapContainerSize(map);
        if (!PARCEL_REF) {
          PARCEL_REF = { w: size.w, h: size.h };
          writeParcelReferenceSize(PARCEL_REF);
        }
      }

      function currentPxToReferencePx(x, y, map){
        const size = getMapContainerSize(map);
        PARCEL_REF = { w: size.w, h: size.h };
        return {
          cx: Number(x),
          cy: Number(y)
        };
      }

      function referencePxToCurrentPx(cx, cy, map){
        const size = getMapContainerSize(map);
        PARCEL_REF = { w: size.w, h: size.h };
        return {
          x: Number(cx),
          y: Number(cy)
        };
      }

      function getParcelReferencePoint(parcel, map, engine){
        const n = String(parcel.number);
        const override = PARCEL_LAYOUT[n];
        if (override && Number.isFinite(Number(override.cx)) && Number.isFinite(Number(override.cy))) {
          return { cx: Number(override.cx), cy: Number(override.cy) };
        }
        if (override && Number.isFinite(Number(override.lng)) && Number.isFinite(Number(override.lat))) {
          let gx = 0;
          let gy = 0;
          if (engine === "maplibre") {
            const gpt = map.project([Number(override.lng), Number(override.lat)]);
            gx = Number(gpt.x);
            gy = Number(gpt.y);
          } else {
            const gpt = map.latLngToContainerPoint([Number(override.lat), Number(override.lng)]);
            gx = Number(gpt.x);
            gy = Number(gpt.y);
          }
          return currentPxToReferencePx(gx, gy, map);
        }
        let x = 0;
        let y = 0;
        if (engine === "maplibre") {
          const pt = map.project([Number(parcel.lng), Number(parcel.lat)]);
          x = Number(pt.x);
          y = Number(pt.y);
        } else {
          const pt = map.latLngToContainerPoint([Number(parcel.lat), Number(parcel.lng)]);
          x = Number(pt.x);
          y = Number(pt.y);
        }
        return currentPxToReferencePx(x, y, map);
      }

      function getParcelCurrentPoint(parcel, map, engine){
        const refPt = getParcelReferencePoint(parcel, map, engine);
        return referencePxToCurrentPx(refPt.cx, refPt.cy, map);
      }

      function getParcelLngLatFromScreen(parcel, map, engine){
        const pt = getParcelCurrentPoint(parcel, map, engine);
        if (engine === "maplibre") {
          const ll = map.unproject([pt.x, pt.y]);
          return [Number(ll.lng), Number(ll.lat)];
        }
        const ll = map.containerPointToLatLng([pt.x, pt.y]);
        return [Number(ll.lng), Number(ll.lat)];
      }

      function getParcelLngLatForLeaflet(map, parcel){
        return getParcelLngLatFromScreen(parcel, map, "leaflet");
      }

      function getParcelLngLatForMapLibre(map, parcel){
        return getParcelLngLatFromScreen(parcel, map, "maplibre");
      }
      function addExtraBusinessParcelsLeaflet(map){
        getExtraParcels().forEach((p) => {
          const width = Number(p.width) || 20;
          const height = Number(p.height) || 20;
          const markerEl = createBusinessMarkerElement({
            number: p.number,
            name: p.name,
            wallet: p.wallet,
            royalty: p.royalty,
            status: String(p.status || "Pending Review"),
            statusIcon: String(p.statusIcon || "company"),
            owned: Boolean(p.owned),
            vacant: Boolean(p.vacant),
            reserved: Boolean(p.reserved),
            forSale: Boolean(p.forSale),
            askingPrice: p.askingPrice || "",
            noIdleFloat: Boolean(p.noIdleFloat),
            offsetX: 0,
            offsetY: 0,
            width: width,
            height: height
          });
          const icon = L.divIcon({
            className: "",
            html: markerEl.outerHTML,
            iconSize: [width, height],
            iconAnchor: [width / 2, height / 2]
          });
          const markerLngLat = getParcelLngLatForLeaflet(map, p);
          L.marker([markerLngLat[1], markerLngLat[0]], { icon: icon, interactive: true }).addTo(map);
        });
      }

      function addExtraBusinessParcelsMapLibre(map){
        getExtraParcels().forEach((p) => {
          const width = Number(p.width) || 20;
          const height = Number(p.height) || 20;
          const markerEl = createBusinessMarkerElement({
            number: p.number,
            name: p.name,
            wallet: p.wallet,
            royalty: p.royalty,
            status: String(p.status || "Pending Review"),
            statusIcon: String(p.statusIcon || "company"),
            owned: Boolean(p.owned),
            vacant: Boolean(p.vacant),
            reserved: Boolean(p.reserved),
            forSale: Boolean(p.forSale),
            askingPrice: p.askingPrice || "",
            noIdleFloat: Boolean(p.noIdleFloat),
            offsetX: 0,
            offsetY: 0,
            width: width,
            height: height
          });
          const markerLngLat = getParcelLngLatForMapLibre(map, p);
          new maplibregl.Marker({ element: markerEl, anchor: "center" }).setLngLat(markerLngLat).addTo(map);
        });
      }

      function getRoadLayerIds(style){
        if (!style || !Array.isArray(style.layers)) return [];
        return style.layers
          .filter((layer) => {
            if (!layer || layer.type !== "line") return false;
            const id = String(layer.id || "");
            const src = String(layer["source-layer"] || "");
            return /(road|street|highway|transport|rail|motorway|trunk|primary|secondary|tertiary)/i.test(id) ||
              /(road|street|highway|transport|rail|motorway|trunk|primary|secondary|tertiary)/i.test(src);
          })
          .map((layer) => layer.id);
      }

      const METERS_PER_DEG_LAT = 110540;

      function metersPerDegLng(lat){
        return 111320 * Math.cos((lat * Math.PI) / 180);
      }

      function lngLatToMeters(lng, lat, latRef){
        return {
          x: lng * metersPerDegLng(latRef),
          y: lat * METERS_PER_DEG_LAT
        };
      }

      function metersToLngLat(x, y, latRef){
        return [x / metersPerDegLng(latRef), y / METERS_PER_DEG_LAT];
      }

      function makeSeededRng(seed){
        let state = seed >>> 0;
        return function next(){
          state = (1664525 * state + 1013904223) >>> 0;
          return state / 4294967296;
        };
      }

      function buildRandomPlots(count){
        const latRef = ISLAND_CENTER[1];
        const westM = lngLatToMeters(ISLAND_BOUNDS.west, latRef, latRef).x;
        const eastM = lngLatToMeters(ISLAND_BOUNDS.east, latRef, latRef).x;
        const southM = lngLatToMeters(0, ISLAND_BOUNDS.south, latRef).y;
        const northM = lngLatToMeters(0, ISLAND_BOUNDS.north, latRef).y;

        const rng = makeSeededRng(0xA93C17);
        const out = [];
        const maxAttempts = 3500;
        const edgeGap = 70;
        const minGap = 40;

        for (let attempts = 0; attempts < maxAttempts && out.length < count; attempts += 1) {
          const widthM = 170 + Math.floor(rng() * 120);   // 170..289
          const heightM = 120 + Math.floor(rng() * 90);   // 120..209

          const halfW = widthM * 0.5;
          const halfH = heightM * 0.5;
          const minX = westM + edgeGap + halfW;
          const maxX = eastM - edgeGap - halfW;
          const minY = southM + edgeGap + halfH;
          const maxY = northM - edgeGap - halfH;
          if (maxX <= minX || maxY <= minY) break;

          const cx = minX + rng() * (maxX - minX);
          const cy = minY + rng() * (maxY - minY);

          const left = cx - halfW - minGap;
          const right = cx + halfW + minGap;
          const bottom = cy - halfH - minGap;
          const top = cy + halfH + minGap;

          const overlap = out.some((p) => {
            const pHalfW = p.widthM * 0.5;
            const pHalfH = p.heightM * 0.5;
            const pLeft = p.cx - pHalfW - minGap;
            const pRight = p.cx + pHalfW + minGap;
            const pBottom = p.cy - pHalfH - minGap;
            const pTop = p.cy + pHalfH + minGap;
            return !(right < pLeft || left > pRight || top < pBottom || bottom > pTop);
          });
          if (overlap) continue;

          const lngLat = metersToLngLat(cx, cy, latRef);
          out.push({
            id: out.length + 1,
            lng: lngLat[0],
            lat: lngLat[1],
            widthM: widthM,
            heightM: heightM,
            cx: cx,
            cy: cy
          });
        }

        return out.slice(0, count);
      }

      function toPolyFeature(lngLatCorners, id){
        const coords = lngLatCorners.map((pt) => [pt[0], pt[1]]);
        coords.push([lngLatCorners[0][0], lngLatCorners[0][1]]);
        return {
          type: "Feature",
          properties: { id: id },
          geometry: { type: "Polygon", coordinates: [coords] }
        };
      }

      function makePlotPair(a, b, idBase){
        const latRef = (a[1] + b[1]) / 2;
        const p0 = lngLatToMeters(a[0], a[1], latRef);
        const p1 = lngLatToMeters(b[0], b[1], latRef);
        const dx = p1.x - p0.x;
        const dy = p1.y - p0.y;
        const len = Math.hypot(dx, dy);
        if (len < 30) return [];

        const ux = dx / len;
        const uy = dy / len;
        const px = -uy;
        const py = ux;

        const halfLen = 11;
        const depth = 13;
        const roadOffset = 14;

        function rect(side, suffix){
          const cx = (p0.x + p1.x) / 2 + px * side * (roadOffset + depth * 0.5);
          const cy = (p0.y + p1.y) / 2 + py * side * (roadOffset + depth * 0.5);
          const pA = [cx - ux * halfLen - px * side * depth * 0.5, cy - uy * halfLen - py * side * depth * 0.5];
          const pB = [cx + ux * halfLen - px * side * depth * 0.5, cy + uy * halfLen - py * side * depth * 0.5];
          const pC = [cx + ux * halfLen + px * side * depth * 0.5, cy + uy * halfLen + py * side * depth * 0.5];
          const pD = [cx - ux * halfLen + px * side * depth * 0.5, cy - uy * halfLen + py * side * depth * 0.5];
          return toPolyFeature(
            [
              metersToLngLat(pA[0], pA[1], latRef),
              metersToLngLat(pB[0], pB[1], latRef),
              metersToLngLat(pC[0], pC[1], latRef),
              metersToLngLat(pD[0], pD[1], latRef)
            ],
            idBase + suffix
          );
        }

        return [rect(1, "-a"), rect(-1, "-b")];
      }

      function buildRoadPlots(map, roadLayerIds){
        if (!roadLayerIds.length) return [];
        let features = [];
        try {
          features = map.queryRenderedFeatures(undefined, { layers: roadLayerIds });
        } catch (_) {
          return [];
        }

        const out = [];
        const seen = new Set();
        const maxPlots = 320;

        features.forEach((feature, fIndex) => {
          if (!feature || !feature.geometry) return;
          const geom = feature.geometry;
          const lines = [];
          if (geom.type === "LineString" && Array.isArray(geom.coordinates)) lines.push(geom.coordinates);
          if (geom.type === "MultiLineString" && Array.isArray(geom.coordinates)) {
            geom.coordinates.forEach((line) => lines.push(line));
          }

          lines.forEach((line, lIndex) => {
            if (!Array.isArray(line) || line.length < 2) return;
            for (let i = 0; i < line.length - 1; i += 1) {
              if (out.length >= maxPlots) return;
              const a = line[i];
              const b = line[i + 1];
              if (!a || !b) continue;
              const latRef = (a[1] + b[1]) / 2;
              const p0 = lngLatToMeters(a[0], a[1], latRef);
              const p1 = lngLatToMeters(b[0], b[1], latRef);
              const segLen = Math.hypot(p1.x - p0.x, p1.y - p0.y);
              if (segLen < 70) continue;

              const steps = Math.min(2, Math.max(1, Math.floor(segLen / 140)));
              for (let s = 0; s < steps; s += 1) {
                if (out.length >= maxPlots) return;
                const t0 = (s + 0.15) / steps;
                const t1 = (s + 0.85) / steps;
                const q0 = [a[0] + (b[0] - a[0]) * t0, a[1] + (b[1] - a[1]) * t0];
                const q1 = [a[0] + (b[0] - a[0]) * t1, a[1] + (b[1] - a[1]) * t1];
                const q0m = lngLatToMeters(q0[0], q0[1], latRef);
                const q1m = lngLatToMeters(q1[0], q1[1], latRef);
                const key = [
                  Math.round(q0m.x / 8), Math.round(q0m.y / 8),
                  Math.round(q1m.x / 8), Math.round(q1m.y / 8)
                ].join(":");
                if (seen.has(key)) continue;
                seen.add(key);
                out.push(...makePlotPair(q0, q1, "plot-" + fIndex + "-" + lIndex + "-" + i + "-" + s));
              }
            }
          });
        });

        return out.slice(0, maxPlots);
      }

      function setupRoadPlots(map){
        const style = map.getStyle();
        const roadLayerIds = getRoadLayerIds(style);
        if (!roadLayerIds.length) return;

        const sourceId = "road-plots-source";
        const fillId = "road-plots-fill";
        const lineId = "road-plots-line";

        if (!map.getSource(sourceId)) {
          map.addSource(sourceId, {
            type: "geojson",
            data: { type: "FeatureCollection", features: [] }
          });
        }
        if (!map.getLayer(fillId)) {
          map.addLayer({
            id: fillId,
            type: "fill",
            source: sourceId,
            paint: {
              "fill-color": "rgba(180, 140, 85, 0.26)",
              "fill-outline-color": "rgba(197, 163, 110, 0.36)"
            }
          });
        }
        if (!map.getLayer(lineId)) {
          map.addLayer({
            id: lineId,
            type: "line",
            source: sourceId,
            paint: {
              "line-color": "rgba(225, 194, 138, 0.45)",
              "line-width": 1
            }
          });
        }

        let timer = null;
        let lastRefreshZoom = map.getZoom();
        const refresh = () => {
          const source = map.getSource(sourceId);
          if (!source) return;
          const plots = buildRoadPlots(map, roadLayerIds);
          source.setData({ type: "FeatureCollection", features: plots });
        };
        const refreshDebounced = () => {
          clearTimeout(timer);
          timer = setTimeout(refresh, 180);
        };

        refresh();
        map.on("moveend", () => {
          const z = map.getZoom();
          if (Math.abs(z - lastRefreshZoom) > 0.0001) {
            lastRefreshZoom = z;
            return;
          }
          refreshDebounced();
        });
      }

      function plotRectFromMeters(plot){
        const halfW = (plot.widthM || 100) * 0.5;
        const halfH = (plot.heightM || 80) * 0.5;
        const latRef = plot.lat;
        const centerM = lngLatToMeters(plot.lng, plot.lat, latRef);
        const pA = metersToLngLat(centerM.x - halfW, centerM.y - halfH, latRef);
        const pB = metersToLngLat(centerM.x + halfW, centerM.y - halfH, latRef);
        const pC = metersToLngLat(centerM.x + halfW, centerM.y + halfH, latRef);
        const pD = metersToLngLat(centerM.x - halfW, centerM.y + halfH, latRef);
        const feature = toPolyFeature([pA, pB, pC, pD], "manual-plot-" + plot.id);
        feature.properties = {
          id: String(plot.id),
          label: String(plot.id),
          center: [plot.lng, plot.lat]
        };
        return feature;
      }

      function buildCenterSquareFeature(){
        const plot = {
          id: "C",
          lng: ISLAND_CENTER[0],
          lat: ISLAND_CENTER[1],
          widthM: 760,
          heightM: 760
        };
        const feature = plotRectFromMeters(plot);
        feature.properties = {
          id: "center-square",
          label: "CENTER",
          center: [plot.lng, plot.lat]
        };
        return feature;
      }

      function buildStaticNumberedPlots(){
        const latRef = ISLAND_CENTER[1];
        const centerM = lngLatToMeters(ISLAND_CENTER[0], ISLAND_CENTER[1], latRef);
        const specs = [
          { id: 1, dx: -1750, dy: 760, w: 230, h: 170 },
          { id: 2, dx: -980, dy: 820, w: 210, h: 150 },
          { id: 3, dx: -220, dy: 760, w: 220, h: 160 },
          { id: 4, dx: 560, dy: 620, w: 240, h: 170 },
          { id: 5, dx: 1320, dy: 480, w: 220, h: 160 },
          { id: 6, dx: 1260, dy: -140, w: 230, h: 170 },
          { id: 7, dx: 430, dy: -470, w: 210, h: 150 },
          { id: 8, dx: -410, dy: -590, w: 220, h: 160 },
          { id: 9, dx: -1260, dy: -420, w: 230, h: 170 },
          { id: 10, dx: -1770, dy: 40, w: 220, h: 160 }
        ];
        return specs.map((s) => {
          const p = metersToLngLat(centerM.x + s.dx, centerM.y + s.dy, latRef);
          return plotRectFromMeters({
            id: s.id,
            lng: p[0],
            lat: p[1],
            widthM: s.w,
            heightM: s.h
          });
        });
      }

      let cachedPlotSet = null;

      function getPlotSet(){
        if (cachedPlotSet) return cachedPlotSet;
        const center = buildCenterSquareFeature();
        const numbered = buildStaticNumberedPlots();
        cachedPlotSet = { center: center, numbered: numbered };
        return cachedPlotSet;
      }

      function setupManualPlots(map){
        const sourceId = "manual-plots-source";
        const fillId = "manual-plots-fill";
        const lineId = "manual-plots-line";
        const labelId = "manual-plots-label";
        const centerSourceId = "center-square-source";
        const centerFillId = "center-square-fill";
        const centerLineId = "center-square-line";
        const centerLabelId = "center-square-label";
        const plotSet = getPlotSet();
        const features = plotSet.numbered;
        const centerFeature = plotSet.center;

        if (!map.getSource(sourceId)) {
          map.addSource(sourceId, {
            type: "geojson",
            data: { type: "FeatureCollection", features: features }
          });
        } else {
          map.getSource(sourceId).setData({ type: "FeatureCollection", features: features });
        }

        if (!map.getLayer(fillId)) {
          map.addLayer({
            id: fillId,
            type: "fill",
            source: sourceId,
            paint: {
              "fill-color": "rgba(214, 171, 108, 0.48)",
              "fill-outline-color": "rgba(240, 216, 174, 0.90)"
            }
          });
        }
        if (!map.getLayer(lineId)) {
          map.addLayer({
            id: lineId,
            type: "line",
            source: sourceId,
            paint: {
              "line-color": "rgba(255, 234, 198, 0.98)",
              "line-width": 2.2
            }
          });
        }
        if (!map.getLayer(labelId)) {
          map.addLayer({
            id: labelId,
            type: "symbol",
            source: sourceId,
            layout: {
              "text-field": ["get", "label"],
              "text-size": 16,
              "text-font": ["Noto Sans Regular", "Arial Unicode MS Regular"]
            },
            paint: {
              "text-color": "rgba(255, 245, 225, 0.98)",
              "text-halo-color": "rgba(18, 12, 9, 0.98)",
              "text-halo-width": 1.8
            }
          });
        }

        if (!map.getSource(centerSourceId)) {
          map.addSource(centerSourceId, {
            type: "geojson",
            data: { type: "FeatureCollection", features: [centerFeature] }
          });
        } else {
          map.getSource(centerSourceId).setData({ type: "FeatureCollection", features: [centerFeature] });
        }
        if (!map.getLayer(centerFillId)) {
          map.addLayer({
            id: centerFillId,
            type: "fill",
            source: centerSourceId,
            paint: {
              "fill-color": "rgba(92, 173, 245, 0.28)",
              "fill-outline-color": "rgba(153, 213, 255, 0.95)"
            }
          });
        }
        if (!map.getLayer(centerLineId)) {
          map.addLayer({
            id: centerLineId,
            type: "line",
            source: centerSourceId,
            paint: {
              "line-color": "rgba(185, 232, 255, 1)",
              "line-width": 3.6
            }
          });
        }
        if (!map.getLayer(centerLabelId)) {
          map.addLayer({
            id: centerLabelId,
            type: "symbol",
            source: centerSourceId,
            layout: {
              "text-field": ["get", "label"],
              "text-size": 18,
              "text-font": ["Noto Sans Bold", "Arial Unicode MS Bold"]
            },
            paint: {
              "text-color": "rgba(220, 245, 255, 0.98)",
              "text-halo-color": "rgba(18, 12, 9, 0.98)",
              "text-halo-width": 2
            }
          });
        }
      }

      function drawLeafletPlots(map){
        const plotSet = getPlotSet();
        const centerCoords = plotSet.center.geometry.coordinates[0].map((pt) => [pt[1], pt[0]]);
        L.polygon(centerCoords, {
          color: "rgba(185,232,255,1)",
          weight: 3,
          fillColor: "rgba(92,173,245,0.28)",
          fillOpacity: 0.35
        }).addTo(map).bindTooltip("CENTER", {
          permanent: true,
          direction: "center",
          className: "leaflet-plot-label"
        });

        plotSet.numbered.forEach((feature) => {
          const coords = feature.geometry.coordinates[0].map((pt) => [pt[1], pt[0]]);
          L.polygon(coords, {
            color: "rgba(255,234,198,0.98)",
            weight: 2,
            fillColor: "rgba(214,171,108,0.48)",
            fillOpacity: 0.5
          }).addTo(map).bindTooltip(String(feature.properties.label), {
            permanent: true,
            direction: "center",
            className: "leaflet-plot-label"
          });
        });
      }

      function createStoreMarkerElement(){
        return createBusinessMarkerElement({
          number: "1",
          name: "Cafe Nakamoto Branch",
          wallet: "0x4f2a...9c1b",
          royalty: "1.1%",
          status: "Pre-deployment",
          owned: true,
          statusIcon: "star",
          offsetX: 0,
          offsetY: 0,
          size: 20
        });
      }

      function createBusinessMarkerElement(config){
        const el = document.createElement("div");
        el.className = "mapStoreMarker";
        el.dataset.parcelNumber = String(config.number || "");
        const size = Number(config.size) || 20;
        const width = Number(config.width) || size;
        const height = Number(config.height) || size;
        const offsetX = Number(config.offsetX) || 0;
        const offsetY = Number(config.offsetY) || 0;
        const rotate = Number(config.rotate) || 0;
        const owned = Boolean(config.owned);
        const vacant = Boolean(config.vacant);
        const reserved = Boolean(config.reserved);
        const forSale = Boolean(config.forSale);
        const statusIcon = String(config.statusIcon || "");
        const noIdleFloat = Boolean(config.noIdleFloat);
        el.style.width = width + "px";
        el.style.height = height + "px";
        el.style.transform = "translate(" + offsetX + "px, " + offsetY + "px) rotate(" + rotate + "deg)";
        if (!noIdleFloat) el.classList.add("idleFloat");
        if (owned) el.classList.add("owned");
        if (vacant) el.classList.add("vacant");
        if (reserved) el.classList.add("reserved");
        if (!reserved) el.classList.add("prodHoverable");
        const askingLine = config.askingPrice
          ? '<div class="mapStorePanelAsking">Asking: ' + String(config.askingPrice) + '</div>'
          : "";
        const parcelLine = '<div class="mapStorePanelParcel">Parcel: #' + String(config.number || "-") + '</div>';
        let statusIconMarkup = "";
        if (!vacant && statusIcon === "business") {
          statusIconMarkup =
            '<span class="mapStoreStatusIcon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M4 7h16l-1.5 4H5.5L4 7Zm1 6h14v6H5v-6Zm4 1v4h2v-4H9Zm4 0v4h2v-4h-2Z"/></svg></span>';
        } else if (!vacant && statusIcon === "company") {
          statusIconMarkup =
            '<span class="mapStoreStatusIcon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M3 20h18v2H3v-2Zm2-2V7.5L12 3l7 4.5V18h-3v-6h-8v6H5Zm5-8h4V8h-4v2Z"/></svg></span>';
        } else if (statusIcon === "construction") {
          statusIconMarkup =
            '<span class="mapStoreStatusIcon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M2 19h20v2H2v-2Zm4.8-3.5 4.1-4.1 1.4 1.4-4.1 4.1H6.8v-1.4Zm8.5-8.5 1.5-1.5 3.2 3.2-1.5 1.5-3.2-3.2Zm-1 2.4 1.4 1.4-4.8 4.8H9.5v-1.4l4.8-4.8Z"/></svg></span>';
        } else if (!vacant && statusIcon === "star") {
          statusIconMarkup =
            '<span class="mapStoreStatusIcon star" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 2l2.7 5.5 6.1.9-4.4 4.3 1 6.1L12 16l-5.4 2.8 1-6.1-4.4-4.3 6.1-.9z"/></svg></span>';
        } else if (!vacant && statusIcon === "nature") {
          statusIconMarkup =
            '<span class="mapStoreStatusIcon nature" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M18.9 3.2C12.1 3.6 7 8.2 6 14.3c-.5 3.2.4 5.8 2.2 7.2l1.3-1.5c-1.2-1-1.8-2.9-1.4-5.2 1-5.4 5.4-9.2 11.1-9.6-.4 5.8-4.2 10.2-9.6 11.1l.4 2c6.2-1 10.8-6.1 11.2-12.9l.1-1.2-1.2.1Z"/></svg></span>';
        }
        el.innerHTML =
          (vacant ? '<span class="mapStoreVacantOutline" aria-hidden="true"></span>' : '') +
          '<span class="mapStoreDiamond" aria-hidden="true"></span>' +
          '<span class="mapStoreLabel">' + String(config.number || "1") + '</span>' +
          statusIconMarkup +
          (owned && statusIcon !== "star"
            ? '<span class="mapStoreOwnerBadge" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M12 2l2.7 5.5 6.1.9-4.4 4.3 1 6.1L12 16l-5.4 2.8 1-6.1-4.4-4.3 6.1-.9z"/></svg></span>'
            : '') +
          (forSale ? '<span class="mapStoreForSaleIcon" aria-hidden="true"><svg viewBox="0 0 24 24"><path d="M10.5 3H6a2 2 0 0 0-2 2v4.5a2 2 0 0 0 .59 1.41l8.5 8.5a2 2 0 0 0 2.82 0l3.5-3.5a2 2 0 0 0 0-2.82l-8.5-8.5A2 2 0 0 0 10.5 3ZM7.5 8A1.5 1.5 0 1 1 9 6.5 1.5 1.5 0 0 1 7.5 8Z"/></svg></span>' : '') +
          '<div class="mapStorePanel" role="note" aria-label="Mock store details">' +
            '<div class="mapStorePanelTitle">' + String(config.name || "Business") + '</div>' +
            parcelLine +
            '<div class="mapStorePanelWallet">Wallet: ' + String(config.wallet || "-") + '</div>' +
            askingLine +
            '<div class="mapStorePanelStatus">Status: ' + String(config.status || "-") + '</div>' +
          '</div>';
        return el;
      }

      /* ===== Land parcel purchase flow ===== */
      const walletValueEl = document.getElementById("walletValue");
      const landTaxValueEl = document.getElementById("landTaxTrigger");
      const LAND_TAX_KEY = "branchism_land_tax_yearly";
      const EXTRA_LAND_TAX_KEY = "branchism_extra_land_tax_yearly";
      const BASE_CAFE_LAND_TAX = 0.2345;
      const landBidModal = document.getElementById("landBidModal");
      const landBidTitle = document.getElementById("landBidTitle");
      const landBidSummary = document.getElementById("landBidSummary");
      const landSalesChart = document.getElementById("landSalesChart");
      const landBidList = document.getElementById("landBidList");
      const landBidWarnings = document.getElementById("landBidWarnings");
      const landBidOffer = document.getElementById("landBidOffer");
      const landBidCancel = document.getElementById("landBidCancel");
      const landBidSubmit = document.getElementById("landBidSubmit");
      const landBidBuyNow = document.getElementById("landBidBuyNow");

      function readStoredExtraLandTax(){
        try {
          const raw = Number(localStorage.getItem(EXTRA_LAND_TAX_KEY));
          if (Number.isFinite(raw) && raw >= 0) return raw;
          const legacyTotal = Number(localStorage.getItem(LAND_TAX_KEY));
          if (Number.isFinite(legacyTotal) && legacyTotal >= BASE_CAFE_LAND_TAX) {
            return legacyTotal - BASE_CAFE_LAND_TAX;
          }
        } catch (_) {}
        return 0;
      }

      const userState = {
        walletEth: 2.1621,
        landTaxEthPerYear: readStoredExtraLandTax()
      };

      const parcelStates = {
        "parcel-3": {
          id: "parcel-3",
          number: "3",
          name: "Empty Land Parcel",
          wallet: "0x9bc1...42aa",
          askingPriceEth: 1.95,
          minimumAcceptedOfferEth: 1.72,
          areaSqm: 4100,
          annualTaxEth: 0.1394,
          status: "Owner asks to sell",
          owned: false,
          forSale: true,
          salesHistory: [
            { label: "2023 Q3", price: 1.70 },
            { label: "2023 Q4", price: 1.74 },
            { label: "2024 Q1", price: 1.78 },
            { label: "2024 Q2", price: 1.82 },
            { label: "2024 Q3", price: 1.86 },
            { label: "2024 Q4", price: 1.90 }
          ],
          bids: [
            { address: "0x85ae...f1a2", amount: 1.73 },
            { address: "0x1bc4...29df", amount: 1.79 },
            { address: "0x74fd...c03e", amount: 1.88 }
          ]
        },
        "parcel-4": {
          id: "parcel-4",
          number: "4",
          name: "Empty Land Parcel",
          wallet: "0x6de3...18bc",
          askingPriceEth: 0,
          minimumAcceptedOfferEth: 1.84,
          areaSqm: 2800,
          annualTaxEth: 0.0951,
          status: "Unlisted parcel",
          owned: false,
          forSale: false,
          salesHistory: [
            { label: "2023 Q3", price: 1.48 },
            { label: "2023 Q4", price: 1.51 },
            { label: "2024 Q1", price: 1.54 },
            { label: "2024 Q2", price: 1.57 },
            { label: "2024 Q3", price: 1.60 },
            { label: "2024 Q4", price: 1.63 }
          ],
          bids: [
            { address: "0x4ad2...f09e", amount: 1.66 },
            { address: "0x77cf...18b2", amount: 1.73 }
          ]
        }
      };

      let activeLandParcelElement = null;
      let activeLandParcelId = "";

      function formatEthValue(value){
        return "\u039e" + (Number(value) || 0).toFixed(4);
      }

      function getTotalLandTaxDue(){
        return BASE_CAFE_LAND_TAX + userState.landTaxEthPerYear;
      }

      function renderLandSalesChart(parcelState){
        if (!landSalesChart) return;
        const history = Array.isArray(parcelState.salesHistory) ? parcelState.salesHistory : [];
        if (!history.length) {
          landSalesChart.innerHTML = "";
          return;
        }

        const w = 520;
        const h = 210;
        const m = { top: 12, right: 10, bottom: 34, left: 44 };
        const innerW = w - m.left - m.right;
        const innerH = h - m.top - m.bottom;
        const xStep = history.length > 1 ? innerW / (history.length - 1) : innerW;
        const minP = Math.min.apply(null, history.map((x) => x.price));
        const maxP = Math.max.apply(null, history.map((x) => x.price));
        const yMin = Math.max(0, minP * 0.9);
        const yMax = maxP * 1.1;
        const yRange = Math.max(0.001, yMax - yMin);
        const xToPx = (i) => m.left + i * xStep;
        const yToPx = (v) => m.top + innerH - ((v - yMin) / yRange) * innerH;

        const path = history.map((p, i) => (i ? "L" : "M") + xToPx(i).toFixed(2) + " " + yToPx(p.price).toFixed(2)).join(" ");
        const yTicks = 3;
        const grid = [];
        for (let i = 0; i <= yTicks; i += 1) {
          const val = yMin + (yRange * i) / yTicks;
          const y = yToPx(val);
          grid.push(
            '<line class="landChartGrid" x1="' + m.left + '" y1="' + y.toFixed(2) + '" x2="' + (w - m.right) + '" y2="' + y.toFixed(2) + '"></line>' +
            '<text class="landChartLabel" x="' + (m.left - 7) + '" y="' + (y + 3).toFixed(2) + '" text-anchor="end">\u039e' + val.toFixed(2) + "</text>"
          );
        }
        const xLabels = history.map((p, i) => {
          const x = xToPx(i);
          return '<text class="landChartLabel" x="' + x.toFixed(2) + '" y="' + (h - 10) + '" text-anchor="middle">' + p.label + "</text>";
        }).join("");
        const points = history.map((p, i) =>
          '<circle class="landChartPoint" cx="' + xToPx(i).toFixed(2) + '" cy="' + yToPx(p.price).toFixed(2) + '" r="3"></circle>'
        ).join("");

        landSalesChart.innerHTML =
          '<svg viewBox="0 0 ' + w + " " + h + '" role="img" aria-label="Past sales prices in ETH">' +
            grid.join("") +
            '<line class="landChartAxis" x1="' + m.left + '" y1="' + m.top + '" x2="' + m.left + '" y2="' + (h - m.bottom) + '"></line>' +
            '<line class="landChartAxis" x1="' + m.left + '" y1="' + (h - m.bottom) + '" x2="' + (w - m.right) + '" y2="' + (h - m.bottom) + '"></line>' +
            '<path class="landChartLine" d="' + path + '"></path>' +
            points +
            xLabels +
          "</svg>";
      }

      function renderWalletAndTax(){
        if (walletValueEl) walletValueEl.textContent = formatEthValue(userState.walletEth);
        if (landTaxValueEl) landTaxValueEl.textContent = formatEthValue(getTotalLandTaxDue());
        try {
          localStorage.setItem(EXTRA_LAND_TAX_KEY, String(userState.landTaxEthPerYear));
          localStorage.setItem(LAND_TAX_KEY, String(getTotalLandTaxDue()));
        } catch (_) {}
      }

      if (landTaxValueEl) {
        landTaxValueEl.addEventListener("click", () => {
          const residencyTax = 0;
          const businessTax = BASE_CAFE_LAND_TAX;
          const additionalLandTaxDue = userState.landTaxEthPerYear;
          alert(
            "Land Tax Breakdown\n\n" +
            "Primary residency: " + formatEthValue(residencyTax) + " / yr (zero due to size constraint)\n" +
            "Cafe Nakamoto business land tax: " + formatEthValue(businessTax) + " / yr (taken directly from profit)\n" +
            "Additional land tax due: " + formatEthValue(additionalLandTaxDue) + " / yr\n\n" +
            "Total annual land tax due: " + formatEthValue(residencyTax + businessTax + additionalLandTaxDue) + " / yr"
          );
        });
      }

      function setParcelOwnedVisual(element){
        if (!element) return;
        element.classList.remove("vacant");
        element.classList.add("owned");
        const saleIcon = element.querySelector(".mapStoreForSaleIcon");
        if (saleIcon) saleIcon.remove();
        let badge = element.querySelector(".mapStoreOwnerBadge");
        if (!badge) {
          badge = document.createElement("span");
          badge.className = "mapStoreOwnerBadge";
          badge.setAttribute("aria-hidden", "true");
          badge.innerHTML = '<svg viewBox="0 0 24 24"><path d="M12 2l2.7 5.5 6.1.9-4.4 4.3 1 6.1L12 16l-5.4 2.8 1-6.1-4.4-4.3 6.1-.9z"/></svg>';
          element.appendChild(badge);
        }
        const title = element.querySelector(".mapStorePanelTitle");
        const status = element.querySelector(".mapStorePanelStatus");
        const asking = element.querySelector(".mapStorePanelAsking");
        if (title) title.textContent = "Owned Land Parcel";
        if (status) status.textContent = "Status: Owned by you";
        if (asking) asking.remove();
      }

      function openLandBidModal(parcelId, parcelElement){
        if (!landBidModal || !landBidList || !landBidWarnings || !landBidSummary || !landBidTitle) return;
        const parcelState = parcelStates[parcelId];
        if (!parcelState || parcelState.owned) return;
        activeLandParcelId = parcelId;
        activeLandParcelElement = parcelElement || null;
        landBidModal.classList.add("open");
        landBidModal.setAttribute("aria-hidden", "false");
        if (landBidOffer) landBidOffer.value = "";
        landBidTitle.textContent = parcelState.name + " (Mock)";
        landBidSummary.textContent = parcelState.forSale
          ? "Open bids and direct purchase for parcel #" + parcelState.number + ". Asking price is " + formatEthValue(parcelState.askingPriceEth) + "."
          : "Parcel #" + parcelState.number + " is not listed for direct sale. You can still submit a bid to the owner.";
        renderLandSalesChart(parcelState);
        landBidList.innerHTML = (parcelState.bids || [])
          .map((row) => "<li>" + row.address + " \u2022 bid " + formatEthValue(row.amount) + "</li>")
          .join("");
        landBidWarnings.innerHTML =
          "Primary residency warning: you already own a primary residency. " +
          "To switch residency, you must forfeit your current one first.<br>" +
          "Estimated land tax by size (" + parcelState.areaSqm.toLocaleString() + " sqm): " +
          formatEthValue(parcelState.annualTaxEth) + " / year.<br>" +
          "If you wish to create a business, your current business must be terminated first.";
        landBidBuyNow.style.display = parcelState.forSale ? "" : "none";
        landBidBuyNow.textContent = "Buy Full Price (" + formatEthValue(parcelState.askingPriceEth) + ")";
      }

      function closeLandBidModal(){
        if (!landBidModal) return;
        landBidModal.classList.remove("open");
        landBidModal.setAttribute("aria-hidden", "true");
        activeLandParcelElement = null;
        activeLandParcelId = "";
      }

      function completeParcelPurchase(priceEth, parcelState){
        if (!parcelState) return;
        if (parcelState.owned) {
          landBidWarnings.textContent = "Parcel already owned.";
          return;
        }
        if (userState.walletEth < priceEth) {
          landBidWarnings.textContent =
            "Insufficient wallet funds. Required " + formatEthValue(priceEth) + ", available " + formatEthValue(userState.walletEth) + ".";
          return;
        }
        userState.walletEth -= priceEth;
        userState.landTaxEthPerYear += parcelState.annualTaxEth;
        parcelState.owned = true;
        parcelState.status = "Owned by you";
        renderWalletAndTax();
        if (activeLandParcelElement) setParcelOwnedVisual(activeLandParcelElement);
        closeLandBidModal();
      }

      function attachParcelInteraction(parcelElement, parcelId){
        if (!parcelElement) return;
        parcelElement.dataset.parcelId = parcelId;
        parcelElement.addEventListener("click", (event) => {
          event.preventDefault();
          event.stopPropagation();
          const parcelState = parcelStates[parcelId];
          if (!parcelState || parcelState.owned) return;
          openLandBidModal(parcelId, parcelElement);
        });
      }

      if (landBidModal) {
        landBidCancel.addEventListener("click", closeLandBidModal);
        landBidModal.addEventListener("click", (event) => {
          if (event.target === landBidModal) closeLandBidModal();
        });
        landBidSubmit.addEventListener("click", () => {
          const parcelState = parcelStates[activeLandParcelId];
          if (!parcelState) return;
          const offer = Number(landBidOffer ? landBidOffer.value : 0);
          if (!offer || offer <= 0) {
            landBidWarnings.textContent = "Enter a valid offer in ETH.";
            return;
          }
          if (!parcelState.forSale) {
            parcelState.bids.push({ address: "0x4f2a...9c1b", amount: offer });
            landBidWarnings.textContent = "Bid submitted to owner for review.";
            return;
          }
          if (offer < parcelState.minimumAcceptedOfferEth) {
            landBidWarnings.textContent =
              "Offer rejected. Lowest acceptable bid is " + formatEthValue(parcelState.minimumAcceptedOfferEth) + ".";
            return;
          }
          completeParcelPurchase(offer, parcelState);
        });
        landBidBuyNow.addEventListener("click", () => {
          const parcelState = parcelStates[activeLandParcelId];
          if (!parcelState || !parcelState.forSale) return;
          completeParcelPurchase(parcelState.askingPriceEth, parcelState);
        });
      }

      renderWalletAndTax();

      function addLeafletCenterRedSquare(map){
        const p1 = getParcelConfig("1");
        const marker1LngLat = getParcelLngLatForLeaflet(map, p1);
        const el1 = createBusinessMarkerElement({
          number: p1.number,
          name: p1.name,
          wallet: p1.wallet,
          royalty: p1.royalty,
          status: p1.status,
          owned: Boolean(p1.owned),
          statusIcon: p1.statusIcon,
          width: Number(p1.width) || 20,
          height: Number(p1.height) || 20
        });
        const icon1 = L.divIcon({
          className: "",
          html: el1.outerHTML,
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        });
        L.marker([marker1LngLat[1], marker1LngLat[0]], { icon: icon1, interactive: true }).addTo(map);
        const p5 = getParcelConfig("5");
        const marker5LngLat = getParcelLngLatForLeaflet(map, p5);
        const el5 = createBusinessMarkerElement({
          number: p5.number,
          name: p5.name,
          wallet: p5.wallet,
          royalty: p5.royalty,
          status: p5.status,
          statusIcon: p5.statusIcon,
          offsetX: 0,
          offsetY: 0,
          width: Number(p5.width) || 20,
          height: Number(p5.height) || 20
        });
        const icon5 = L.divIcon({
          className: "",
          html: el5.outerHTML,
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        });
        L.marker([marker5LngLat[1], marker5LngLat[0]], { icon: icon5, interactive: true }).addTo(map);
        const p6 = getParcelConfig("6");
        const marker6LngLat = getParcelLngLatForLeaflet(map, p6);
        const el6 = createBusinessMarkerElement({
          number: p6.number,
          name: p6.name,
          wallet: p6.wallet,
          royalty: p6.royalty,
          status: p6.status,
          statusIcon: p6.statusIcon,
          offsetX: 0,
          offsetY: 0,
          width: Number(p6.width) || 20,
          height: Number(p6.height) || 20
        });
        const icon6 = L.divIcon({
          className: "",
          html: el6.outerHTML,
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        });
        L.marker([marker6LngLat[1], marker6LngLat[0]], { icon: icon6, interactive: true }).addTo(map);
        addExtraBusinessParcelsLeaflet(map);
        const p2 = getParcelConfig("2");
        const marker2LngLat = getParcelLngLatForLeaflet(map, p2);
        const el2 = createBusinessMarkerElement({
          number: p2.number,
          name: p2.name,
          wallet: p2.wallet,
          royalty: p2.royalty,
          status: p2.status,
          statusIcon: p2.statusIcon,
          offsetX: 0,
          offsetY: 0,
          width: Number(p2.width) || 120,
          height: Number(p2.height) || 144
        });
        const icon2 = L.divIcon({
          className: "",
          html: el2.outerHTML,
          iconSize: [120, 144],
          iconAnchor: [60, 72]
        });
        L.marker([marker2LngLat[1], marker2LngLat[0]], { icon: icon2, interactive: true }).addTo(map);

        const p3 = getParcelConfig("3");
        const marker3LngLat = getParcelLngLatForLeaflet(map, p3);
        const el3 = createBusinessMarkerElement({
          number: p3.number,
          name: p3.name,
          wallet: p3.wallet,
          royalty: p3.royalty,
          askingPrice: p3.askingPrice,
          status: p3.status,
          vacant: Boolean(p3.vacant),
          forSale: Boolean(p3.forSale),
          offsetX: 0,
          offsetY: 0,
          width: Number(p3.width) || 92.2,
          height: Number(p3.height) || 92.2
        });
        const icon3 = L.divIcon({
          className: "",
          html: el3.outerHTML,
          iconSize: [92.2, 92.2],
          iconAnchor: [46.1, 46.1]
        });
        const marker3 = L.marker([marker3LngLat[1], marker3LngLat[0]], { icon: icon3, interactive: true }).addTo(map);
        marker3.on("click", () => {
          const root = marker3.getElement() ? marker3.getElement().querySelector(".mapStoreMarker") : null;
          if (root && root.classList.contains("vacant")) openLandBidModal("parcel-3", root);
        });

        const p4 = getParcelConfig("4");
        const marker4LngLat = getParcelLngLatForLeaflet(map, p4);
        const el4 = createBusinessMarkerElement({
          number: p4.number,
          name: p4.name,
          wallet: p4.wallet,
          royalty: p4.royalty,
          status: p4.status,
          vacant: Boolean(p4.vacant),
          statusIcon: p4.statusIcon,
          offsetX: 0,
          offsetY: 0,
          width: Number(p4.width) || 92.22,
          height: Number(p4.height) || 82.72
        });
        const icon4 = L.divIcon({
          className: "",
          html: el4.outerHTML,
          iconSize: [92.22, 82.72],
          iconAnchor: [46.11, 41.36]
        });
        const marker4 = L.marker([marker4LngLat[1], marker4LngLat[0]], { icon: icon4, interactive: true }).addTo(map);
        marker4.on("click", () => {
          const root = marker4.getElement() ? marker4.getElement().querySelector(".mapStoreMarker") : null;
          if (root && root.classList.contains("vacant")) openLandBidModal("parcel-4", root);
        });
      }

      function addUnitScaleLeaflet(map){
        const latRef = ISLAND_CENTER[1];
        const centerM = lngLatToMeters(ISLAND_CENTER[0], ISLAND_CENTER[1], latRef);
        const p1 = metersToLngLat(centerM.x, centerM.y, latRef);
        const p2 = metersToLngLat(centerM.x + 190, centerM.y, latRef); // 100 units = 190m
        const a = map.latLngToContainerPoint([p1[1], p1[0]]);
        const b = map.latLngToContainerPoint([p2[1], p2[0]]);
        const widthPx = Math.max(24, Math.round(Math.abs(b.x - a.x)));
        const tick30Px = Math.max(1, Math.round(widthPx * 0.3));

        const el = document.createElement("div");
        el.className = "mapUnitScale";
        el.innerHTML =
          '<div>100 units</div>' +
          '<div class="mapUnitScaleBar" style="width:' + widthPx + 'px">' +
            '<span class="mapUnitTick" style="left:' + tick30Px + 'px"></span>' +
            '<span class="mapUnitTickLabel" style="left:' + tick30Px + 'px">30</span>' +
          '</div>' +
          '<div class="mapUnitScaleSub">1 unit = 1.9m</div>';
        map.getContainer().appendChild(el);
      }

      function addUnitScaleMapLibre(map){
        const latRef = ISLAND_CENTER[1];
        const centerM = lngLatToMeters(ISLAND_CENTER[0], ISLAND_CENTER[1], latRef);
        const p1 = metersToLngLat(centerM.x, centerM.y, latRef);
        const p2 = metersToLngLat(centerM.x + 190, centerM.y, latRef); // 100 units = 190m
        const a = map.project([p1[0], p1[1]]);
        const b = map.project([p2[0], p2[1]]);
        const widthPx = Math.max(24, Math.round(Math.abs(b.x - a.x)));
        const tick30Px = Math.max(1, Math.round(widthPx * 0.3));

        const el = document.createElement("div");
        el.className = "mapUnitScale";
        el.innerHTML =
          '<div>100 units</div>' +
          '<div class="mapUnitScaleBar" style="width:' + widthPx + 'px">' +
            '<span class="mapUnitTick" style="left:' + tick30Px + 'px"></span>' +
            '<span class="mapUnitTickLabel" style="left:' + tick30Px + 'px">30</span>' +
          '</div>' +
          '<div class="mapUnitScaleSub">1 unit = 1.9m</div>';
        map.getContainer().appendChild(el);
      }

      function applyMapModeUI(){
        document.body.classList.toggle("mapModeProduction", !MAP_DEVELOPER_MODE);
        document.body.classList.toggle("mapModeDeveloper", MAP_DEVELOPER_MODE);
        const toolIds = [
          "toggleParcelEdit",
          "parcelTypeSelect",
          "addParcelBtn",
          "saveParcelLayout",
          "resetParcelLayout",
          "showOffsetBtn",
          "exportParcelLayout"
        ];
        toolIds.forEach((id) => {
          const el = document.getElementById(id);
          if (!el) return;
          el.style.display = MAP_DEVELOPER_MODE ? "" : "none";
        });
        const guideOverlay = document.getElementById("parcelGuideOverlay");
        const editOverlay = document.getElementById("parcelEditOverlay");
        const coordPanel = document.getElementById("parcelCoordPanel");
        if (guideOverlay) guideOverlay.style.display = MAP_DEVELOPER_MODE ? "block" : "none";
        if (editOverlay) editOverlay.style.display = MAP_DEVELOPER_MODE ? "" : "none";
        if (coordPanel) coordPanel.style.display = MAP_DEVELOPER_MODE ? "block" : "none";
      }

      function initParcelEditorUI(map, engine){
        const guideOverlay = document.getElementById("parcelGuideOverlay");
        const overlay = document.getElementById("parcelEditOverlay");
        const coordPanel = document.getElementById("parcelCoordPanel");
        const toggleBtn = document.getElementById("toggleParcelEdit");
        const parcelTypeSelect = document.getElementById("parcelTypeSelect");
        const addBtn = document.getElementById("addParcelBtn");
        const saveBtn = document.getElementById("saveParcelLayout");
        const resetBtn = document.getElementById("resetParcelLayout");
        const showBtn = document.getElementById("showOffsetBtn");
        const exportBtn = document.getElementById("exportParcelLayout");
        if (!guideOverlay || !overlay || !coordPanel || !toggleBtn || !parcelTypeSelect || !addBtn || !saveBtn || !resetBtn || !showBtn || !exportBtn || !map) return;

        const state = {
          enabled: false,
          dragging: null
        };

        function migrateLegacyScreenLayoutIfNeeded(){
          // Disabled: legacy migration introduced vertical drift for newly added parcels.
          try { localStorage.setItem(PARCEL_LAYOUT_MIGRATED_KEY, "1"); } catch (_) {}
        }

        function syncAddedParcelsFromLayout(){
          let changed = false;
          ADDED_PARCELS = ADDED_PARCELS.map((parcel) => {
            const n = String(parcel.number);
            const entry = PARCEL_LAYOUT[n];
            if (!entry || !Number.isFinite(Number(entry.cx)) || !Number.isFinite(Number(entry.cy))) return parcel;
            const px = referencePxToCurrentPx(Number(entry.cx), Number(entry.cy), map);
            const ll = engine === "maplibre"
              ? map.unproject([px.x, px.y])
              : map.containerPointToLatLng([px.x, px.y]);
            const lng = Number(ll.lng);
            const lat = Number(ll.lat);
            if (Number(parcel.lng) === lng && Number(parcel.lat) === lat) return parcel;
            changed = true;
            return Object.assign({}, parcel, { lng: lng, lat: lat });
          });
          if (changed) writeAddedParcels(ADDED_PARCELS);
        }

        function applySaveYOffsetToNewParcels(){
          // Intentionally no-op: forced Y offsets caused drift.
        }

        function getMapCenterLngLat(){
          if (engine === "maplibre") {
            const center = map.getCenter();
            return [Number(center.lng), Number(center.lat)];
          }
          const center = map.getCenter();
          return [Number(center.lng), Number(center.lat)];
        }

        function containerClientToReference(clientX, clientY){
          const c = map.getContainer();
          const rect = c.getBoundingClientRect();
          const point = [clientX - rect.left, clientY - rect.top];
          return currentPxToReferencePx(point[0], point[1], map);
        }

        function seedLayoutForAllParcels(){
          let changed = false;
          getAllParcels().forEach((parcel) => {
            const n = String(parcel.number);
            const existing = PARCEL_LAYOUT[n];
            const hasPx = existing && Number.isFinite(Number(existing.cx)) && Number.isFinite(Number(existing.cy));
            const hasGeo = existing && Number.isFinite(Number(existing.lng)) && Number.isFinite(Number(existing.lat));
            if (hasPx && hasGeo) return;
            const refPt = getParcelReferencePoint(parcel, map, engine);
            const geo = getParcelLngLatFromScreen(parcel, map, engine);
            PARCEL_LAYOUT[n] = {
              cx: refPt.cx,
              cy: refPt.cy,
              lng: Number(geo[0]),
              lat: Number(geo[1])
            };
            changed = true;
          });
          if (changed) writeParcelLayout(PARCEL_LAYOUT);
        }

        function renderCoordinatePanel(){
          const addedSet = new Set(ADDED_PARCELS.map((p) => String(p.number)));
          const rows = getAllParcels()
            .slice()
            .sort((a, b) => (Number(a.number) || 0) - (Number(b.number) || 0))
            .map((parcel) => {
              const refPt = getParcelReferencePoint(parcel, map, engine);
              const shownY = addedSet.has(String(parcel.number))
                ? (Number(refPt.cy) + ADDED_PARCEL_Y_SAVE_OFFSET)
                : Number(refPt.cy);
              return '<div class="parcelCoordRow"><span>#' + String(parcel.number) + '</span><span>(' + Math.round(refPt.cx) + ', ' + Math.round(shownY) + ')</span></div>';
            })
            .join("");
          coordPanel.innerHTML = "<strong>Parcel Centers (px from top-left)</strong>" + rows;
        }

        function getVisualParcelCenter(parcel){
          const container = map.getContainer();
          const marker = container.querySelector('.mapStoreMarker[data-parcel-number="' + String(parcel.number) + '"]');
          if (!marker) return getParcelCurrentPoint(parcel, map, engine);
          const cRect = container.getBoundingClientRect();
          const anchor = marker.querySelector(".mapStoreDiamond") || marker;
          const mRect = anchor.getBoundingClientRect();
          return {
            x: (mRect.left - cRect.left) + (mRect.width / 2),
            y: (mRect.top - cRect.top) + (mRect.height / 2)
          };
        }

        function captureAddedParcelCentersToLayout(){
          ADDED_PARCELS.forEach((parcel) => {
            const n = String(parcel.number);
            const v = getVisualParcelCenter(parcel);
            const adjustedY = v.y - ADDED_PARCEL_Y_SAVE_OFFSET;
            const ref = currentPxToReferencePx(v.x, adjustedY, map);
            const ll = getParcelLngLatFromCurrentPx(v.x, adjustedY);
            PARCEL_LAYOUT[n] = {
              cx: ref.cx,
              cy: ref.cy,
              lng: Number(ll[0]),
              lat: Number(ll[1])
            };
          });
        }

        function getParcelLngLatFromCurrentPx(x, y){
          if (engine === "maplibre") {
            const ll = map.unproject([x, y]);
            return [Number(ll.lng), Number(ll.lat)];
          }
          const ll = map.containerPointToLatLng([x, y]);
          return [Number(ll.lng), Number(ll.lat)];
        }

        function storeCalibrationReport(report){
          try {
            localStorage.setItem(PARCEL_OFFSET_REPORT_KEY, JSON.stringify(report));
            window.__branchismLastOffsetReport = report;
          } catch (_) {}
        }

        function exportParcelSnapshot(){
          const productionNumbers = new Set(
            (PRODUCTION_PARCEL_SNAPSHOT.parcels || [])
              .filter((p) => p && p.number != null)
              .map((p) => String(p.number))
          );
          const exportParcels = ADDED_PARCELS.filter((parcel) => !productionNumbers.has(String(parcel.number)));
          const payload = {
            generatedAt: new Date().toISOString(),
            mode: MAP_DEVELOPER_MODE ? "developer" : "production",
            referenceSize: PARCEL_REF,
            parcels: exportParcels.map((parcel) => {
              const n = String(parcel.number);
              const ref = getParcelReferencePoint(parcel, map, engine);
              const ll = getParcelLngLatFromScreen(parcel, map, engine);
              return Object.assign({}, parcel, {
                number: n,
                cx: Number(ref.cx),
                cy: Number(ref.cy),
                lng: Number(ll[0]),
                lat: Number(ll[1])
              });
            })
          };
          const text = JSON.stringify(payload, null, 2);
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).catch(() => {});
          } else {
            try {
              const ta = document.createElement("textarea");
              ta.value = text;
              document.body.appendChild(ta);
              ta.focus();
              ta.select();
              document.execCommand("copy");
              ta.remove();
            } catch (_) {}
          }
        }

        function getParcelClass(parcel){
          if (parcel.owned) return "parcelHandle owned";
          if (parcel.vacant) return "parcelHandle vacant";
          return "parcelHandle";
        }

        function render(){
          guideOverlay.innerHTML = "";
          overlay.innerHTML = "";
          const addedSet = new Set(ADDED_PARCELS.map((p) => String(p.number)));
          getAllParcels().forEach((parcel) => {
            const pt = getVisualParcelCenter(parcel);
            const refPt = getParcelReferencePoint(parcel, map, engine);
            const shownY = addedSet.has(String(parcel.number))
              ? (Number(refPt.cy) + ADDED_PARCEL_Y_SAVE_OFFSET)
              : Number(refPt.cy);

            const hGuide = document.createElement("div");
            hGuide.className = "parcelGuideLine h";
            hGuide.style.left = "0px";
            hGuide.style.top = String(pt.y) + "px";
            hGuide.style.width = String(Math.max(0, pt.x)) + "px";
            guideOverlay.appendChild(hGuide);

            const vGuide = document.createElement("div");
            vGuide.className = "parcelGuideLine v";
            vGuide.style.left = String(pt.x) + "px";
            vGuide.style.top = "0px";
            vGuide.style.height = String(Math.max(0, pt.y)) + "px";
            guideOverlay.appendChild(vGuide);

            const xLabel = document.createElement("div");
            xLabel.className = "parcelGuideLabel";
            xLabel.style.left = String(Math.max(18, pt.x * 0.5)) + "px";
            xLabel.style.top = String(Math.max(10, pt.y - 12)) + "px";
            xLabel.textContent = "x " + String(Math.round(refPt.cx));
            guideOverlay.appendChild(xLabel);

            const yLabel = document.createElement("div");
            yLabel.className = "parcelGuideLabel";
            yLabel.style.left = String(Math.max(24, pt.x + 18)) + "px";
            yLabel.style.top = String(Math.max(10, pt.y * 0.5)) + "px";
            yLabel.textContent = "y " + String(Math.round(shownY));
            guideOverlay.appendChild(yLabel);

            const el = document.createElement("button");
            el.type = "button";
            el.className = getParcelClass(parcel);
            el.style.left = String(pt.x) + "px";
            el.style.top = String(pt.y) + "px";
            el.textContent = String(parcel.number);
            el.dataset.parcel = String(parcel.number);
            el.title = String(parcel.name || ("Parcel " + String(parcel.number)));
            el.addEventListener("pointerdown", (event) => {
              if (!state.enabled) return;
              event.preventDefault();
              state.dragging = {
                number: String(parcel.number)
              };
              el.setPointerCapture(event.pointerId);
            });
            overlay.appendChild(el);
          });
          renderCoordinatePanel();
        }

        function pointerMove(event){
          if (!state.enabled || !state.dragging) return;
          const ref = containerClientToReference(event.clientX, event.clientY);
          const c = map.getContainer();
          const rect = c.getBoundingClientRect();
          const point = [event.clientX - rect.left, event.clientY - rect.top];
          const ll = engine === "maplibre"
            ? map.unproject(point)
            : map.containerPointToLatLng(point);
          PARCEL_LAYOUT[state.dragging.number] = {
            cx: ref.cx,
            cy: ref.cy,
            lng: Number(ll.lng),
            lat: Number(ll.lat)
          };
          syncAddedParcelsFromLayout();
          render();
        }

        function pointerUp(){
          if (state.dragging) writeParcelLayout(PARCEL_LAYOUT);
          state.dragging = null;
        }

        window.addEventListener("pointermove", pointerMove);
        window.addEventListener("pointerup", pointerUp);

        toggleBtn.addEventListener("click", () => {
          state.enabled = !state.enabled;
          overlay.classList.toggle("active", state.enabled);
          toggleBtn.classList.toggle("active", state.enabled);
          toggleBtn.textContent = state.enabled ? "Editing" : "Edit Parcels";
          render();
        });

        addBtn.addEventListener("click", () => {
          const all = getAllParcels();
          let maxN = 0;
          all.forEach((p) => { maxN = Math.max(maxN, Number(p.number) || 0); });
          const n = String(maxN + 1);
          const center = getMapCenterLngLat();
          const parcelType = String(parcelTypeSelect.value || "reserved");
          const newParcel = {
            number: n,
            name: parcelType === "reserved" ? "Reserved Land Parcel" : "Parcel " + n,
            wallet: "0x4f2a...9c1b",
            royalty: parcelType === "business" ? "0.8%" : "-",
            lng: center[0],
            lat: center[1],
            status: "Pending Review",
            statusIcon: "company",
            width: 20,
            height: 20
          };
          if (parcelType === "empty") {
            newParcel.name = "Empty Land Parcel";
            newParcel.status = "Unlisted parcel";
            newParcel.vacant = true;
            newParcel.width = 92.2;
            newParcel.height = 92.2;
          } else if (parcelType === "forsale") {
            newParcel.name = "Empty Land Parcel";
            newParcel.status = "Owner asks to sell";
            newParcel.vacant = true;
            newParcel.forSale = true;
            newParcel.askingPrice = "1.9500";
            newParcel.width = 92.2;
            newParcel.height = 92.2;
          } else if (parcelType === "reserved") {
            // Default reserved plot: same orientation as business, 3x width and 2x height.
            newParcel.status = "Reserved land (cannot be bought or sold)";
            newParcel.reserved = true;
            newParcel.statusIcon = "nature";
            newParcel.noIdleFloat = true;
            newParcel.width = 60;
            newParcel.height = 40;
          }
          ADDED_PARCELS = ADDED_PARCELS.concat([newParcel]);
          writeAddedParcels(ADDED_PARCELS);
          const currentCenterPx = engine === "maplibre"
            ? map.project(center)
            : map.latLngToContainerPoint([center[1], center[0]]);
          const centerRef = currentPxToReferencePx(Number(currentCenterPx.x), Number(currentCenterPx.y), map);
          PARCEL_LAYOUT[n] = {
            cx: centerRef.cx,
            cy: centerRef.cy,
            lng: Number(center[0]),
            lat: Number(center[1])
          };
          ADDED_PARCELS = ADDED_PARCELS.map((parcel) => (
            String(parcel.number) === n
              ? Object.assign({}, parcel, { lng: Number(center[0]), lat: Number(center[1]), ySaveOffsetApplied: true })
              : parcel
          ));
          writeAddedParcels(ADDED_PARCELS);
          writeParcelLayout(PARCEL_LAYOUT);
          state.enabled = true;
          overlay.classList.add("active");
          toggleBtn.classList.add("active");
          toggleBtn.textContent = "Editing";
          render();
        });

        saveBtn.addEventListener("click", () => {
          captureAddedParcelCentersToLayout();
          applySaveYOffsetToNewParcels();
          syncAddedParcelsFromLayout();
          writeParcelLayout(PARCEL_LAYOUT);
          writeAddedParcels(ADDED_PARCELS);
          saveBtn.textContent = "Saved";
          window.setTimeout(() => { saveBtn.textContent = "Save Layout"; }, 900);
          window.location.reload();
        });

        resetBtn.addEventListener("click", () => {
          PARCEL_LAYOUT = {};
          writeParcelLayout({});
          PARCEL_REF = null;
          writeParcelReferenceSize({ w: 0, h: 0 });
          try { localStorage.removeItem(PARCEL_REF_KEY); } catch (_) {}
          ADDED_PARCELS = [];
          writeAddedParcels([]);
          render();
          window.location.reload();
        });

        showBtn.addEventListener("click", () => {
          const p1 = getParcelConfig("1");
          const p13 = getParcelConfig("13");
          if (!p1 || !p13) {
            showBtn.textContent = "Need #1 + #13";
            window.setTimeout(() => { showBtn.textContent = "Show"; }, 1200);
            return;
          }

          const oneVisual = getVisualParcelCenter(p1);
          const thirteenVisual = getVisualParcelCenter(p13);
          const oneRealRef = currentPxToReferencePx(oneVisual.x, oneVisual.y, map);
          const thirteenRealRef = currentPxToReferencePx(thirteenVisual.x, thirteenVisual.y, map);
          const oneSavedRef = getParcelReferencePoint(p1, map, engine);
          const thirteenSavedRef = getParcelReferencePoint(p13, map, engine);

          // Target is the measured real spacing on screen; if #13 is placed on #1 this is near zero.
          const targetDx = thirteenRealRef.cx - oneRealRef.cx;
          const targetDy = thirteenRealRef.cy - oneRealRef.cy;
          const savedDx = thirteenSavedRef.cx - oneSavedRef.cx;
          const savedDy = thirteenSavedRef.cy - oneSavedRef.cy;
          const corrX = savedDx - targetDx;
          const corrY = savedDy - targetDy;

          const beforeAfter = [];
          getAllParcels().forEach((parcel) => {
            const n = String(parcel.number);
            if (n === "1") return;
            const oldRef = getParcelReferencePoint(parcel, map, engine);
            const newRef = { cx: oldRef.cx - corrX, cy: oldRef.cy - corrY };
            const currentPx = referencePxToCurrentPx(newRef.cx, newRef.cy, map);
            const ll = getParcelLngLatFromCurrentPx(currentPx.x, currentPx.y);
            PARCEL_LAYOUT[n] = { cx: newRef.cx, cy: newRef.cy, lng: ll[0], lat: ll[1] };
            beforeAfter.push({
              parcel: n,
              oldCx: oldRef.cx,
              oldCy: oldRef.cy,
              newCx: newRef.cx,
              newCy: newRef.cy
            });
          });
          writeParcelLayout(PARCEL_LAYOUT);
          render();

          storeCalibrationReport({
            timestamp: new Date().toISOString(),
            referenceSize: PARCEL_REF,
            real: { one: oneRealRef, thirteen: thirteenRealRef, targetDx: targetDx, targetDy: targetDy },
            saved: { one: oneSavedRef, thirteen: thirteenSavedRef, savedDx: savedDx, savedDy: savedDy },
            correctionApplied: { corrX: corrX, corrY: corrY },
            updatedParcels: beforeAfter
          });

          showBtn.textContent = "Applied";
          window.setTimeout(() => { showBtn.textContent = "Show"; }, 1200);
        });

        exportBtn.addEventListener("click", () => {
          exportParcelSnapshot();
          exportBtn.textContent = "Copied";
          window.setTimeout(() => { exportBtn.textContent = "Copy JSON"; }, 900);
        });

        if (engine === "maplibre") {
          map.on("resize", render);
          map.on("move", render);
        } else {
          map.on("zoom", render);
          map.on("move", render);
          map.on("resize", render);
        }
        window.addEventListener("resize", render);
        migrateLegacyScreenLayoutIfNeeded();
        ensureParcelReferenceSize(map);
        syncAddedParcelsFromLayout();
        render();
        seedLayoutForAllParcels();
        syncAddedParcelsFromLayout();
        render();
      }

      function initLeafletFallback(){
        const bounds = L.latLngBounds(
          L.latLng(ISLAND_BOUNDS.south, ISLAND_BOUNDS.west),
          L.latLng(ISLAND_BOUNDS.north, ISLAND_BOUNDS.east)
        );
        const map = L.map("map", {
          zoomControl: false,
          attributionControl: true,
          scrollWheelZoom: false,
          doubleClickZoom: false,
          touchZoom: false,
          boxZoom: false,
          keyboard: false,
          dragging: false,
          maxBounds: bounds,
          maxBoundsViscosity: 1.0
        }).setView([ISLAND_CENTER[1], ISLAND_CENTER[0]], 16);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 20,
          attribution: "&copy; OpenStreetMap contributors"
        }).addTo(map);
        map.setMaxBounds(bounds);
        addLeafletCenterRedSquare(map);
        addUnitScaleLeaflet(map);
        if (MAP_DEVELOPER_MODE) initParcelEditorUI(map, "leaflet");
      }

      async function initVectorMap(){
        if (!window.maplibregl) return false;

        try {
          const styleUrl = "https://tiles.openfreemap.org/styles/liberty";
          const response = await fetch(styleUrl, { mode: "cors" });
          if (!response.ok) return false;
          const style = await response.json();
          hideUrbanLayers(style);

          const map = new maplibregl.Map({
            container: "map",
            style: style,
            center: ISLAND_CENTER,
            zoom: 16,
            maxBounds: [
              [ISLAND_BOUNDS.west, ISLAND_BOUNDS.south],
              [ISLAND_BOUNDS.east, ISLAND_BOUNDS.north]
            ],
            minZoom: 16,
            maxZoom: 16,
            scrollZoom: false,
            dragPan: false,
            boxZoom: false,
            doubleClickZoom: false,
            keyboard: false,
            dragRotate: false,
            touchPitch: false,
            pitchWithRotate: false,
            maxPitch: 0,
            attributionControl: true
          });

          map.on("load", () => {
            map.touchZoomRotate.disableRotation();
            const p1 = getParcelConfig("1");
            const marker1LngLat = getParcelLngLatForMapLibre(map, p1);
            const squareEl = createBusinessMarkerElement({
              number: p1.number,
              name: p1.name,
              wallet: p1.wallet,
              royalty: p1.royalty,
              status: p1.status,
              owned: Boolean(p1.owned),
              statusIcon: p1.statusIcon,
              width: Number(p1.width) || 20,
              height: Number(p1.height) || 20
            });
            new maplibregl.Marker({ element: squareEl, anchor: "center" }).setLngLat(marker1LngLat).addTo(map);
            const p5 = getParcelConfig("5");
            const marker5LngLat = getParcelLngLatForMapLibre(map, p5);
            const squareEl5 = createBusinessMarkerElement({
              number: p5.number,
              name: p5.name,
              wallet: p5.wallet,
              royalty: p5.royalty,
              status: p5.status,
              statusIcon: p5.statusIcon,
              offsetX: 0,
              offsetY: 0,
              width: Number(p5.width) || 20,
              height: Number(p5.height) || 20
            });
            new maplibregl.Marker({ element: squareEl5, anchor: "center" }).setLngLat(marker5LngLat).addTo(map);
            const p6 = getParcelConfig("6");
            const marker6LngLat = getParcelLngLatForMapLibre(map, p6);
            const squareEl6 = createBusinessMarkerElement({
              number: p6.number,
              name: p6.name,
              wallet: p6.wallet,
              royalty: p6.royalty,
              status: p6.status,
              statusIcon: p6.statusIcon,
              offsetX: 0,
              offsetY: 0,
              width: Number(p6.width) || 20,
              height: Number(p6.height) || 20
            });
            new maplibregl.Marker({ element: squareEl6, anchor: "center" }).setLngLat(marker6LngLat).addTo(map);
            addExtraBusinessParcelsMapLibre(map);
            const p2 = getParcelConfig("2");
            const marker2LngLat = getParcelLngLatForMapLibre(map, p2);
            const squareEl2 = createBusinessMarkerElement({
              number: p2.number,
              name: p2.name,
              wallet: p2.wallet,
              royalty: p2.royalty,
              status: p2.status,
              statusIcon: p2.statusIcon,
              offsetX: 0,
              offsetY: 0,
              width: Number(p2.width) || 120,
              height: Number(p2.height) || 144
            });
            new maplibregl.Marker({ element: squareEl2, anchor: "center" }).setLngLat(marker2LngLat).addTo(map);

            const p3 = getParcelConfig("3");
            const marker3LngLat = getParcelLngLatForMapLibre(map, p3);
            const squareEl3 = createBusinessMarkerElement({
              number: p3.number,
              name: p3.name,
              wallet: p3.wallet,
              royalty: p3.royalty,
              askingPrice: p3.askingPrice,
              status: p3.status,
              vacant: Boolean(p3.vacant),
              forSale: Boolean(p3.forSale),
              offsetX: 0,
              offsetY: 0,
              width: Number(p3.width) || 92.2,
              height: Number(p3.height) || 92.2
            });
            attachParcelInteraction(squareEl3, "parcel-3");
            new maplibregl.Marker({ element: squareEl3, anchor: "center" }).setLngLat(marker3LngLat).addTo(map);

            const p4 = getParcelConfig("4");
            const marker4LngLat = getParcelLngLatForMapLibre(map, p4);
            const squareEl4 = createBusinessMarkerElement({
              number: p4.number,
              name: p4.name,
              wallet: p4.wallet,
              royalty: p4.royalty,
              status: p4.status,
              vacant: Boolean(p4.vacant),
              statusIcon: p4.statusIcon,
              offsetX: 0,
              offsetY: 0,
              width: Number(p4.width) || 92.22,
              height: Number(p4.height) || 82.72
            });
            attachParcelInteraction(squareEl4, "parcel-4");
            new maplibregl.Marker({ element: squareEl4, anchor: "center" }).setLngLat(marker4LngLat).addTo(map);
            addUnitScaleMapLibre(map);
            if (MAP_DEVELOPER_MODE) initParcelEditorUI(map, "maplibre");
          });
          return true;
        } catch (_) {
          return false;
        }
      }

      applyMapModeUI();
      initVectorMap().then((ok) => {
        if (!ok) initLeafletFallback();
      });

    })();
  </script>
</body>
</html>
